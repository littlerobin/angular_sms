angular.module("callburnApp").controller("OverviewController",["$scope","$rootScope","$state","$filter","Restangular","$stateParams","getSnippets","SnippetService","CallBournModal","growl","$q","$interval","$timeout",function($scope,$rootScope,$state,$filter,Restangular,$stateParams,getSnippets,SnippetService,CallBournModal,growl,$q,$interval,$timeout){$rootScope.currentActiveRoute="snippet",$scope.exportStatistics=SnippetService.exportStatistics,$scope.currentOrder="ASC",$scope.statusClass="ASC",$scope.orderField=null,$scope.tableSpinnerLoading=!0,$rootScope.showTutorial=!!$stateParams.showTutorial,$scope.arrowHelper=!0,$scope.removeTooltip=!1,$scope.hideArrowHelper=function(){$scope.arrowHelper=!1};var applyTranslations=function(){$scope.isLoaded=!1,setTimeout(function(){$scope.isLoaded=!0},100),$scope.dates=[{value:1,text:$rootScope.trans("campaign_overview_last_day")},{value:7,text:$rootScope.trans("campaign_overview_last_week")},{value:30,text:$rootScope.trans("campaign_overview_last_month")},{value:90,text:$rootScope.trans("campaign_overview_last_90_days")}],$scope.multiselectOptionsSnippetOverviewData=[{id:"ACTIVE",label:$rootScope.trans("call_chackbox_active")},{id:"DELETED",label:$rootScope.trans("call_chackbox_deleted")},{id:"DRAFT",label:$rootScope.trans("call_chackbox_draft")},{id:"IN_PAUSE",label:$rootScope.trans("call_chackbox_in_pause")},{id:"DEACTIVATED",label:$rootScope.trans("call_chackbox_deactivated")}],$scope.multiselectSnippetOverviewTranslationTexts={dynamicButtonTextSuffix:$rootScope.trans("multi_checked"),checkAll:$rootScope.trans("multi_check_all"),uncheckAll:$rootScope.trans("multi_uncheck_all"),selectionCount:$rootScope.trans("multi_checked"),buttonDefaultText:$rootScope.trans("multiselect_statistics_status")}};$rootScope.$watch("currentLanguage",applyTranslations),$rootScope.$watch("isLangLoaded",applyTranslations),$scope.orderData={},$scope.filterData={},$scope.page=1,$scope.snippets=getSnippets.resource.snippets,$scope.totalCount=getSnippets.resource.total_count,$scope.count=getSnippets.resource.count,$scope.total=getSnippets.resource.total_count,$scope.hasAnySnippet=getSnippets.resource.hasAnySnippet,$scope.pagesCount=Math.ceil(getSnippets.resource.total_count/30);var checkPublishedSnippets=function(){var count=0;return $scope.snippets.forEach(function(item){1===item.is_published&&count++}),count};$scope.currentPage=void 0,$scope.changePage=function(page){if($scope.tableSpinnerLoading=!0,!(page<0||page>$scope.pagesCount)){$scope.currentPage=page;var postData={};postData.page=page,$scope.filterData.page=page,SnippetService.getSnippets($scope.filterData).then(function(data){$scope.snippets=data.resource.snippets,$scope.tableSpinnerLoading=!1})}},$scope.CurrentDateFormat=function(date){var updatedAt=moment(date,"YYYY-MM-DD HH:mm:ss").format("YYYY-MM-DD HH:mm:ss");return $filter("localDate")(updatedAt)},$scope.goToEdit=function(id){$state.go("snippet.edit",{_id:id})},$scope.checkInArray=function(array,id){return array.indexOf(id)>-1},$scope.showIntegrationCode=function(snippet){var countries=[],urls=snippet.allowed_url.split(",");urls=urls.filter(function(item){return item.length>0}),snippet.country.forEach(function(item){countries.push(item._id)});var routes=[];Restangular.one("data/call-routes").get().then(function(data){if(0==data.resource.error.no){var callRoutes=data.resource.routes;for(index in callRoutes){var newRouteObject={_id:callRoutes[index]._id,flagImage:"/assets/callburn/images/flags/"+callRoutes[index].code+".svg",viewText:callRoutes[index].name+" (+"+callRoutes[index].phonenumber_prefix+")",countryPrefix:" (+"+callRoutes[index].phonenumber_prefix+")"};$scope.checkInArray(countries,newRouteObject._id)&&routes.push(newRouteObject)}}}),SnippetService.getApiJs(snippet.api_token).then(function(data){var javascript=data.resource.javascript,snippetImagePath=snippet.image_url?snippet.image_url:"/assets/callburn/images/click_to_call_icons/callerid-icon.svg",imgQRCodeURL=snippet.qr_code_img_url;CallBournModal.open({scope:{javascript:javascript,snippet:snippet,showAll:urls.length>1,snippetImagePath:snippetImagePath,callburn_domain:"https://callme.callburn.com/",callRoutes:routes,countries:countries,dropdownOpen:!1,copyEffectClass:"",copyEffectPart:null,imgQRCodeURL:imgQRCodeURL,showTargetEmailInput:!1,apiToken:snippet.api_token},templateUrl:"/app/modals/clickToCall/confirm_snippet_creation_1.html"},function(scope){scope.close=function(){$state.go("snippet.overview"),CallBournModal.close()},scope.downloadWordPressPlugin=function(type){SnippetService.getWordPressPlugin(type,scope.snippet)},scope.sendEmailCTCIntCodes=function(email){var data={};data.snippet_id=snippet._id,data.email=email,data.token=scope.apiToken,SnippetService.sendCTCIntegrationCodesEmail(data).then(function(response){0===response.resource.error.no?growl.success($rootScope.trans("email_sucessfully_sent")):response.resource.error.no===-1&&growl.error($rootScope.trans("email_wasnt_sent"))})},scope.copyEffect=function(part){scope.copyEffectPart=part,scope.copyEffectClass="animated fadeOutUp",$timeout(function(){scope.copyEffectClass=""},1e3)}})})},$scope.removeSnippet=function(id){ConfirmDeleteModal().then(function(){$rootScope.startModalLoader(),$rootScope.disableButton(),SnippetService.removeSnippet(id).then(function(data){$rootScope.stopModalLoader(),$rootScope.enabledButton(),0==data.resource.error.no?$scope.snippets=$scope.snippets.filter(function(item){return item._id!=id}):growl.error(trans(data.resource.error.text))})})},$scope.changeOrder=function(data){if($scope.tableSpinnerLoading=!0,$scope.currentOrder="ASC"===$scope.currentOrder?"DESC":"ASC",$scope.orderField=data,"name"===data)var ordering={orderBy:"name",type:$scope.currentOrder};else if("created_at"===data)var ordering={orderBy:"created_at",type:$scope.currentOrder};var getData=Object.assign($scope.filterData,ordering);SnippetService.getSnippets(getData).then(function(data){0===data.resource.error.no&&($scope.snippets=data.resource.snippets,$scope.tableSpinnerLoading=!1)})},$scope.filteringSnippet=function(){$scope.tableSpinnerLoading=!0,SnippetService.getSnippets($scope.filterData).then(function(data){0==data.resource.error.no&&($scope.snippets=data.resource.snippets,$scope.count=data.resource.count,$scope.tableSpinnerLoading=!1)})},$scope.filterSnippetsCheckbox=function(status){if($scope.tableSpinnerLoading=!0,"all"==status){var allStatus=$scope.filterData.checkbox_all;$scope.filterData.checkbox_active=allStatus,$scope.filterData.checkbox_deleted=allStatus}else $scope.filterData.checkbox_active&&$scope.filterData.checkbox_deleted?$scope.filterData.checkbox_all=!0:$scope.filterData.checkbox_all=!1;$scope.filteringSnippet()},$rootScope.currentUser.balance<.22&&checkPublishedSnippets($scope.snippets)&&CallBournModal.open({scope:{},templateUrl:"/app/modals/clickToCall/low-balance.html"},function(scope){scope.close=function(){CallBournModal.close()}}),$scope.enableSnippet=function(snippet){var postData={};postData._id=snippet._id,postData.type="enable",SnippetService.enableOrDisableSnippet(postData).then(function(data){if(0===data.resource.error.no){var snippets=$scope.snippets.map(function(item){if(item._id===data.resource.snippet._id){var current=item;return current.is_active=data.resource.snippet.is_active,current}return item});$scope.snippets=snippets}})},$scope.disableSnippet=function(snippet){var postData={};postData._id=snippet._id,postData.type="disable",SnippetService.enableOrDisableSnippet(postData).then(function(data){if(0===data.resource.error.no){var snippets=$scope.snippets.map(function(item){if(item._id===data.resource.snippet._id){var current=item;return current.is_active=data.resource.snippet.is_active,current}return item});$scope.snippets=snippets}})},$scope.getStatus=function(snippet){return snippet.is_blocked?"ctc_status_deactivated":snippet.is_published?snippet.is_active?snippet.user.balance>=.22&&snippet.is_published?"ACTIVE"==snippet.status?"call_click_to_call_active":snippet.status:snippet.user.balance<.22&&snippet.is_published?"low_balance_disabled":void 0:"ctc_in_pause":"campaign_overview_index_draft"},$scope.getStatusClass=function(snippet){return snippet.is_blocked?"dark_orange":snippet.is_active&&0!==$rootScope.currentUser.numbers.length?snippet.is_published?snippet.user.balance<.22&&snippet.is_published?"dark_orange snippet_blinking":"ACTIVE"===snippet.status?"active_status":void 0:"integration-code-blue":"ctc-text-warning"},$scope.multiselectOptionsSnippetOverviewDataCallback=function(){var q=$q.defer();return $scope.multiselectOptionsSnippetOverviewData?q.resolve($scope.multiselectOptionsSnippetOverviewData):($interval(function(){if($scope.multiselectOptionsSnippetOverviewData)return q.resolve($scope.multiselectOptionsSnippetOverviewData)},500),q.promise)},$scope.multiselectOptionsSnippetOverviewDataCallback().then(function(data){$scope.checkedOptionsModel=[],$scope.multiSelectEvents.onSelectionChanged()}),$scope.multiselectSnippetOverviewSettings={template:"{{option.label}}",buttonClasses:""},$scope.multiSelectEvents={onSelectionChanged:function(){$scope.checkedOptions=[],$scope.checkedOptionsModel.forEach(function(option){$scope.checkedOptions.push(option.id)}),$scope.filterData.statuses=JSON.stringify($scope.checkedOptions),$scope.filteringSnippet()}},$scope.setHolidayMode=function($event,snippet){var id=snippet._id;CallBournModal.open({scope:{errorMessage:!1,holidayMode:snippet.holiday_mode,isActiveHolidayMode:snippet.is_active_holiday_mode,wrongDateRange:""},templateUrl:"/app/modals/clickToCall/holiday_mode.html"},function(scope){if(scope.holidayMode){var holidayModeFrom=scope.holidayMode.split("-")[0].trim(),holidayModeTo=scope.holidayMode.split("-")[1].trim();scope.holidayModeFrom=moment(holidayModeFrom,"DD/MM/.YYYY").format("DD.MM.YYYY"),scope.holidayModeTo=moment(holidayModeTo,"DD/MM/YYYY").format("DD.MM.YYYY")}else scope.holidayModeFrom=moment().format("DD.MM.YYYY"),scope.holidayModeTo=moment().add(1,"days").format("DD.MM.YYYY");scope.close=function(){CallBournModal.close()},scope.downloadWordPressPlugin=function(type){SnippetService.getWordPressPlugin(type,scope.snippet)},scope.changed=function(holidayModeFrom,holidayModeTo){var start=moment(holidayModeFrom,"DD.MM.YYYY"),end=moment(holidayModeTo,"DD.MM.YYYY");start.diff(end)>=0?scope.wrongDateRange="snippet-wrong-border":scope.wrongDateRange=""},scope.saveHolidayMode=function(from,to,isActiveHolidayMode){var postData={from:from,to:to,isActiveHolidayMode:isActiveHolidayMode,id:id};SnippetService.saveHolidayMode(postData).then(function(data){if(0===data.resource.error.no){var snippets=$scope.snippets.map(function(item){if(item._id===data.resource.snippet._id){var current=item;return current.holiday_mode=data.resource.snippet.holiday_mode,current.is_active_holiday_mode=data.resource.snippet.is_active_holiday_mode,current}return item});$scope.snippets=snippets,scope.close()}else scope.errorMessage=data.resource.error.text})}})},window.document.title=0===$scope.notSeenNotificationsCount?"ClickToCall - Callburn":"("+$scope.notSeenNotificationsCount+") ClickToCall - Callburn",$scope.showHolidayModeInStatus=function(snippet){if(!snippet.is_active_holiday_mode)return!1;var holidayModeRanges=snippet.holiday_mode.split("-"),start=moment(holidayModeRanges[0].trim(),"DD/MM/YYYY"),end=moment(holidayModeRanges[1].trim(),"DD/MM/YYYY"),now=moment();return now.diff(start)>=0&&now.diff(end)<=0}}]);