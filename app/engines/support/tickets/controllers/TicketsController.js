angular.module("callburnApp").controller("TicketsController",["$scope","$rootScope","$state","$stateParams","Restangular","growl",function($scope,$rootScope,$state,$stateParams,Restangular,growl){$rootScope.currentActiveRoute="tickets",$rootScope.currentActiveUrl="tickets",$rootScope.showWhiteMenu=!1,$rootScope.showFooter=!1,$rootScope.showRegistration=!1,$scope.createTicket={},$scope.showSendForm=$stateParams.showSendForm,$scope.filterData={},$scope.replayMessage={},$scope.index=function(params){Restangular.one("tickets/tickets").get(params).then(function(data){$scope.selectedTicket=$scope.selectedTicket>0?$scope.selectedTicket:0,$scope.tickets=data.resource.tickets,$scope.currentTicket=$scope.tickets[$scope.selectedTicket],$scope.replies=$scope.tickets[$scope.selectedTicket].replies,$scope.page=$scope.page>=0?$scope.page:0,$scope.maxPage=Math.ceil(data.resource.count/5),$scope.personalName=$rootScope.currentUser.personal_name,console.log(" $scope.replies",$scope.replies)})},$scope.index({}),$scope.createNewTicket=function(){Restangular.all("tickets/create-ticket").post($scope.createTicket).then(function(data){$scope.createTicket={},growl.success(trans(data.resource.error.text)),$scope.index({})})},$scope.showSelectedTicket=function(id){$scope.selectedTicket=id,$scope.currentTicket=$scope.tickets[id],$scope.replies=$scope.tickets[id].replies,$scope.showSendForm=!1},$scope.replayTicket=function(message){var obj={ticket_id:$scope.currentTicket._id,message:message};Restangular.all("tickets/reply-to-ticket").post(obj).then(function(data){$scope.index({}),$scope.replayMessage.text=null})},$scope.closeTicket=function(){var obj={ticket_id:$scope.currentTicket._id};Restangular.all("tickets/close-ticket").post(obj).then(function(data){$scope.index({}),$scope.replayMessage.text=null})},$scope.reopenTicket=function(){var obj={ticket_id:$scope.currentTicket._id};Restangular.all("tickets/reopen-ticket").post(obj).then(function(data){$scope.index({}),$scope.replayMessage.text=null})},$scope.changePage=function(page){page<=0||page>=$scope.maxPage?$scope.page=0:$scope.page=page,$scope.index({page:$scope.page})},$scope.filteredData=function(){$scope.index($scope.filterData)},$scope.filterTickets=function(status,checkbox){"ALL"===status?($scope.filterData.status="",$scope.filterData.open=checkbox,$scope.filterData.close=checkbox):"OPEN"===status?1==checkbox?($scope.filterData.status=status,$scope.filterData.close=!1):$scope.filterData.status="":"CLOSED"===status&&1==checkbox?($scope.filterData.status=status,$scope.filterData.open=!1):$scope.filterData.status="",$scope.index($scope.filterData),1==$scope.filterData.open&&1==$scope.filterData.close||($scope.filterData.all=!1)},$scope.checkSuportAnswer=function(index,userId,replies){return 0==index?replies[index].user_id!=userId:replies[index].user_id!=replies[index-1].user_id}}]);