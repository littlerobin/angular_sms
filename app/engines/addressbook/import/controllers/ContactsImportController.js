angular.module("callburnApp").controller("ContactsImportController",["$scope","$rootScope","$state","Restangular","$stateParams","FileUploader","$document","$timeout","groups","groupsAll","growl","$location","$anchorScroll","CallBournModal",function($scope,$rootScope,$state,Restangular,$stateParams,FileUploader,$document,$timeout,groups,groupsAll,growl,$location,$anchorScroll,CallBournModal){$scope.multiselectTrans={buttonDefaultText:$rootScope.trans("group")+":"},$rootScope.currentActiveUrl=$state.current.name,$scope.goToNotification=$rootScope.goToNotification,$rootScope.tutorialSidePopup=!1,$rootScope.currentPage="dashboard",$rootScope.currentActiveRoute="addressbook",$scope.showErrorsFilter=!1,$scope.import_step=1,$scope.responsePhonenumbers=[],$scope.reviewDataContacts=[],$scope.formData={selectDelimiter:"automatic",selector:"importSelect",selectGroup:!1,selectedGroup:{},groupName:"",columns:[],text:"",ignoreFirstLine:!1},$scope.contacts=[],$scope.contactsColumnsCount=0,$scope.contactsTotal=0,$scope.addedNumbers={},$scope.addedNumbers.text="",$scope.page=0,$scope.pagesCount=0,$scope.listingSkip=0,$scope.uploadingImageName="",$scope.selectedGroup={},$scope.groups=groups.resource.groups,$scope.groupsAll=groupsAll.resource.groups,$scope.checkedContacts={},$scope.isAllChecked=!1,$scope.arrowHelper=!0,$scope.nextArrowHelper=!1,$scope.fileLoader=!1,$scope.hideArrowHelper=function(){$scope.arrowHelper=!1,$scope.nextArrowHelper=!1},$scope.nextArrow=function(){$scope.nextArrowHelper=!0,angular.element("html, body").animate({scrollTop:angular.element("#toNextStep").offset().top},800,function(){})},$scope.formData.selectGroup="new_group",$scope.$watch("formData.selectGroup",function(newVal,oldVal){"new_group"==oldVal?$scope.formData.groupName="":"selected_group"==oldVal&&($scope.formData.selectedGroup={})}),$scope.selectManual=!0,$scope.selectImport=!1,$scope.currentStep=1,$scope.exampleModel={},$scope.tableModel={};var applyTranslations=function(){$scope.isLoaded=!1,setTimeout(function(){$scope.isLoaded=!0},100),$scope.columns=[{id:"",label:"--"},{id:"name",label:$rootScope.trans("contacts_name")},{id:"phone",label:$rootScope.trans("contacts_phonenumber")},{id:"group",label:$rootScope.trans("contacts_group_name")}]};$rootScope.$watch("currentLanguage",applyTranslations),$rootScope.$watch("isLangLoaded",applyTranslations),$scope.multiselectSettings={enableSearch:!0,showUncheckAll:!1,showCheckAll:!1,closeOnSelect:!0,selectionLimit:1,scrollableHeight:"150px",scrollable:!0,styleActive:!0,smartButtonMaxItems:1,smartButtonTextConverter:function(itemText,originalItem){return itemText},buttonClasses:"group_button"},$scope.tableTexts={buttonDefaultText:"--"},$scope.tableSettings={showUncheckAll:!1,showCheckAll:!1,selectionLimit:1,closeOnSelect:!0,styleActive:!0,smartButtonMaxItems:1,smartButtonTextConverter:function(itemText,originalItem){return itemText},buttonClasses:"group_button"},window.document.title=0===$scope.notSeenNotificationsCount?"Phonebook - Callburn":"("+$scope.notSeenNotificationsCount+") Phonebook - Callburn",$scope.backImportStep=function(step){1!==step&&($scope.currentStep-=1)},$scope.columnIndexes=[],$scope.toImportStep=function(step){if($scope.disableGroupsInStep3=!1,$scope.newGroupErr=!1,$scope.selectGroupErr=!1,$scope.chooseFile=!1,1===step){if(0!=$scope.contactsTotal&&!$scope.formData.text.length)return 1===$scope.contactsColumnsCount&&($scope.formData.columns[0]={id:"phone",name:$rootScope.trans("contacts_phonenumber")}),$scope.finishedStep1=!0,$scope.currentStep=2;$scope.formData.text&&$scope.formData.text.length?Restangular.all("phonenumbers/text-phonenumbers").post($scope.formData).then(function(data){return 0===data.resource.error.no?($scope.delimiter=data.resource.delimiter,$scope.contacts=data.resource.rows,$scope.contactsColumnsCount=data.resource.columnsCount,$scope.contactsTotal=data.resource.total,$scope.formData.columns=[],$scope.formData.fileName=data.resource.fileName,$scope.formData.originalFileName=data.resource.originalFileName,$scope.range(0,$scope.contactsColumnsCount-1).forEach(function(key){$scope.formData.columns[key]={id:""}}),$scope.finishedStep1=!0,$scope.currentStep=2):($scope.contacts=[],$scope.formData.contacts=[],$scope.contactsColumnsCount=0,$scope.contactsTotal=0,growl.error(trans(data.resource.error.text)),void 0)}):(growl.error($rootScope.trans("please_select_file_or_type_data_manually")),$scope.chooseFile=!0)}else if(2===step){var selectedNumber=($scope.formData.columns.length,!1),selectedGroup=!1,selectedName=!1,duplicateSelected=!1;if($scope.columnIndexes=[],$scope.formData.columns.forEach(function(item,index){""!=item.id&&$scope.columnIndexes.push(index),"name"==item.id&&($scope.formData.columns[index]={id:"name",name:$rootScope.trans("contacts_name")},selectedName&&(growl.error($rootScope.trans("you_selected_name_column_many_times")),duplicateSelected=!0),selectedName=!0),"phone"==item.id&&($scope.formData.columns[index]={id:"phone",name:$rootScope.trans("contacts_phonenumber")},selectedNumber&&(growl.error($rootScope.trans("you_selected_a_phone_number_column_many_times")),duplicateSelected=!0),selectedNumber=!0),"group"==item.id&&($scope.disableGroupsInStep3=!0,$scope.formData.selectGroup="indicated_in_a_column",$scope.formData.columns[index]={id:"group",name:$rootScope.trans("contacts_group_name")},selectedGroup&&(growl.error($rootScope.trans("you_selected_group_name_column_many_times")),duplicateSelected=!0),selectedGroup=!0)}),selectedNumber)if("indicated_in_a_column"!=$scope.formData.selectGroup||selectedGroup){if(!duplicateSelected){var postData={ignoreFirstLine:$scope.formData.ignoreFirstLine,columns:$scope.formData.columns,contacts:$scope.contacts},phoneIndex=null,phonenumbersValid=!0;if($scope.formData.columns&&$scope.formData.columns.length&&$scope.formData.columns.forEach(function(columnData,columnIndex){"phone"===columnData.id&&(phoneIndex=columnIndex)}),phonenumbersValid)return Restangular.all("phonenumbers/validate-phone-numbers").post(postData).then(function(data){$scope.reviewDataContacts=data.resource.contacts,$scope.reviewDataContacts.forEach(function(contact){contact.group||($scope.disableInColumnChoice=!0)})}),$scope.finishedStep2=!0,$scope.currentStep=3}}else growl.error($rootScope.trans("you_nee_to_select_group_name_column"));else growl.error($rootScope.trans("you_have_not_selected_a_phone_number_column"))}else 3==step&&("selected_group"!=$scope.formData.selectGroup||$scope.formData.selectedGroup.id?"new_group"==$scope.formData.selectGroup&&""==$scope.formData.groupName?(growl.error($rootScope.trans("please_type_new_group_name")),$scope.newGroupErr=!0):($rootScope.disableButton(),$rootScope.showFileLoader(),$rootScope.showWaitLightBox(),$scope.formData.delimiter=$scope.delimiter,Restangular.all("phonenumbers/upload-phonenumbers").post($scope.formData).then(function(data){$rootScope.enabledButton(),$rootScope.hideFileLoader(),$rootScope.hideWaitLightBox(),$scope.formData.originalFileName&&growl.warning($rootScope.trans("your_request_is_been_processed_and_it_may_take_a_few_minute")),$rootScope.inProgressFileData.id=data.resource.queue_job._id,$rootScope.inProgressFileData.name=data.resource.queue_job.original_file_name,$state.go("addressbook.groups",{group_id:data.resource.queue_job.group_id})})):(growl.error($rootScope.trans("please_select_group")),$scope.selectGroupErr=!0))},$scope.isContactPossibleIndexes=function(index){var possibleKeys=["name","phone","group"];return possibleKeys.indexOf(index)!=-1},$scope.selectImportSection=function(){$scope.selectManual=!$scope.selectManual,$scope.selectImport=!$scope.selectImport};var addPlaceForGroup=function(isNeed){for(index in $scope.responsePhonenumbers)$scope.responsePhonenumbers[index].groups=[],$scope.responsePhonenumbers[index].group&&isNeed&&$scope.responsePhonenumbers[index].groups.push($scope.responsePhonenumbers[index].group)};$scope.dragInside=!1,$scope.dragenter=0,$(window).on("dragenter",function(e){if(e.originalEvent.dataTransfer.types)for(var i=0;i<e.originalEvent.dataTransfer.types.length;i++)if("Files"==e.originalEvent.dataTransfer.types[i]){$scope.dragenter++;var uploaderContainer=angular.element("#uploaderContainer");$scope.dragenter>0?($scope.dragInside=!0,uploaderContainer.addClass("uploadArea")):($scope.dragInside=!1,uploaderContainer.removeClass("uploadArea"))}e.preventDefault(),e.stopPropagation()}),$(window).on("dragleave",function(e){if($scope.dragenter--,$scope.dragenter>0)$scope.dragInside=!0;else{var uploaderContainer=angular.element("#uploaderContainer");uploaderContainer.removeClass("uploadArea"),$scope.dragInside=!1}e.preventDefault(),e.stopPropagation()}),window.dropEvent=function(e){var uploaderContainer=angular.element("#uploaderContainer");console.log("AAAASAQDAD"),uploaderContainer.removeClass("uploadArea")},$scope.openFileSelect=function(){$timeout(function(){angular.element("#hiddenNumbersFileInput").trigger("click")},100)};var numbersFileUpload=$scope.numbersFileUpload=new FileUploader({url:"/phonenumbers/upload-phonenumbers-first-step",headers:{JWTAuthorization:"Bearer "+localStorage.getItem("jwtToken")},alias:"file",autoUpload:!0});$scope.uploadingFileName=null,numbersFileUpload.onAfterAddingFile=function(item){$scope.fileLoader=!0,$scope.uploadingFileName=item.file.name},numbersFileUpload.onSuccessItem=function(item,data,status,headers){0===data.resource.error.no?($scope.delimiter=data.resource.delimiter,$scope.formData.text="",$scope.contacts=data.resource.rows,$scope.contactsColumnsCount=data.resource.columnsCount,$scope.contactsTotal=data.resource.total,$scope.formData.columns=[],$scope.formData.fileName=data.resource.fileName,$scope.formData.originalFileName=data.resource.originalFileName,$scope.range(0,$scope.contactsColumnsCount-1).forEach(function(key){$scope.formData.columns[key]={id:""}}),$scope.fileLoader=!1,$scope.nextArrow()):($scope.contacts=[],$scope.formData.contacts=[],$scope.contactsColumnsCount=0,$scope.contactsTotal=0,growl.error(trans(data.resource.error.text)))},$scope.range=function(min,max,step){step=step||1;for(var input=[],i=min;i<=max;i+=step)input.push(i);return input},numbersFileUpload.onErrorItem=function(item,response,status,headers){$rootScope.enabledButton(),$rootScope.hideFileLoader(),$scope.uploadingImageName=!1,$rootScope.hideWaitLightBox()},$scope.showErrors=function(data){if(data){$scope.responsePhonenumbers=[];for(var index in $scope.copyResponsePhonenumbers)"success"!=$scope.copyResponsePhonenumbers[index].status&&$scope.responsePhonenumbers.push($scope.copyResponsePhonenumbers[index])}else $scope.responsePhonenumbers=$scope.copyResponsePhonenumbers},$scope.startUpload=function(){$rootScope.disableButton(),numbersFileUpload.uploadAll()},$scope.currentPage=void 0,$scope.changePage=function(pageNumber){pageNumber<0||pageNumber>$scope.pagesCount-1||($scope.currentPage=pageNumber+1,$scope.page=pageNumber,$scope.listingSkip=30*$scope.page)},$scope.addNumbers=function(numbers,group){if(numbers){var postData={phonenumbers:numbers,group:group?group:void 0};$rootScope.disableButton(),Restangular.all("phonenumbers/add-phonenumbers").post(postData).then(function(data){$rootScope.enabledButton(),$rootScope.stopLoader(),0==data.resource.error.no?($location.hash("saveCancelBlok"),$anchorScroll(),$scope.numbersResponseData=data.resource,$scope.responsePhonenumbers=data.resource.phonenumbers,$scope.copyResponsePhonenumbers=data.resource.phonenumbers,addPlaceForGroup(),$scope.import_step=2,$scope.pagesCount=Math.ceil(data.resource.count/10),growl.success(trans(data.resource.error.text)),$scope.showUploadedContacts=!0,$scope.addedNumbers.text=null):growl.error(trans(data.resource.error.text)),$scope.responsePhonenumbers.forEach(function(item){var groupName=item.group.name.split(" ");"created_on"==groupName[0]&&(item.group.name=item.group.name.replace("created_on",$rootScope.trans("created_on")))})})}else growl.error($rootScope.trans("Text_area_will_be_required"))},$scope.cancelSaving=function(){$state.go("addressbook.contacts")},$scope.getGroupName=function(group){var namesArray=group.name.split("("),standardPart=namesArray[0].trim();if(namesArray[1]){var customPart=namesArray[1].replace(")",""),translated=trans(standardPart);return $scope.groupName=translated+" ("+customPart+")",translated+" ("+customPart+")"}return $scope.groupName=standardPart,standardPart},$scope.$watch("addedNumbers.text",function(newVal){newVal||($scope.manualPhonenumbersCount=0)}),$scope.saveImportedNumbers=function(){var newArray=new Array,actual=$scope.checkedContacts;for(actIndex in actual)actual[actIndex]&&newArray.push(actIndex);var sendingArrayData=[];if(newArray.length>0)for(index in newArray)for(tempIndex in $scope.responsePhonenumbers)$scope.responsePhonenumbers[tempIndex].number==newArray[index]&&sendingArrayData.push($scope.responsePhonenumbers[tempIndex]);else sendingArrayData=$scope.responsePhonenumbers;$rootScope.disableButton(),$rootScope.showFileLoader(),Restangular.all("address-book/import-contacts").post({contacts_data:sendingArrayData,group_name:$scope.groupName?$scope.groupName:null}).then(function(data){$rootScope.enabledButton(),$rootScope.stopModalLoader(),0==data.resource.error.no&&$state.go("addressbook.groups"),$rootScope.hideFileLoader()},function(){$rootScope.enabledButton(),$rootScope.hideFileLoader(),growl.error($rootScope.trans("contacts_cant_be_saved_try_later"))})},$scope.calcPhonenumbers=function(text){text?$scope.manualPhonenumbersCount=text.replace(/\r\n/g,",").replace(/\n/g,",").replace(/\r/g,",").split(",").length:$scope.manualPhonenumbersCount=0},$scope.selectedMethod="fileUpload",$scope.selectMethod=function(type){$scope.selectedMethod=type},$scope.qrUrl="",$scope.loadingQr=!0,Restangular.one("address-book/mobile-contacts").get().then(function(data){0===data.resource.error.no&&($scope.loadingQr=!1,$scope.qrUrl="https://chart.googleapis.com/chart?chs=250x250&cht=qr&chl="+data.resource.token+"&choe=UTF-8")})}]).filter("notSelected",function(){return function(input,scope,number){for(index in scope.responsePhonenumbers)if(scope.responsePhonenumbers[index].number==number)var groups=scope.responsePhonenumbers[index].groups;var out=[];return angular.forEach(input,function(group){var needToAdd=!0;for(index in groups)if(groups[index].id==group._id){needToAdd=!1;break}needToAdd&&out.push(group)}),out}});