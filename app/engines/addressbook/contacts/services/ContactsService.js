angular.module("callburnApp").factory("ContactsService",function($sce,$rootScope,Restangular,$state,growl,$httpParamSerializer,$timeout){var PhoneBookData=function(contacts,showMoreSelectBox,isEditing){this.isEditing=isEditing,this.contactsData=contacts.resource,this.selectedContacts={},this.showEditBox=!1,this.redBorder="",this.showMoreSelectBox=showMoreSelectBox,this.removingGroupsLoader=!1,this.eventListener(),this.tableSpinnerLoading=!1,this.checkedContacts={},this.checkboxAll=!1,this.disableSelectAll=!1,this.contactsData.contacts.forEach(function(contact){contact.selectable=!0}),this.showSearch=!1,this.showEverything=!1,this.searchVal="",this.showSearchVal=!1,this.showMoreLoader=!1,this.aPage=0,this.isAllSelected=!1,this.filterOrAddContactData={},this.contactsMoreDropdownToggle=!1,window.currentUrlHash=window.location.hash.indexOf("compose"),this.currentUrlHash=window.currentUrlHash};return PhoneBookData.prototype.getContactDate=function(contact){var date=contact.updated_at?contact.updated_at:contact.created_at;return this.changeDateString(date)},PhoneBookData.prototype.changeDateString=function(dateString){return date=moment(dateString,"YYYY-MM-DD hh:mm:ss"),date.format("DD/MM/YY HH:mm")},PhoneBookData.prototype.checkInArray=function(array,item){return array.indexOf(item)>-1},PhoneBookData.prototype.checkInObject=function(object,key){return key in object},PhoneBookData.prototype.getObjectLength=function(object){return Object.keys(object).length},PhoneBookData.prototype.choiceOrRemove=function(object,key){this.checkInObject(object,key)?delete object[key]:object[key]=!0},PhoneBookData.prototype.selectAllContacts=function(disableAll){var scope=this,disableAll=!!disableAll;this.isAllSelected=!1,this.checkedAllContacts=!this.checkedAllContacts,this.checkedAllContacts?this.contactsData.contacts.forEach(function(contact){scope.selectedContacts[contact._id]=!0,contact.selectable=!disableAll}):this.selectedContacts={};var checkedGroupsArr=Object.values(scope.selectedContacts);checkedGroupsArr.length?scope.contactsMoreDropdownToggle=!0:scope.contactsMoreDropdownToggle=!1},PhoneBookData.prototype.selectOrRemoveContact=function(selectedContacts,contact){var scope=this;PhoneBookData.prototype.choiceOrRemove(selectedContacts,contact._id);var checkedGroupsArr=Object.values(scope.selectedContacts);if(checkedGroupsArr.length?scope.contactsMoreDropdownToggle=!0:scope.contactsMoreDropdownToggle=!1,Object.keys(this.selectedContacts).length!==this.contactsData.contacts.length)return void(this.checkedAllContacts=!1);for(index in this.selectedContacts)if(!this.selectedContacts[index])return void(this.checkedAllContacts=!1);this.checkedAllContacts=!0},PhoneBookData.prototype.sendMessage=function(){if(this.getObjectLength(this.selectedContacts)){var data=[],scope=this;this.contactsData.contacts.forEach(function(item){if(item._id in scope.selectedContacts){var currentPhonenumber={phone_no:item.phone_number};data.push(currentPhonenumber)}}),$state.go("campaign.compose",{contact_ids:data})}},PhoneBookData.prototype.removeSelected=function(){return this.getObjectLength(this.selectedContacts)?(this.removingGroupsLoader=!0,void this.removeContacts()):void growl.warning($rootScope.trans("No_Contact_Selected"))},PhoneBookData.prototype.removeContacts=function(){var postData={contact_ids:Object.keys(this.selectedContacts),group_id:this.contactsData.currentGroup?this.contactsData.currentGroup._id:null};$rootScope.disableButton();var scope=this,url="address-book/remove-contacts";this.isAllSelected&&(postData={key_word:this.filterOrAddData,group_id:this.contactsData.currentGroup?this.contactsData.currentGroup._id:null},url="address-book/remove-contacts-searched"),Restangular.all(url).post(postData).then(function(data){if($rootScope.enabledButton(),0===data.resource.error.no)if(data.resource.groupIsRemoved&&$state.go("addressbook.groups"),scope.isAllSelected){scope.selectSearchedContacts(),scope.filterOrAddData="";var data={per_page:50,phone_number:"",page:0,key_word:"",group_id:scope.contactsData.currentGroup?scope.contactsData.currentGroup._id:null};scope.contactsData.contacts=[],scope.reloadData(data).then(function(){scope.removingGroupsLoader=!1,scope.clearSearch()})}else{var size=Object.keys(scope.selectedContacts).length;scope.contactsData.count-=size,scope.contactsData.allContactsOfGroupCount-=size,scope.filterContactsRemoved(scope.contactsData.contacts,scope.selectedContacts).then(function(filteredContacts){scope.contactsData.contacts=filteredContacts,filteredContacts||scope.clearSearch(),scope.selectedContacts={}}).then(function(){scope.removingGroupsLoader=!1,scope.checkedAllContacts=!1})}else $rootScope.enabledButton(),scope.removingGroupsLoader=!1})},PhoneBookData.prototype.filterContactsRemoved=function(allContacts,removedContacts){var scope=this;return new Promise(function(resolve,reject){var result=[];if(allContacts.length===removedContacts.length)return resolve(result);var i;for(i=0;i<allContacts.length;i++)scope.checkInObject(removedContacts,allContacts[i]._id)||result.push(allContacts[i]);return resolve(result)})},PhoneBookData.prototype.updateContacts=function(contacts,type){this.tableSpinnerLoading=!1;var res=contacts.resource,scope=this;this.contactsData.currentGroup=res.currentGroup,this.contactsData.allContactsOfGroupCount=res.allContactsOfGroupCount,this.contactsData.count=res.count,this.contactsData.page=res.page,this.total=res.count,"search"===type?(scope.contactsData.contacts=res.contacts,scope.showMoreLoader=!1):(res.contacts.length?res.contacts.forEach(function(item){scope.contactsData.contacts.push(item)}):scope.clearSearch(),scope.showMoreLoader=!1)},PhoneBookData.prototype.reloadData=function(params,type){var scope=this;return Restangular.one("address-book/index-contacts").get(params).then(function(data){"search"===type?scope.updateContacts(data,type):scope.updateContacts(data)})},PhoneBookData.prototype.filterContacts=function(){this.tableSpinnerLoading=!0,this.showEverything=!0,$rootScope.showEverything=!0,this.showSearchVal=!0,this.searchVal=this.filterOrAddData,this.aPage=0;var data={per_page:50,phone_number:this.filterOrAddData,page:0,key_word:this.filterOrAddData};this.contactsData.currentGroup&&(data.group_id=this.contactsData.currentGroup._id);this.reloadData(data,"search"),$rootScope.showEverything=!0},PhoneBookData.prototype.showEditNameInput=function(){"all"!=this.contactsData.currentGroup._id&&(this.contactsData.currentGroup.name=this.contactsData.currentGroup.name?this.contactsData.currentGroup.name:trans("add_a_name"),this.showEditBox=!0,setTimeout(function(){angular.element("#change-group-name").select()},100))},PhoneBookData.prototype.changeName=function(id){if(this.showEditBox){if(!this.contactsData.currentGroup.name)return;var newName=this.contactsData.currentGroup.name;$rootScope.disableButton();var scope=this;Restangular.one("address-book/update-group",id).put({name:newName}).then(function(data){$rootScope.enabledButton(),0===data.resource.error.no&&(scope.showEditBox=!1)})}},PhoneBookData.prototype.getGroupName=function(group){var scope=this;return"all"===scope.contactsData.currentGroup._id?trans("addressbook_all_contacts"):group.name?group.name:trans("add_a_name")},PhoneBookData.prototype.backToPhonebook=function(){$state.go("addressbook.groups")},PhoneBookData.prototype.eventListener=function(){var scope=this;document.addEventListener("keydown",function(e){var keyCode=e.keyCode;if(13===keyCode){var activeFilterSearchBoxId=document.activeElement.id?document.activeElement.id:"";"filter-search-box"===activeFilterSearchBoxId.trim()&&scope.filterContacts(),scope.showEditBox&&(scope.contactsData.currentGroup?scope.changeName(scope.contactsData.currentGroup._id):scope.changeName("all"))}})},PhoneBookData.prototype.toggleSearch=function(){this.showSearch&&$rootScope.importantShowSearch?this.filterContacts():this.showSearch=!0;var inp=document.querySelector("input[name=addressbook-group-filter]");$timeout(function(){inp.focus()},1e3)},PhoneBookData.prototype.enterPress=function(key){13===key.which?this.filterContacts():null},PhoneBookData.prototype.clearSearch=function(){this.filterOrAddData="",this.filterContacts(),this.aPage=0,this.showEverything=!1,$rootScope.showEverything=!1,this.searchVal="",this.showSearchVal=!1},PhoneBookData.prototype.getMore=function(){var scope=this;this.aPage++,this.filterOrAddContactData.per_page=50,this.filterOrAddContactData.page=this.aPage,this.filterOrAddContactData.phone_number=this.filterOrAddData,this.filterOrAddContactData.key_word=this.filterOrAddData,this.filterOrAddContactData.group_id=this.contactsData.currentGroup?this.contactsData.currentGroup._id:null,Restangular.one("address-book/index-contacts").get(this.filterOrAddContactData).then(function(data){scope.updateContacts(data)})},PhoneBookData.prototype.tableInit=function(){$rootScope.showEverything=!1;var scope=this;if(scope.contactsData.succeed||scope.contactsData.failed){var data={series:[scope.contactsData.failed||0,scope.contactsData.succeed||0]},sum=function(a,b){return a+b},responsiveOptions=[["screen and (max-width: 992px)",{width:200,height:150,labelOffset:40}]],options={chartPadding:30,labelOffset:50,labelInterpolationFnc:function(value){return Math.round(value/data.series.reduce(sum)*100)+"%"},width:300,height:200};new Chartist.Pie("#ct-chart",data,options,responsiveOptions)}else scope.fakeChart=!0;var elem=angular.element(document.getElementById("myTable").tBodies[0])[0];elem.addEventListener("scroll",function(event){this.isDone||(event.preventDefault(),elem.scrollTop+elem.clientHeight===elem.scrollHeight&&$rootScope.tableToElement<scope.contactsData.count&&(scope.showMoreLoader=!0,scope.getMore(),elem.scrollHeight=0))})},PhoneBookData.prototype.selectSearchedContacts=function(){var scope=this;this.isAllSelected=!this.isAllSelected,this.checkedAllContacts=this.isAllSelected,scope.isAllSelected?this.contactsData.contacts.forEach(function(contact){scope.selectedContacts[contact._id]=scope.isAllSelected}):scope.selectedContacts={};var checkedGroupsArr=Object.values(scope.selectedContacts);checkedGroupsArr.length?scope.contactsMoreDropdownToggle=!0:scope.contactsMoreDropdownToggle=!1},PhoneBookData.prototype.scrollDown=function(){var elem=angular.element("#wrapper")[0];angular.element("#wrapper").animate({scrollTop:elem.scrollHeight},800,function(){})},PhoneBookData});