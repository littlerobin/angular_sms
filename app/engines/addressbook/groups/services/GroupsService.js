angular.module("callburnApp").factory("GroupsService",function($sce,$rootScope,Restangular,$state,growl,$timeout){var PhoneBookData=function(groups,addedContacts,selectedGroupIds,showMoreSelectBox,showSearch,isComposeEditing){if(this.groupsData=groups.resource,this.isComposeEditing=isComposeEditing,this.addedContactsCount=addedContacts&&addedContacts.resource?addedContacts.resource.valid_contacts_count:null,this.groupsData.lastAddedContactDate&&"groups"!==$rootScope.currentActiveRoute&&!this.isComposeEditing){var allGroup={_id:"all",name:trans("addressbook_all_contacts"),contact_count:[{count:this.groupsData.allContactsCount}],updated_at:this.groupsData.lastAddedContactDate.created_at,added_contacts_count:this.addedContactsCount};this.groupsData.groups.unshift(allGroup)}this.checkedGroups=selectedGroupIds,this.filterOrAddData={},this.filterOrAddContactData={},this.currentOrder="ASC",this.orderField=null,this.showArrowByField="updated_at",this.tableSpinnerLoading=!1,this.removingGroupsLoader=!1,this.mergeGroupsLoader=!1,this.exportUrlLoader=!1,this.showMoreSelectBox=showMoreSelectBox,this.groupsMoreDropdown=!1,this.groupsMoreDropdownToggle=!1,this.showSearch=!1,this.showEverything=!1,this.isAllSelected=!1,this.page=1,this.inited=!1,this.aPage=0,this.showSearchVal=!1,this.searchVal="",this.showMoreLoader=!1,this.isDone=!1,this.isCurrentSelected=!1,this.search_in_groups=0,this.enableSearchInGroups=!1,this.orderData={},this.newGroupName="",this.socketArr=[]};return PhoneBookData.prototype.getGroupDate=function(group){var date=group.updated_at?group.updated_at:group.created_at;return date=moment(date,"YYYY-MM-DD hh:mm:ss"),"all"==group._id?"--":date.format("DD/MM/YY HH:mm")},PhoneBookData.prototype.getGroupName=function(group){return"all"===group._id?trans("addressbook_all_contacts"):group.name?"CREATED_ON_RETRY_UNDELIVERED"===group.type?trans("addressbook_undelivered_group")+" "+group.name:group.name:trans("add_a_name")},PhoneBookData.prototype.getGroupType=function(group){return"all"===group._id?"":"CREATED_BY_USER_MANUALLY"===group.type||"CREATED_BY_USER_FROM_FILE"===group.type?"addressbook_import_added_manually":"address_book_groups_autosaved"},PhoneBookData.prototype.checkInArray=function(array,item){return array.indexOf(item)>-1},PhoneBookData.prototype.checkInObject=function(object,key){return key in object&&object[key]},PhoneBookData.prototype.getObjectLength=function(object){return Object.keys(object).length},PhoneBookData.prototype.checkIfAllChecked=function(){return!!this.checkedGroups.all},PhoneBookData.prototype.checkedAllGroups=function(){this.checkedGroups={};var scope=this;this.groupsData.groups.forEach(function(item){scope.checkedGroups[item._id]=!0})},PhoneBookData.prototype.uncheckedAllGroups=function(){this.checkedGroups={};var scope=this;this.groupsData.groups.forEach(function(item){"all"!==item._id&&(scope.checkedGroups[item._id]=!1)})},PhoneBookData.prototype.sendMessage=function(){return this.groupsMoreDropdown=!1,this.getObjectLength(this.checkedGroups)?($rootScope.hideFormQuestions=!0,void $state.go("campaign.compose",{group_ids:this.checkedGroups})):void growl.info($rootScope.trans("No_group_selected"))},PhoneBookData.prototype.getExportUrl=function(){if(!this.getObjectLength(this.checkedGroups))return void growl.warning($rootScope.trans("No_Contact_Selected"));this.exportUrlLoader=!0;var scope=this;Restangular.one("data/download-token").get().then(function(data){scope.exportUrlLoader=!1,scope.groupsMoreDropdown=!1;var token=data.resource.token,locale=$rootScope.currentLanguage,params=JSON.stringify(scope.checkedGroups),url="/address-book/export-contacts?group_or_contact=group&selected_ids="+params+"&locale="+locale+"&token="+token;window.location.href=url})},PhoneBookData.prototype.mergeGroups=function(){if(!this.getObjectLength(this.checkedGroups))return void growl.info($rootScope.trans("No_group_selected"));if(this.getObjectLength(this.checkedGroups)<=1)return void growl.info($rootScope.trans("Select_more_than_one_group"));this.mergeGroupsLoader=!0;var postData={name:"New name",ids:this.checkedGroups};$rootScope.disableButton();var scope=this;Restangular.all("address-book/merge-groups").post(postData).then(function(data){scope.groupsMoreDropdown=!1,scope.mergeGroupsLoader=!0,scope.reloadGroups({})})},PhoneBookData.prototype.reloadGroups=function(params,type){$rootScope.disableButton();var scope=this;params.fromCompose=!0,params.per_page=14,"delete"===type&&(params.page=0,scope.aPage=0),Restangular.one("address-book/index-groups").get(params).then(function(data){$rootScope.enabledButton(),type?scope.updateGroups(data,type):scope.updateGroups(data)})},PhoneBookData.prototype.changePage=function(page){if(this.tableSpinnerLoading=!0,!(page<0)){var postData=this.filterOrAddData;postData.page=page,this.reloadGroups(postData)}},PhoneBookData.prototype.removeGroups=function(paramData){var postData=paramData?paramData:JSON.stringify(this.checkedGroups);$rootScope.disableButton();var requestData={group_ids:postData},scope=this,deleteUrl="address-book/remove-groups";this.isAllSelected&&(requestData=this.filterOrAddContactData,deleteUrl="address-book/remove-groups-searched"),Restangular.all(deleteUrl).remove(requestData).then(function(data){if($rootScope.enabledButton(),0===data.resource.error.no){scope.removingGroupsLoader=!1,scope.groupsMoreDropdown=!1,scope.isAllSelected=!1,scope.groupsData.groups.forEach(function(item){scope.checkedGroups[item._id]=!1});var postData={};postData.page=0,scope.reloadGroups(postData,"delete")}else data.resource.error.no===-1?(growl.error($rootScope.trans("contacts_used_and_cant_be_removed")),scope.removingGroupsLoader=!1):scope.removingGroupsLoader=!1})},PhoneBookData.prototype.removeSelected=function(){var scope=this;return this.getObjectLength(this.checkedGroups)||this.isAllSelected?void(this.checkInObject(this.checkedGroups,"all")?ConfirmDeleteModal().then(function(){scope.removeGroups(scope.checkedGroups)}):(this.removingGroupsLoader=!0,scope.removeGroups(this.checkedGroups))):void growl.warning($rootScope.trans("No_Contact_Selected"))},PhoneBookData.prototype.socketPromise=function(){var scope=this;return new Promise(function(resolve){Restangular.one("address-book/index-groups").get(scope.filterOrAddContactData).then(function(res){scope.groupsData.allContactsCount=res.resource.allContactsCount,scope.groupsData.allGroupsCount=res.resource.allGroupsCount,scope.groupsData.count=res.resource.count,scope.groupsData.lastAddedContactDate=res.resource.lastAddedContactDate,scope.groupsData.page=res.resource.page,scope.total=res.resource.count,resolve(res.resource.groups)})})},PhoneBookData.prototype.updateGroups=function(groups,type){var res=groups.resource,scope=this;if(this.groupsData.allContactsCount=res.allContactsCount,this.groupsData.allGroupsCount=res.allGroupsCount,this.groupsData.count=res.count,this.groupsData.lastAddedContactDate=res.lastAddedContactDate,this.groupsData.page=res.page,this.total=res.count,"search"===type||"delete"===type)scope.groupsData.groups=res.groups,scope.showMoreLoader=!1,scope.tableSpinnerLoading=!1,scope.isDone=!1;else if("socket"===type){scope.tableSpinnerLoading=!0,scope.showMoreLoader=!1;for(var i=0;i<=scope.aPage;i++)scope.filterOrAddContactData.page=i,scope.socketArr.push(scope.socketPromise());Promise.all(scope.socketArr).then(function(result){var tempResult=[];result.forEach(function(pageData){tempResult=tempResult.concat(pageData)}),scope.groupsData.groups=tempResult,scope.showMoreLoader=!1,scope.isDone=!1,scope.tableSpinnerLoading=!1})}else res.groups.forEach(function(item){scope.groupsData.groups.push(item)}),scope.showMoreLoader=!1,this.tableSpinnerLoading=!1,this.isDone=!1},PhoneBookData.prototype.filterContacts=function(){this.tableSpinnerLoading=!0;var postData=this.filterOrAddContactData;postData.page=0,this.aPage=0,this.showEverything=!0,$rootScope.showEverything=!0,this.showSearchVal=!0,this.searchVal=this.filterOrAddContactData.name,this.search_in_groups=0,postData.search_in_groups=0,this.reloadGroups(postData,"search")},PhoneBookData.prototype.goToGroupPage=function($event,group){if(!this.tableRowDisable){var id=group._id;if(group.contact_count.length&&group.contact_count[0].count&&!group.in_progress){var tag=$event.target.nodeName.toLowerCase();"input"!==tag&&"label"!==tag&&$state.go("addressbook.contacts",{group_id:id})}}},PhoneBookData.prototype.changeOrder=function(field){this.tableSpinnerLoading=!0,this.showArrowByField=field;var postData=this.filterOrAddData;field==postData.order_field&&(this.currentOrder="ASC"==this.currentOrder?"DESC":"ASC",this.orderField=field),postData.order_field=field,postData.order=this.currentOrder,postData.page=0,this.aPage=0,postData.per_page=14,this.orderData=postData,this.reloadGroups(postData,"search")},PhoneBookData.prototype.eventListeners=function(){var scope=this;document.addEventListener("keydown",function(e){var keyCode=e.keyCode;if(13===keyCode){var activeFilterSearchBoxId=document.activeElement.id?document.activeElement.id:"";"filter-search-box"===activeFilterSearchBoxId.trim()&&scope.filterContacts()}}),$rootScope.$watch("currentUser",function(currentUser){currentUser.notifications&&currentUser.notifications.forEach(function(item){"update_groups_data"===item.other_data&&scope.reloadGroups({})})},1)},PhoneBookData.prototype.toggleSearch=function(){this.showSearch&&$rootScope.importantShowSearch?this.filterContacts():this.showSearch=!0;var inp=document.querySelector("input[name=addressbook-group-filter]");$timeout(function(){inp.focus()},1e3)},PhoneBookData.prototype.enterPress=function(key){13===key.which?this.filterContacts():null},PhoneBookData.prototype.clearSearch=function(){this.filterOrAddContactData.name="",this.searchVal="",this.aPage=0,this.search_in_groups=0,this.filterContacts(),this.showSearchVal=!1,this.showEverything=!1,$rootScope.showEverything=!1},PhoneBookData.prototype.getMore=function(){var scope=this;return scope.groupsData.count==scope.groupsData.groups.length||scope.groupsData.count<scope.groupsData.groups.length||scope.tableSpinnerLoading?void(scope.showMoreLoader=!1):(this.aPage++,this.filterOrAddContactData.page=this.aPage,this.orderData&&(this.filterOrAddContactData=scope.orderData,this.filterOrAddContactData.page=scope.aPage),this.filterOrAddContactData.search_in_groups=this.search_in_groups,this.filterOrAddContactData.per_page=14,void Restangular.one("address-book/index-groups").get(this.filterOrAddContactData).then(function(data){scope.updateGroups(data)}))},PhoneBookData.prototype.tableInit=function(){if(!this.inited){this.inited=!0,$rootScope.showEverything=!1;var scope=this,elem=angular.element(document.getElementById("myTable").tBodies[0])[0];elem.addEventListener("scroll",function(event){this.isDone||Math.ceil(elem.scrollTop)+elem.clientHeight!=elem.scrollHeight||scope.tableSpinnerLoading||(scope.isDone=!0,scope.showMoreLoader=!0,scope.getMore())})}},PhoneBookData.prototype.choiceOrRemove=function(object,key){var scope=this;if(!this.tableRowDisable){this.checkInObject(object,key)?object[key]=!1:object[key]=!0;var checkedGroupsArr=Object.values(this.checkedGroups);checkedGroupsArr.length?checkedGroupsArr.some(function(item){return item?(scope.groupsMoreDropdownToggle=!0,item):void(scope.groupsMoreDropdownToggle=!1)}):scope.groupsMoreDropdownToggle=!1}},PhoneBookData.prototype.selectCurrentGroup=function(){this.isCurrentSelected=!this.isCurrentSelected,this.checkedGroups={};var scope=this;this.groupsData.groups.forEach(function(item){scope.checkedGroups[item._id]=scope.isCurrentSelected});var checkedGroupsArr=Object.values(scope.checkedGroups);checkedGroupsArr.length?checkedGroupsArr.some(function(item){return item?(scope.groupsMoreDropdownToggle=!0,item):void(scope.groupsMoreDropdownToggle=!1)}):scope.groupsMoreDropdownToggle=!1},PhoneBookData.prototype.selectSearchedGroups=function(){var scope=this;this.isAllSelected=!this.isAllSelected,this.groupsData.groups.forEach(function(item){scope.checkedGroups[item._id]=scope.isAllSelected});var checkedGroupsArr=Object.values(scope.checkedGroups);checkedGroupsArr.length?checkedGroupsArr.some(function(item){return item?(scope.groupsMoreDropdownToggle=!0,item):void(scope.groupsMoreDropdownToggle=!1)}):scope.groupsMoreDropdownToggle=!1},PhoneBookData.prototype.scrollDown=function(){var elem=angular.element("#wrapper")[0];angular.element("#wrapper").animate({scrollTop:elem.scrollHeight},800,function(){})},PhoneBookData.prototype.searchInstead=function(){var scope=this;if(this.tableSpinnerLoading=!0,scope.enableSearchInGroups)scope.enableSearchInGroups=!1,scope.clearSearch();else{scope.enableSearchInGroups=!0,scope.search_in_groups=1;var postData=scope.filterOrAddContactData;postData.page=0,postData.search_in_groups=scope.search_in_groups,scope.aPage=0,scope.reloadGroups(postData,"search")}},PhoneBookData.prototype.showGroupNameInput=function(group){this.newGroupName=group.name,this.groupsData.groups.forEach(function(group){group.showInput=!1}),group.showInput?group.showInput=!1:group.showInput=!0},PhoneBookData.prototype.renameGroup=function(group){group.showInput=!1,this.newGroupName.length&&(group.name=this.newGroupName,console.log(this.newGroupName))},PhoneBookData});