angular.module("callburnApp").controller("InvoicesController",["$scope","$rootScope","$state","Restangular","$stateParams","invoices","orders","$httpParamSerializer","billings","CallBournModal","$filter",function($scope,$rootScope,$state,Restangular,$stateParams,invoices,orders,$httpParamSerializer,billings,CallBournModal,$filter){$rootScope.tutorialSidePopup=!1,$scope.goToNotification=$rootScope.goToNotification,$rootScope.currentPage="dashboard",$rootScope.currentActiveRoute="account",$scope.filterData={},$scope.billingData=billings.resource,$stateParams.payment_amount&&dataLayer.push({purchased_amount:$stateParams.payment_amount,event:"order_created"}),window.document.title=0===$scope.notSeenNotificationsCount?"Invoices - Callburn":"("+$scope.notSeenNotificationsCount+") Invoices - Callburn";var applyTranslations=function(){$scope.isLoaded=!1,setTimeout(function(){$scope.isLoaded=!0},100),$scope.getAppropriateStatus=function(type,billingObj){return"BILLING"===type?trans("account_invocies_billings_billed"):"GIFT"===type?trans("account_invocies_billings_gifted_2"):"TRANSACTION"===type?trans("account_invocies_billings_purchased"):"REFUND"===type?trans("account_invocies_billings_refund"):"MANUAL_SERVICE"===type?trans("account_invocies_billings_manual_service"):void 0},$scope.invoiceGiftSum=0,$scope.getAppropriateAmount=function(type,billingObj){if(billingObj.paidFromGift=!1,billingObj.giftSumText=null,"BILLING"===type){if(billingObj.giftSum){billingObj.paidFromGift=!0;var giftSum=$rootScope.trans("account_invocies_billings_gift")+": (€ "+$filter("number")(billingObj.giftSum,2)+")";billingObj.giftSumText=giftSum;var final_amount=billingObj.purchasedSum+billingObj.giftSum;return $filter("number")(final_amount,2)}return $filter("number")(billingObj.purchasedSum,2)}if("GIFT"===type)return billingObj.giftSum?$filter("number")(billingObj.giftSum,2):"0.00";if("TRANSACTION"===type){var taxAmount=billingObj.taxAmount&&parseInt(billingObj.taxAmount)>0?trans("account_invocies_billings_tax_amount")+": (€ "+$filter("number")(billingObj.taxAmount,2)+")":"";return $scope.invoiceGiftSum=taxAmount,$filter("number")(billingObj.purchasedSum,2)}if("REFUND"===type){if(billingObj.giftSum){var giftSum=trans("account_invocies_billings_gift")+": (€ "+$filter("number")(billingObj.giftSum,2)+")";$scope.invoiceGiftSum=giftSum;var final_amount=Math.abs(billingObj.purchasedSum+billingObj.giftSum);return"- "+$filter("number")(final_amount,2)}return"- "+$filter("number")(Math.abs(billingObj.purchasedSum),2)}return"MANUAL_SERVICE"===type?$filter("number")(billingObj.purchasedSum,2):void 0}};$scope.getBalanceAfterBilling=function(billing){var balanceAfterBilling=$filter("number")(billing.current_balance_after_billing,2);return balanceAfterBilling},$rootScope.$watch("currentLanguage",applyTranslations),$rootScope.$watch("isLangLoaded",applyTranslations),$scope.getDateDifference=function(created_at){return moment.locale($rootScope.currentLanguage),createdAt=moment(created_at),$scope.createdAtFormated=$filter("localDate")(moment(created_at)),createdAt.fromNow()},$scope.getBillingDetails=function(billingObj){Restangular.one("billings/billing-details").get({date:billingObj.date}).then(function(data){var messages=data.resource.billings.messages,snippets=data.resource.billings.snippets;console.log("messages :",messages),console.log("snippets :",snippets),CallBournModal.open({scope:{messages:messages,snippets:snippets},templateUrl:"/app/modals/billings/billing-modal.html"},function(scope){scope.close=function(){$state.go("snippet.overview"),CallBournModal.close()}})})};var updateBilings=function(billings){$scope.billings=billings.resource.billings,$scope.billingsLength=billings.resource.count,$scope.billingsPage=billings.resource.page,$scope.billingsPagesCount=Math.ceil(billings.resource.count/10),$scope.billingsPerPage=10};if($scope.changeBillingsPage=function(page){if(!(page<0||page>$scope.billingsPagesCount)){var postData=$scope.filterData;postData.page=page-1,Restangular.one("billings/billings").get(postData).then(function(data){updateBilings(data)})}},updateBilings(billings),$rootScope.currentUser.is_autobilling_active);else;var updateInvoices=function(invoicesToUpdate){$scope.invoices=invoicesToUpdate.resource.invoices,$scope.invoicesLength=invoicesToUpdate.resource.count,$scope.invoicesPage=invoicesToUpdate.resource.page,$scope.invoicesPagesCount=Math.ceil(invoicesToUpdate.resource.count/5),$scope.invoicesPerPage=5},updateOrders=function(orders){$scope.orders=orders.resource.invoices,$scope.ordersLength=orders.resource.count,$scope.ordersPage=orders.resource.page,$scope.ordersPagesCount=Math.ceil(orders.resource.count/5),$scope.ordersPerPage=5};updateInvoices(invoices),updateOrders(orders),$scope.changeInvoicesPage=function(page){if(!(page<0||page>$scope.invoicesPagesCount)){var postData=$scope.filterData;postData.invoices_page=page-1,Restangular.one("billings/invoices").get(postData).then(function(data){updateInvoices(data)})}},$scope.changeOrdersPage=function(page){if(!(page<0||page>$scope.ordersPagesCount||page==$scope.ordersPage-1)){var postData=$scope.filterData;postData.orders_page=page-1,Restangular.one("billings/orders").get(postData).then(function(data){updateOrders(data)})}},$scope.downloadInvoice=function(id){Restangular.one("data/download-token").get().then(function(data){var params={token:data.resource.token,id:id};window.location.href="/billings/download-invoice?"+$httpParamSerializer(params)})}}]);