angular.module("callburnApp").controller("SettingsController",["$scope","$rootScope","$state","Restangular","$stateParams","timezones","countries","SettingsService","CountriesDataService","growl","CallBournModal","$location","$interval","$window","$q","$document","$filter",function($scope,$rootScope,$state,Restangular,$stateParams,timezones,countries,SettingsService,CountriesDataService,growl,CallBournModal,$location,$interval,$window,$q,$document,$filter){function isEmpty(obj){if(null==obj)return!0;if(obj.length>0)return!1;if(0===obj.length)return!0;for(var key in obj)if(hasOwnProperty.call(obj,key))return!1;return!0}$scope.openDropdown=$stateParams.openDropdown,$scope.goToNotification=$rootScope.goToNotification,$rootScope.currentPage="dashboard",$rootScope.currentActiveRoute="account",$rootScope.tutorialSidePopup=!1,$scope.showCallerIdInput=[],$scope.editAccountMainSuccessMessage=!1,$scope.editAccountMainErrorMessage=!1,$scope.timezone=timezones.resource.timezones,$scope.timezoneObj=[],$scope.callRoutes=[],$scope.flagImages=[],$scope.selectData=[],$scope.CurrentLanguageIndex=-1,$scope.selectedCallRoute={},$scope.borderStyle={},$scope.startTimer=!1,$scope.defaultClass="default-image-step-1",$scope.timezone.forEach(function(item,index){$scope.timezoneObj[index]={},$scope.timezoneObj[index].value=item}),$rootScope.showNavbar=!0,$scope.notifyMessage=$location.search(),$scope.notifyMessage&&$scope.notifyMessage.email&&growl.success($rootScope.trans("Your_email_address_has_been_updated"),{ttl:-1}),window.document.title=0===$scope.notSeenNotificationsCount?"Settings - Callburn":"("+$scope.notSeenNotificationsCount+") Settings - Callburn",$scope.allCountries=CountriesDataService,$scope.moment=moment,setTimeout(function(){$scope.openDropdown&&(angular.element(document).ready(function(){angular.element(".chosen-container").mousedown()}),angular.element("div.chosen-container-single").addClass("chosen-container chosen-container-single chosen-container-active chosen-with-drop"))},200),Restangular.one("data/current-country").get().then(function(data){$scope.CurrentCountry=data.resource.countryCode}),Restangular.one("data/call-routes").get().then(function(data){$scope.callRoutes=data.resource.routes;for(index in $scope.callRoutes){var newRouteObject={keepAttr:$scope.callRoutes[index],viewText:$scope.callRoutes[index].original_name+"+"+$scope.callRoutes[index].phonenumber_prefix};$scope.selectData.push(newRouteObject),$scope.flagImages.push("/assets/callburn/images/flags/"+$scope.callRoutes[index].code+".svg"),$scope.CurrentCountry==localStorage.getItem("CurrentUserLanguageCode")&&($scope.CurrentLanguageIndex=index)}$scope.CurrentLanguageIndex!=-1&&($scope.defaultClass=""),$scope.selectedCallRoute.route=$scope.callRoutes[$scope.CurrentLanguageIndex]}),$scope.showChangeEmailModal=!1,$scope.updateEmailErrorMessage=!1,$scope.editEmailData={},$scope.editEmail=function(){$rootScope.startLoader(),SettingsService.updateEmail($scope.editEmailData).then(function(data){$rootScope.stopLoader(),0==data.resource.error.no?($scope.showChangeEmailModal=!1,$scope.editAccountMainSuccessMessage="Email has been successfully changed",$scope.editEmailData={}):$scope.updateEmailErrorMessage=data.resource.error.text})},$scope.updatePasswordErrorMessage=!1,$scope.showEditPasswordModal=!1,$scope.editPasswordData={},$scope.editPassword=function(){$rootScope.startLoader(),SettingsService.updatePassword($scope.editPasswordData).then(function(data){$rootScope.stopLoader(),0==data.resource.error.no?($scope.showEditPasswordModal=!1,$scope.editAccountMainSuccessMessage="Password has been successfully changed",$scope.editPasswordData={}):$scope.updatePasswordErrorMessage=data.resource.error.text})},$scope.verificationCall={},$scope.verified=!1;var checkHtmlElement=function(selector){var queue=$q.defer(),timer=$interval(function(){angular.element(selector).length&&($interval.cancel(timer),queue.resolve(angular.element(selector)))},300);return queue.promise};$scope.AddCallerIdModal=function(){CallBournModal.open({scope:{loading:!1,showTimer:!1,addContactData:{},showCallCodeField:!1,verified:$scope.verified,callRoutes:$scope.callRoutes,flagImages:$scope.flagImages,selectData:$scope.selectData,selectedCallRoute:$scope.selectedCallRoute,CurrentLanguageIndex:$scope.CurrentLanguageIndex,defaultClass:"default-image-step-1 default-size",validVerificationCallData:!0,userCountry:["am","es","it"].includes($rootScope.currentUser.country_code)?$rootScope.currentUser.country_code:""},templateUrl:"/app/modals/settings/settings-modal.html"},function(scope){scope.addPrefix=function(){var elem=angular.element("#phone")[0];"+"===elem.value[0]||""===elem.value?null:elem.value="+ "+sessionStorage.getItem("dial")+" "+elem.value},checkHtmlElement("#phone").then(function(element){element.on("countrychange",function(e,countryData){element.value=sessionStorage.getItem("dial")});angular.element("#phone").intlTelInput("getSelectedCountryData");scope.validator=function(){angular.element("#phone").intlTelInput("isValidNumber")?(scope.isValidNumberClass="input-success",scope.validVerificationCallData=!1):(scope.isValidNumberClass="input-error",scope.validVerificationCallData=!0,""===scope.addContactData.phonenumber&&(scope.isValidNumberClass="inp-placeholder"))}}),scope.timer=function(count){var queue=$q.defer(),timer=$interval(function(){scope.counter=count,scope.counter=count--,count<0&&($interval.cancel(timer),queue.resolve())},1e3);return queue.promise},scope.verified=!1,scope.callMade=!1;var finalPhonenumber=!1;scope.getDefaultSelected=function(index){return scope.callRoutes[index]?(scope.defaultClass="",{image:scope.callRoutes[index].code,text:"+"+scope.callRoutes[index].phonenumber_prefix}):{image:"country-icon@2x",text:$rootScope.trans("modals_settings_edit_profile_modal_country")}},scope.selectedNumber=function(){scope.defaultClass="",scope.phonenumberExample=scope.selectedCallRoute.route.phonenumber_example},scope.showNameBtn=!1,scope.AddCallerId=function(){$rootScope.startModalLoader(),$rootScope.disableButton();var requestData={};angular.copy(scope.addContactData,requestData),requestData.phonenumber=finalPhonenumber,requestData.name=scope.addContactData.name,SettingsService.addCallerId(requestData).then(function(data){$rootScope.stopModalLoader(),$rootScope.enabledButton(),0==data.resource.error.no?($scope.reloadUsersData(),scope.showNameBtn=!0,scope.showCodeInput=!1,$scope.lastAddedId=data.resource._id,growl.success(data.resource.error.text)):growl.error(data.resource.error.text)})},scope.showCodeInput=!1,scope.sendVerificationCall=function(){$rootScope.startModalLoader(),$rootScope.disableButton();var addContactData={};"undefined"==typeof scope.selectedCallRoute.route?addContactData.phonenumber=scope.addContactData.phonenumber:addContactData.phonenumber=scope.addContactData.name,scope.loading=!0,SettingsService.sendVerificationCode(addContactData).then(function(data){scope.showCodeInput=!0,$rootScope.socket.on("update-verification-message",function(data){scope.phonenumber_id&&scope.phonenumber_id!=data.message.phonenumber_id||(scope.phonenumber_id=data.message.phonenumber_id,scope.verification_status=data.message.status,"FAILED"==scope.verification_status||"SUCCEED"==scope.verification_status)}),$rootScope.stopModalLoader(),$rootScope.enabledButton(),scope.loading=!1,0==data.resource.error.no?(finalPhonenumber=data.resource.phonenumber,scope.showCallCodeField=!0,scope.verified=!0,scope.callMade=!0):growl.error(data.resource.error.text)})},scope.finishCallerId=function(name){SettingsService.updateCallerId({id:$scope.lastAddedId,name:name}).then(function(data){$scope.reloadUsersData()}),CallBournModal.close()}})},$stateParams.openCallerIdModal&&$scope.AddCallerIdModal(),$scope.removeNumber=function(id){ConfirmDeleteModal().then(function(){$rootScope.startModalLoader(),$rootScope.disableButton(),SettingsService.removeNumber({id:id}).then(function(data){$rootScope.stopModalLoader(),$rootScope.enabledButton(),0==data.resource.error.no?($scope.reloadUsersData(),growl.success(data.resource.error.text)):growl.error(data.resource.error.text)})})},$scope.timezones=timezones.resource.timezones,$scope.countries=countries.resource.countries;var hasOwnProperty=Object.prototype.hasOwnProperty;$scope.editTimezone=function(){var timezone=$rootScope.currentUser.timezone;SettingsService.updateMainData({timezone:timezone}).then(function(data){0==data.resource.error.no&&(Restangular.one("users/show-user").get().then(function(data){isEmpty(data.resource.user_data)?growl.error(data.resource.error.text):($rootScope.currentUser.timezone=timezone,$rootScope.currentUser=data.resource.user_data)}),Restangular.one("users/users-time").get().then(function(timeData){$rootScope.currentTime=timeData.resource.time,$rootScope.currentFullTime=timeData.resource.time}))})},$scope.editMainDetailsModal=function(){CallBournModal.open({scope:{userEditableData:{company_name:$rootScope.currentUser.company_name,email:$rootScope.currentUser.email,vat:$rootScope.currentUser.vat,address:$rootScope.currentUser.address,timezone:$rootScope.currentUser.timezone,language_id:$rootScope.currentUser.language_id,country_code:$rootScope.currentUser.country_code,postal_code:$rootScope.currentUser.postal_code,city:$rootScope.currentUser.city,city_id:$rootScope.currentUser.city_id?$rootScope.currentUser.city_id:null,birthday:$rootScope.currentUser.birthday,personal_name:$rootScope.currentUser.personal_name,email_confirmation:null,new_password_confirmation:null,country:[],facebook_email:$rootScope.currentUser.facebook_email,gmail_email:$rootScope.currentUser.gmail_email,github_email:$rootScope.currentUser.github_email,newsletter_email:$rootScope.currentUser.newsletter_email},countries:$scope.allCountries,cities:[],backgroundProcess:!1,errorClass:"input-error",passErrClass:"input-error",passEditCollapse:!0,newsletter_email:$rootScope.currentUser.newsletter_email,social_mails:$rootScope.currentUser.social_mails,socialAccaunt:$rootScope.currentUser.social,userCityName:{name:""}},templateUrl:"/app/modals/settings/edit-profile-modal.html"},function(scope){scope.checkTitle=function(lettersTyped){lettersTyped.length>=2?scope.limitTitleSearch=50:scope.limitTitleSearch=0},scope.citySearchChecker=function(input){return angular.isUnDefined(input)||null==input?[]:input.length<2?[]:void 0},scope.passEditCollapseDisable=function(){scope.socialAccaunt||(scope.passEditCollapse=!scope.passEditCollapse)},scope.userEditableData.birthday=scope.userEditableData.birthday?new Date(new Date(scope.userEditableData.birthday)):null,scope.maxInputDate=moment().format("YYYY-MM-DD"),scope.socialConnectionEmails=[];var socialEmails=scope.social_mails;socialEmails.forEach(function(email){scope.socialConnectionEmails.push({selectView:email,showView:email})}),scope.changeNewslatterEmail=function(email){scope.userEditableData.newsletter_email=email},scope.editMainDetails=function(){scope.backgroundProcess=!0,scope.userEditableData.birthday||(scope.userEditableData.birthday=null),SettingsService.updateMainData(scope.userEditableData).then(function(data){0==data.resource.error.no?(scope.userEditableData.email==scope.userEditableData.email_confirmation&&""!=scope.userEditableData.email_confirmation&&growl.success($rootScope.trans("A_change_email_address_confirmation_was_sent"),{ttl:-1}),$rootScope.languages.forEach(function(lang){lang._id==scope.userEditableData.language_id&&($rootScope.currentLanguage=lang.code,$rootScope.currentLanguageName=lang.name)}),Restangular.one("users/show-user").get().then(function(data){data.resource.user_data?(growl.success(data.resource.error.text),scope.backgroundProcess=!1,CallBournModal.close()):(scope.backgroundProcess=!1,growl.error(data.resource.error.text))})):(scope.backgroundProcess=!1,growl.error(data.resource.error.text),$scope.editAccountMainErrorMessage=data.resource.error.text),$scope.reloadUsersData()})};var liveDate;scope.$watch("userEditableData.birthday",function(value){try{liveDate=new Date(value)}catch(e){console.log(e)}isNaN(liveDate)?(scope.dateError=!0,scope.dateErrClass="edit-date-error"):(scope.dateError=!1,scope.dateErrClass="")}),scope.emailConfirmationChecker=function(){scope.userEditableData.email==scope.userEditableData.email_confirmation?(scope.errorClass="input-success",scope.emailErrMessage=$rootScope.trans("confirm_email_is_correct")):(scope.errorClass="input-error",scope.userEditableData.email_confirmation?(scope.emailErrMessage=$rootScope.trans("confirm_emails_are_not_match"),console.log("not match")):(scope.emailErrMessage=$rootScope.trans("confirm_email_could_not_be_blank"),console.log("should not be blank")))},scope.passwordConfirmationChecker=function(){scope.userEditableData.new_password==scope.userEditableData.new_password_confirmation?(scope.passErrClass="input-success",scope.passErrMessage=$rootScope.trans("confirm_password_is_correct")):(scope.passErrClass="input-error",scope.userEditableData.new_password_confirmation?(scope.passErrMessage=$rootScope.trans("confirm_password_are_not_match"),console.log("not match")):(scope.passErrMessage=$rootScope.trans("confirm_password_could_not_be_blank"),console.log("should not be blank")))},scope.countryChanged=function(country){scope.userEditableData.country_code=country[1],$rootScope.currentUser.country_code=country[1],scope.userEditableData.country=country,$rootScope.currentUser.country=country},scope.countryShow=!1,scope.setInputFocusCountry=function(){scope.countryShow=!0},scope.open1=function(){scope.popup1.opened=!0},scope.popup1={opened:!1},$(document).on("click",function(e){$(e.target).is(".one-span-is-blue .ui-select-container")===!1&&$(e.target).is(".ui-select-container .ui-select-match")===!1&&$(e.target).is(".ui-select-container input")===!1&&$(e.target).is(".ui-select-container span")===!1&&(1==scope.countryShow&&(scope.countryShow=!1),1==scope.cityShow&&(scope.cityShow=!1))})})},$scope.updateNewsletterSubscription=function(newsLeter){var postData={};postData.send_newsletter=newsLeter?"1":"0",SettingsService.updateMainData(postData).then(function(data){0==data.resource.error.no?($scope.reloadUsersData(),newsLeter?growl.success(data.resource.error.text):growl.success(trans("you're_unsubscribed"))):growl.error(data.resource.error.text)})},$scope.reloadUsersData=function(){SettingsService.getShowUser().then(function(data){data.resource.user_data&&($rootScope.currentUser=data.resource.user_data)})},$scope.removeToken=function(id){ConfirmDeleteModal().then(function(){SettingsService.removeById(id).then(function(data){$scope.reloadUsersData()})})},$scope.showEditNameInput=function(callerId){callerId.editNameInput=!callerId.editNameInput,setTimeout(function(){angular.element("#change-callerId-name").select()},100)},$scope.callerIdNameValidator=function(callerId){$scope.$watch("",function(){callerId.name?$scope.errClass="":$scope.errClass="input-error animated swing"})},$scope.changeCallerIdName=function(callerId){""!=callerId.name&&SettingsService.updateCallerId({id:callerId._id,name:callerId.name}).then(function(data){if(0===data.resource.error.no)for(index in $scope.currentUser.numbers)if($scope.currentUser.numbers[index]._id===callerId._id){$scope.currentUser.numbers[index].name=callerId.name,$scope.showCallerIdInput[callerId._id]=!1;break}callerId.editNameInput=!1})},$scope.connectFacebook=function(){var url=window.location.origin+"/social/facebook-login?connect=1&jwtToken="+localStorage.jwtToken,width=800,height=800,left=screen.width/2-width/2,top=screen.height/2-height/2,facebookWindow=window.open(url,"Connect facebook account","height="+height+",width="+width+",top="+top+",left="+left),interval=setInterval(function(){try{"success"==facebookWindow.success?(clearInterval(interval),facebookWindow.is_registration&&"function"==typeof ga&&ga("send","event","User","SIGNUP",{hitCallback:function(){}})):"deactivated"==facebookWindow.success?($scope.accountDeactivated=!0,$scope.showInvalidLogin=!0):"error"==facebookWindow.success&&($scope.errors=[["Validator failed . Please contact support."]])}catch(err){console.log(err)}},1e3)},$scope.connectGoogle=function(){var url=window.location.origin+"/social/google-login?connect=1&jwtToken="+localStorage.jwtToken,width=800,height=800,left=screen.width/2-width/2,top=screen.height/2-height/2,googleWindow=window.open(url,"Connect google account","height="+height+",width="+width+",top="+top+",left="+left),interval=setInterval(function(){try{"success"==googleWindow.success?(clearInterval(interval),googleWindow.is_registration&&"function"==typeof ga&&ga("send","event","User","SIGNUP",{hitCallback:function(){}})):"deactivated"==googleWindow.success?($scope.accountDeactivated=!0,$scope.showInvalidLogin=!0):"error"==googleWindow.success&&($scope.errors=[["Validator failed . Please contact support."]])}catch(err){}},1e3)},$scope.connectGitHub=function(){var url=window.location.origin+"/social/github-login?connect=1&jwtToken="+localStorage.jwtToken,width=800,height=800,left=screen.width/2-width/2,top=screen.height/2-height/2,githubLogin=window.open(url,"Connect google account","height="+height+",width="+width+",top="+top+",left="+left),interval=setInterval(function(){try{"success"==githubLogin.success?(clearInterval(interval),githubLogin.is_registration&&"function"==typeof ga&&ga("send","event","User","SIGNUP",{hitCallback:function(){}})):"deactivated"==githubLogin.success?($scope.accountDeactivated=!0,$scope.showInvalidLogin=!0):"error"==githubLogin.success&&($scope.errors=[["Validator failed . Please contact support."]])}catch(err){}},1e3)},$scope.deleteAccount=function(){CallBournModal.open({scope:{},templateUrl:"/app/modals/confirm/delete-account.html"},function(scope){scope.deleteData={user_id:$rootScope.currentUser._id,currentPassword:""},scope.deleteConfirmation=function(){Restangular.all("users/delete-account").post(scope.deleteData).then(function(data){1==data.resource.code?$rootScope.logOut():1!=data.resource.status&&growl.error(data.resource.error)})}})}}]);