angular.module("callburnApp").controller("ComposeStep2Controller",["$scope","$rootScope","$q","Restangular","notify","FileUploader","$stateParams","CampaignComposeService","CampingService","$timeout","growl","ContactsService","GroupsService","$interval",function($scope,$rootScope,$q,Restangular,notify,FileUploader,$stateParams,CampaignComposeService,CampingService,$timeout,growl,ContactsService,GroupsService,$interval){CampaignComposeService.campaignData.currentTab="groups",$rootScope.currentTab="groups",$scope.CampaignComposeService=CampaignComposeService,$rootScope.tutorialSidePopup=!1,window.currentUrlHash=window.location.hash.indexOf("compose"),$scope.filteredData={},$scope.filtereGroupdData={},CampaignComposeService.canGoToStep3=!1,$rootScope.checkedGroups={},$scope.checkedGroupsName={},$scope.activeTab=1,$scope.disableManually=!1,$scope.addNumbersManually={},$scope.tagPhonenumbers=[],$scope.invalidPhoneNumbers=[],$scope.contactsPassingValidation=!1,$scope.showCurrentGroupContacts=!1,$scope.showContactsOfGroup=!1,$scope.copyPasteContacts=!1,$scope.showGroupsSpinner=!1,$scope.manuallyPhonenumbersCount=0;var canGoToStep3From={};$scope.percent=0,CampaignComposeService.finalStepData.recipientsCounterLoader=!1,$scope.checkInArray=function(array,id){return array.indexOf(id)>-1};var applyTranslations=function(){$scope.isLoaded=!1,setTimeout(function(){$scope.isLoaded=!0},100),$scope.tagPlacholdersText=$rootScope.trans("add_phonenumber")};$rootScope.$watch("isLangLoaded",applyTranslations);var abortRequest,finalValidationForStep3=function(data){CampaignComposeService.fileNotExist=!1,$scope.contactsPassingValidation=!1,CampaignComposeService.finalStepData.maxCost=data.resource.max_cost+data.resource.max_gift_cost,CampaignComposeService.finalStepData.sendingTime=data.resource.sending_time,CampaignComposeService.campaignData.max_cost=data.resource.max_cost,CampaignComposeService.finalStepData.maxCostWithSms=data.resource.max_cost_with_sms,CampaignComposeService.campaignData.max_gift_cost=data.resource.max_gift_cost,"sms"!=$rootScope.selectedType&&"vmSms"!=$rootScope.selectedType||(data.resource.sms_not_supported>0&&data.resource.sms_not_supported==CampaignComposeService.finalStepData.numbersCount?(CampaignComposeService.finalStepData.maxCostWithSms=0,CampaignComposeService.finalStepData.maxCost=0):data.resource.sms_not_supported>0&&data.resource.sms_not_supported!=CampaignComposeService.finalStepData.numbersCount&&growl.info(data.resource.sms_not_supported+" "+$rootScope.trans("not_supported_contacts"))),"groups"===CampaignComposeService.campaignData.currentTab?CampaignComposeService.finalStepData.numbersCount=data.resource.recipients_count:data.resource.phonenumbers&&(CampaignComposeService.finalStepData.numbersCount=data.resource.phonenumbers.length,CampaignComposeService.campaignData.phonenumbers=data.resource.phonenumbers),$rootScope.stopLoader(),"groups"===CampaignComposeService.campaignData.currentTab&&0==data.resource.recipients_count||"groups"!==CampaignComposeService.campaignData.currentTab&&data.resource.phonenumbers&&0==data.resource.phonenumbers.length?(CampaignComposeService.composeStep3=!1,canGoToStep3From[CampaignComposeService.campaignData.currentTab]=!1):(CampaignComposeService.composeStep3=!0,canGoToStep3From[CampaignComposeService.campaignData.currentTab]=!0),CampaignComposeService.finalStepData.numbersCount="recipients_count"in data.resource?data.resource.recipients_count:data.resource.phonenumbers.length,CampaignComposeService.finalStepData.recipientsCounterLoader=!1};$rootScope.postData={},$rootScope.dataForCostCalculation={},$rootScope.goToStep3=function(){switch(abortRequest&&abortRequest.resolve(),abortRequest=$q.defer(),CampaignComposeService.composeStep3=!1,CampaignComposeService.finalStepData.recipientsGroupNames=!1,CampaignComposeService.campaignData.currentTab||$rootScope.currentTab){case"manually":$scope.recipientsActiveTab=2,$rootScope.postData=[];for(index in $scope.manuallyAddedNumbers)$scope.manuallyAddedNumbers[index].phone_no?$rootScope.postData.push($scope.manuallyAddedNumbers[index].phone_no):$scope.manuallyAddedNumbers[index].number&&$rootScope.postData.push("+"+$scope.manuallyAddedNumbers[index].number);break;case"contacts":$rootScope.postData=$scope.checkedContacts;break;case"groups":$scope.recipientsActiveTab=1,$rootScope.postData=$rootScope.checkedGroups,$rootScope.checkedGroups.all?CampaignComposeService.campaignData.all_contacts=!0:CampaignComposeService.campaignData.all_contacts=!1,CampaignComposeService.campaignData.selected_groups=$rootScope.checkedGroups;var groupsToCheck=[];for(index in $rootScope.checkedGroups)if($rootScope.checkedGroups[index])for(groupIndex in $scope.groups)$scope.groups[groupIndex]._id===index&&groupsToCheck.push($scope.groups[groupIndex]);groupsToCheck.length>1?CampaignComposeService.finalStepData.recipientsGroupNames=groupsToCheck.length+" "+$rootScope.trans("campaign_compose_compose_step_3_recipients_groups")+" - ":groupsToCheck[0]&&(CampaignComposeService.finalStepData.recipientsGroupNames=groupsToCheck[0].name+" - ")}var keyWord="groups";"groups"!==CampaignComposeService.campaignData.currentTab&&"manually"!==CampaignComposeService.campaignData.currentTab||(keyWord=CampaignComposeService.campaignData.currentTab),$rootScope.dataForCostCalculation={file_id:CampaignComposeService.campaignData.campaign_voice_file_id,data:$rootScope.postData,all_contacts:CampaignComposeService.campaignData.all_contacts,type:CampaignComposeService.campaignData.type,sms_text:CampaignComposeService.campaignData.sms_text},Restangular.all("phonenumbers/add-numbers-and-calculate-cost-"+keyWord).withHttpConfig({timeout:abortRequest.promise}).post($rootScope.dataForCostCalculation).then(function(data){0===data.resource.error.no&&0===data.resource.max_cost?(keyWord="manually","groups"!=CampaignComposeService.campaignData.currentTab&&"manually"!=CampaignComposeService.campaignData.currentTab||(keyWord=CampaignComposeService.campaignData.currentTab),Restangular.all("phonenumbers/add-numbers-and-calculate-cost-"+keyWord).withHttpConfig({timeout:abortRequest.promise}).post($rootScope.dataForCostCalculation).then(function(secondRequestData){finalValidationForStep3(secondRequestData)})):finalValidationForStep3(data)})};var setPhonemumbers=function(phonenumbers){CampaignComposeService.campaignData.currentTab="manually",$scope.manuallyAddedNumbers=phonenumbers,phonenumbers.forEach(function(item){var tag={text:item.phone_no,success:!0};$scope.tagPhonenumbers.push(tag)})};if(CampaignComposeService.editingCampaign){if(CampaignComposeService.editingCampaign.phonenumbers.length){CampaignComposeService.editingCampaign.phonenumbers.slice()}else CampaignComposeService.editingCampaign.should_use_all_contacts?(CampaignComposeService.campaignData.currentTab="groups",$rootScope.currentTab="groups",$rootScope.checkedGroups.all=!0,$rootScope.goToStep3()):CampaignComposeService.editingCampaign.groups.length&&(CampaignComposeService.campaignData.currentTab="groups",$rootScope.currentTab="groups",CampaignComposeService.editingCampaign.groups.forEach(function(item){$rootScope.checkedGroups[item._id]=!0}));$rootScope.goToStep3()}else CampaignComposeService.reusingCampaign&&(CampaignComposeService.reusingCampaign.phonenumbers.length&&!CampaignComposeService.reusingCampaign.groups.length||(CampaignComposeService.reusingCampaign.should_use_all_contacts?(CampaignComposeService.campaignData.currentTab="groups",$rootScope.currentTab="groups",$rootScope.checkedGroups.all=!0,$rootScope.goToStep3()):CampaignComposeService.reusingCampaign.groups.length&&(CampaignComposeService.campaignData.currentTab="groups",$rootScope.currentTab="groups",CampaignComposeService.reusingCampaign.groups.forEach(function(item){$rootScope.checkedGroups[item._id]=!0}))),$rootScope.goToStep3());$stateParams.group_ids&&(CampaignComposeService.campaignData.currentTab="groups",$rootScope.currentTab="groups",$rootScope.checkedGroups=$stateParams.group_ids,$rootScope.goToStep3()),$stateParams.contact_ids&&(setPhonemumbers($stateParams.contact_ids),$rootScope.goToStep3()),"receipents"===$stateParams.reusing_source&&(CampaignComposeService.reusingCampaign.groups.length>0?(CampaignComposeService.campaignData.currentTab="groups",$rootScope.currentTab="groups"):(CampaignComposeService.campaignData.currentTab="manually",$rootScope.currentTab="manually")),$scope.$watch("CampaignComposeService.finalStepData.voiceFile",function(newValue){$rootScope.goToStep3()},!0);var tagPhoneNumbersToString=function(){var final="";$scope.tagPhonenumbers.forEach(function(item){final+=item.text+","}),final=final.replace(/;/g,",").replace(/\r\n/g,",").replace(/\n/g,",").replace(/\r/g,",").replace(/-/g,","),final=final.substring(0,final.length-1),final=final.split(",");for(var stillHasSpaces=!0;stillHasSpaces;){stillHasSpaces=!1;for(var i=0;i<final.length;i++){if(final[i].length<=5&&final[i+1]){final[i]+=final[i+1],final.splice(i+1,1),stillHasSpaces=!0;break}parseInt(final[i])||final.splice(i,1)}}return final};$scope.removeAllManuallyPhonenumbers=function(){CampaignComposeService.campaignData.currentTab="manually",$rootScope.currentTab="manually",$scope.tagPhonenumbers=[],$rootScope.postData={is_campaign_create:!0,data:[]},$scope.validatePhoneNumbers($rootScope.postData,!1)},$scope.removeAllInvalidManuallyPhonenumbers=function(){var successes=[];$scope.tagPhonenumbers.forEach(function(number){number.success&&successes.push(number)}),$scope.tagPhonenumbers=successes};var abortRequest,addAndValidatePhonenumbers=function(allPhonenumbers){$rootScope.postData={is_campaign_create:!0,data:allPhonenumbers},$scope.validatePhoneNumbers($rootScope.postData,!0)};$scope.validatePhoneNumbers=function(postData,forAddPhonenumbers){abortRequest&&abortRequest.resolve(),abortRequest=$q.defer(),$scope.showManuallyAddedSpinner=!0,postData.file_id=CampaignComposeService.campaignData.campaign_voice_file_id,postData.all_contacts=CampaignComposeService.campaignData.all_contacts,postData.type=CampaignComposeService.campaignData.type,postData.sms_text=CampaignComposeService.campaignData.sms_text,CampaignComposeService.campaignData.currentTab="manually",$rootScope.currentTab="manually",$scope.manuallyPhonenumbersCount=0,CampingService.addNumbersAndCalculateCostManually(abortRequest,postData).then(function(data){var validatedPhoneNumbers=data.resource.statuses;data.resource.max_gift_cost>0?CampaignComposeService.campaignData.is_gift_being_used=!0:CampaignComposeService.campaignData.is_gift_being_used=!1,forAddPhonenumbers&&validatedPhoneNumbers.forEach(function(item){var currentNum=item.number,tag={text:currentNum};"success"===item.status?($scope.manuallyPhonenumbersCount++,tag.success=!0):tag.success=!1,$scope.tagPhonenumbers.push(tag)}),$scope.manuallyAddedNumbers=validatedPhoneNumbers,$scope.manuallyPhonenumbersCount=$scope.manuallyAddedNumbers.length,$scope.showManuallyAddedSpinner=!1,finalValidationForStep3(data)})},$scope.checkValidTag=function(tag){return tag.success},$scope.addNumbers=function(tag){$scope.allPhonenumbers=tagPhoneNumbersToString(),$scope.allPhonenumbersLength=$scope.allPhonenumbers.length,$scope.tagPhonenumbers=[],$scope.allPhonenumbers.length<=500?(addAndValidatePhonenumbers($scope.allPhonenumbers),$scope.moreThen500=!1):$scope.moreThen500=!0},$scope.removeNumbers=function(tag){var index=$scope.invalidPhoneNumbers.indexOf(tag.text);index>-1&&$scope.invalidPhoneNumbers.splice(index,1);var allPhonenumbers=tagPhoneNumbersToString();$rootScope.postData={is_campaign_create:!0,data:allPhonenumbers},$scope.validatePhoneNumbers($rootScope.postData,!1)},$scope.checkedContacts={};var checkedUncheckContact=function(contactId){$scope.checkedContacts[contactId]=!$scope.checkedContacts[contactId]||!$scope.checkedContacts[contactId],$rootScope.goToStep3()},checkedUncheckGroup=function(groupId){return groupId in $rootScope.checkedGroups?($rootScope.checkedGroups[groupId]=!$rootScope.checkedGroups[groupId],void $rootScope.goToStep3()):void($rootScope.checkedGroups[groupId]=!0)},showMoreSelectBox=!1;$scope.showGroupsTableLoader=!0,new Promise(function(resolve,reject){return!CampaignComposeService.editingCampaign||CampaignComposeService.editingCampaign&&"saved"==CampaignComposeService.editingCampaign.status?Restangular.one("address-book/index-groups").get({fromCompose:!0}).then(function(data){return resolve(data)})["catch"](function(error){return reject(error)}):resolve(CampaignComposeService.tableData)}).then(function(groupsResponse){!CampaignComposeService.editingCampaign||CampaignComposeService.tableData||CampaignComposeService.checkIfAlreadyStarted()||"saved"===CampaignComposeService.editingCampaign.status||($scope.activeTab=2,$scope.disableManually=!0),$scope.phoneBookData=new GroupsService(groupsResponse,null,$rootScope.checkedGroups,showMoreSelectBox,(!1),CampaignComposeService.editingCampaign&&CampaignComposeService.checkIfAlreadyStarted()),$rootScope.checkedGroups=$scope.phoneBookData.checkedGroups,$rootScope.phoneBookData=$scope.phoneBookData,$scope.showGroupsTableLoader=!1,$scope.phoneBookData.groupsData.allContactsCount||($scope.recipientsActiveTab=2);var checkedUncheckGroupName=function(name){name in $scope.checkedGroupsName?delete $scope.checkedGroupsName[name]:$scope.checkedGroupsName[name]=!0,CampaignComposeService.campaignData.group_name=Object.keys($scope.checkedGroupsName)[0]};$scope.phoneBookData.choiceOrRemove=function(object,key,name){CampaignComposeService.editingCampaign&&"saved"!=CampaignComposeService.editingCampaign.status||(CampaignComposeService.campaignData.currentTab="groups",$rootScope.currentTab="groups",checkedUncheckGroup(key),checkedUncheckGroupName(name),CampaignComposeService.finalStepData.recipientsCounterLoader=!0,$rootScope.goToStep3(),$rootScope.step1Arrow||($rootScope.step1Arrow=!0,$rootScope.arrowHelper=!0,$rootScope.step1Arrow&&$rootScope.step2Arrow&&($rootScope.nextArrowHelper=!0,$rootScope.step1Arrow=!1,$rootScope.arrowHelper=!1,$rootScope.nextArrow())))},$scope.phoneBookData.goToGroupPage=function($event,group){if(!CampaignComposeService.editingCampaign){$scope.showGroupsSpinner=!0,$rootScope.showWaitLightBox();var id=group._id;if(group.contact_count[0].count){var tag=$event.target.nodeName.toLowerCase();if("input"!==tag&&"label"!==tag){var getData={group_id:id};CampingService.getContacts(getData).then(function(data){$scope.showCurrentGroupContacts=!0,$scope.recipientsActiveTab=1,$scope.contactsService=new ContactsService(data,(!1),CampaignComposeService.editingCampaign),CampaignComposeService.campaignData.currentTab="contacts",$rootScope.currentTab="contacts",$scope.showGroupsSpinner=!1,$rootScope.hideWaitLightBox(),$rootScope.checkedGroups[id]&&($scope.contactsService.selectAllContacts(!0),$scope.contactsService.disableSelectAll=!0),$scope.contactsService.selectOrRemoveContact=function(selectedContacts,contact){ContactsService.prototype.selectOrRemoveContact.call(this,selectedContacts,contact),checkedUncheckContact(contact._id)},$scope.contactsService.backToPhonebook=function(){CampaignComposeService.campaignData.currentTab="groups",$rootScope.currentTab="groups",$scope.checkedContacts={},$scope.showCurrentGroupContacts=!1,$rootScope.goToStep3()}})}}}}})["catch"](function(){}),$scope.qrUrl="",$scope.loadingQr=!0,Restangular.one("address-book/mobile-contacts").get().then(function(data){0===data.resource.error.no&&($scope.loadingQr=!1,$scope.qrUrl="https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl="+data.resource.token+"&choe=UTF-8")}),$scope.initTable=function(){setTimeout(function(){$rootScope.phoneBookData?$rootScope.phoneBookData.tableInit():null},2e3)},$scope.tableOverlay=!0,$scope.hideTableOverlay=function(){$scope.tableOverlay=!1}}]);