angular.module("callburnApp").controller("ComposeController",["$scope","$rootScope","$state","Restangular","$stateParams","ttsLanguages","notify","$sce","$timeout","audioFiles","smsFiles","editingCampaign","reusingCampaign","CampaignComposeService","CallBournScrollTop","$location",function($scope,$rootScope,$state,Restangular,$stateParams,ttsLanguages,notify,$sce,$timeout,audioFiles,smsFiles,editingCampaign,reusingCampaign,CampaignComposeService,CallBournScrollTop,$location){$rootScope.fileIdErr=!1,$rootScope.smsTextErr=!1,$rootScope.recipientsErr=!1,$rootScope.hideAllArrows=!1,$rootScope.$watch("currentLanguage",function(){$scope.formUrl="/assets/scrollableForm"+$rootScope.currentLanguage+".html"});var windowVar=setInterval(function(){window.goToCompose&&(window.goToCompose=!1,$state.go("campaign.compose",{hideScrollableForm:!0}),clearInterval(windowVar))},400),windowApi=setInterval(function(){window.goToApi&&(window.goToApi=!1,$state.go("api.settings"),clearInterval(windowApi))},400),windowForm=setInterval(function(){window.formFinish&&(window.formFinish=!1,window.$crisp.push(["do","message:show",["text","Roberto put your data here"]]),window.$crisp.push(["do","message:send",["text",window.formData]]),clearInterval(windowForm))},400);$stateParams.hideScrollableForm||editingCampaign||reusingCampaign||($scope.showScrollableForm=!0),$stateParams.hide_all_arrows===!0&&($rootScope.hideAllArrows=!0),$scope.html="",editingCampaign&&editingCampaign.resource.error&&0!==editingCampaign.resource.error.no&&$state.go("campaign.overview"),localStorage.removeItem("isplaybackConfirmed"),$rootScope.tutorialSidePopup=!1,$rootScope.arrowHelper=!0,$rootScope.nextArrowHelper=!1,$rootScope.step1Arrow=!1,$rootScope.step2Arrow=!1,$scope.hideArrowHelper=function(){$rootScope.arrowHelper=!1,$rootScope.nextArrowHelper=!1},$rootScope.nextArrow=function(){$rootScope.nextArrowHelper=!0,$rootScope.step1Arrow=!1},$rootScope.currentActiveRoute="campaign",$scope.availableTts={"Alice-ML":!0,"Anna-ML":!0,Daniel:!0,Ellen:!0,Empar:!0,Joana:!0,Jordi:!0,Lekha:!0,Milena:!0,Monica:!0,Paulina:!0,Samantha:!0,Satu:!0,Tarik:!0,Thomas:!0,Zosia:!0},CampaignComposeService.clearComposeData(),$scope.tabs=[{active:!1},{active:!1},{active:!1}],$scope.paginationMaxSize=5,CampaignComposeService.canGoToStep2=!1;var copyOfCampaignService={};angular.copy(CampaignComposeService,copyOfCampaignService),$scope.$on("$destroy",function(){angular.copy(copyOfCampaignService,CampaignComposeService)}),CampaignComposeService.audioTemplates=audioFiles.resource,CampaignComposeService.smsTemplates=smsFiles.resource,$scope.CampaignComposeService=CampaignComposeService,$scope.CampaignComposeService.ttsLanguages=ttsLanguages.resource.languages,$scope.CampaignComposeService.audioTemplates=audioFiles.resource,$scope.CampaignComposeService.smsTemplates=smsFiles.resource;var addPhonenumbersToFinalStep=function(campaign){var campaignNumbers=campaign.phonenumbers;for(index in campaignNumbers)CampaignComposeService.campaignData.phonenumbers.push(campaignNumbers[index].phone_no),CampaignComposeService.step2Phonenumbers.push({number:campaignNumbers[index].phone_no,status:"success",tariff:campaignNumbers[index].tariff});CampaignComposeService.step2PhonenumbersPagesCount=Math.ceil(campaignNumbers.length/7)};if(reusingCampaign){CampaignComposeService.reusingCampaign=reusingCampaign.resource.campaign,CampaignComposeService.isEdit=!0,CampaignComposeService.campaignData.remaining_repeats=0,CampaignComposeService.campaignData.repeat_days_interval=7,$scope.getPlaybackCount=function(count){return CampaignComposeService.campaignData.playback_count==count},reusingCampaign=reusingCampaign.resource.campaign,$rootScope.currentUser.numbers[0]&&(CampaignComposeService.campaignData={caller_id:reusingCampaign.caller_id,get_email_notifications:!0,phonenumbers:[]});var reusingSource=$scope.reusingSource=$stateParams.reusing_source;"message"==reusingSource&&($stateParams.tab=3,CampaignComposeService.finalStepData.voiceFile=reusingCampaign.voice_file,CampaignComposeService.campaignData.voice_file=reusingCampaign.voice_file,CampaignComposeService.campaignData.campaign_voice_file_id=reusingCampaign.voice_file._id,CampaignComposeService.campaignData.campaign_name="",CampaignComposeService.composeStep1=!0,CampaignComposeService.composeStep2=!0),"receipents"==reusingSource&&($stateParams.tab=1,CampaignComposeService.finalStepData.numbersCount=reusingCampaign.phonenumbers.length,CampaignComposeService.finalStepData.maxCost=reusingCampaign.retained_balance+reusingCampaign.retained_gift_balance,CampaignComposeService.finalStepData.maxCostWithSms=reusingCampaign.max_cost_with_sms,CampaignComposeService.campaignData.campaign_name="",CampaignComposeService.composeStep1=!0,addPhonenumbersToFinalStep(reusingCampaign)),"both"==reusingSource&&($stateParams.tab=3,CampaignComposeService.finalStepData.voiceFile=reusingCampaign.voice_file,CampaignComposeService.campaignData.voice_file=reusingCampaign.voice_file,CampaignComposeService.campaignData.campaign_name="",CampaignComposeService.campaignData.selected_groups=reusingCampaign.groups,reusingCampaign.voice_file&&(CampaignComposeService.campaignData.campaign_voice_file_id=reusingCampaign.voice_file._id),CampaignComposeService.campaignData={campaign_id:reusingCampaign._id,callback_digit:reusingCampaign.callback_digit,callback_voice_file_id:reusingCampaign.callback_digit_file_id,callback_file:reusingCampaign.callback_file,caller_id:reusingCampaign.caller_id,campaign_name:reusingCampaign.campaign_name,campaign_voice_file_id:reusingCampaign.campaign_voice_file_id,do_not_call_digit:reusingCampaign.do_not_call_digit,do_not_call_voice_file_id:reusingCampaign.do_not_call_digit_file_id,get_email_notifications:reusingCampaign.get_email_notifications,replay_digit:reusingCampaign.replay_digit,timezone:reusingCampaign.timezone,live_transfer_limit:reusingCampaign.live_transfer_limit,transfer_digit:reusingCampaign.transfer_digit,transfer_options:reusingCampaign.transfer_options,user_id:reusingCampaign.user_id,voice_file:reusingCampaign.voice_file,schedulations:null,playback_count:reusingCampaign.playback_count,live_answer_only:Boolean(reusingCampaign.live_answer_only),sending_time:reusingCampaign.delivery_speed,remaining_repeats:reusingCampaign.remaining_repeats,repeat_days_interval:reusingCampaign.repeat_days_interval,max_cost:reusingCampaign.retained_balance,maxCostWithSms:reusingCampaign.max_cost_with_sms,max_gift_cost:reusingCampaign.retained_gift_balance,phonenumbers:[],previews:reusingCampaign.previews,schedulation_original_data:null,uploadetAudioFile:reusingCampaign.audio_amazon_s3,sender_name:reusingCampaign.sender_name,should_shuffle:reusingCampaign.should_shuffle,type:reusingCampaign.type,sms_text:reusingCampaign.sms_text,same_sms_text:reusingCampaign.same_sms_text},reusingSource&&(CampaignComposeService.campaignData.campaign_name=""),CampaignComposeService.chosedInteractions=[reusingCampaign.replay_digit,reusingCampaign.transfer_digit,reusingCampaign.callback_digit,reusingCampaign.do_not_call_digit],CampaignComposeService.replayDigit.onOff=null!=reusingCampaign.replay_digit,CampaignComposeService.transferDigit.onOff=null!=reusingCampaign.transfer_digit,CampaignComposeService.callbackDigit.onOff=null!=reusingCampaign.callback_digit,CampaignComposeService.doNotCallDigit.onOff=null!=reusingCampaign.do_not_call_digit,CampaignComposeService.finalStepData.numbersCount=reusingCampaign.phonenumbers.length,CampaignComposeService.finalStepData.maxCost=reusingCampaign.retained_balance+reusingCampaign.retained_gift_balance,CampaignComposeService.composeStep1=!0,CampaignComposeService.composeStep2=!0,CampaignComposeService.composeStep3=!0,$stateParams.without_recipients?(CampaignComposeService.campaignData.selected_groups=[],CampaignComposeService.campaignData.phonenumbers=[],CampaignComposeService.reusingCampaign.groups=[],CampaignComposeService.reusingCampaign.phonenumbers=[]):addPhonenumbersToFinalStep(reusingCampaign))}else if(editingCampaign){$stateParams.disableArrowHelper&&($scope.arrowHelper=!1,$scope.nextArrowHelper=!1),CampaignComposeService.isEdit=!0;var editingCampaign=editingCampaign.resource.campaign;editingCampaign&&editingCampaign.groups&&editingCampaign.groups.length&&(CampaignComposeService.tableData={resource:{groups:editingCampaign.groups,allContactsCount:editingCampaign.groups.length,count:editingCampaign.groups.length,allGroupsCount:editingCampaign.groups.length,lastAddedContactDate:{_id:1},error:{no:0,text:""}}}),CampaignComposeService.editingCampaign=editingCampaign,editingCampaign&&editingCampaign.groups&&(CampaignComposeService.campaignData.selected_groups=editingCampaign.groups),CampaignComposeService.campaignData={campaign_id:editingCampaign._id,callback_digit:editingCampaign.callback_digit,callback_voice_file_id:editingCampaign.callback_digit_file_id,callback_file:editingCampaign.callback_file,caller_id:editingCampaign.caller_id,campaign_name:editingCampaign.campaign_name,campaign_voice_file_id:editingCampaign.campaign_voice_file_id,do_not_call_digit:editingCampaign.do_not_call_digit,do_not_call_voice_file_id:editingCampaign.do_not_call_digit_file_id,get_email_notifications:editingCampaign.get_email_notifications,replay_digit:editingCampaign.replay_digit,timezone:editingCampaign.timezone,live_transfer_limit:editingCampaign.live_transfer_limit,transfer_digit:editingCampaign.transfer_digit,transfer_options:editingCampaign.transfer_options,user_id:editingCampaign.user_id,voice_file:editingCampaign.voice_file,schedulations:editingCampaign.schedulations,playback_count:editingCampaign.playback_count,live_answer_only:Boolean(editingCampaign.live_answer_only),sending_time:editingCampaign.delivery_speed,remaining_repeats:editingCampaign.remaining_repeats,repeat_days_interval:editingCampaign.repeat_days_interval,max_cost:editingCampaign.retained_balance,maxCostWithSms:editingCampaign.max_cost_with_sms,max_gift_cost:editingCampaign.retained_gift_balance,phonenumbers:[],previews:editingCampaign.previews,schedulation_original_data:editingCampaign.schedulation_original_data,uploadetAudioFile:editingCampaign.audio_amazon_s3,sender_name:editingCampaign.sender_name,should_shuffle:editingCampaign.should_shuffle,type:editingCampaign.type,sms_text:editingCampaign.sms_text,same_sms_text:editingCampaign.same_sms_text},null==CampaignComposeService.campaignData.same_sms_text&&(CampaignComposeService.campaignData.same_sms_text=!1),window.first_advisable_caller_id=CampaignComposeService.campaignData.caller_id,editingCampaign.voice_file&&(CampaignComposeService.campaignData.uploadetAudioFile={_id:editingCampaign.voice_file._id}),CampaignComposeService.chosedInteractions=[editingCampaign.replay_digit,editingCampaign.transfer_digit,editingCampaign.callback_digit,editingCampaign.do_not_call_digit],$scope.getPlaybackCount=function(count){return CampaignComposeService.campaignData.playback_count==count},CampaignComposeService.replayDigit.onOff=null!=editingCampaign.replay_digit,CampaignComposeService.transferDigit.onOff=null!=editingCampaign.transfer_digit,CampaignComposeService.callbackDigit.onOff=null!=editingCampaign.callback_digit,CampaignComposeService.doNotCallDigit.onOff=null!=editingCampaign.do_not_call_digit,CampaignComposeService.finalStepData={voiceFile:editingCampaign.voice_file,numbersCount:editingCampaign.phonenumbers.length,maxCost:editingCampaign.retained_balance+editingCampaign.retained_gift_balance,maxCostWithSms:editingCampaign.max_cost_with_sms},addPhonenumbersToFinalStep(editingCampaign),CampaignComposeService.composeStep2=!0,CampaignComposeService.composeStep3=!0,$stateParams.tab=3}else{if($rootScope.currentUser.numbers&&$rootScope.currentUser.numbers.length>0){var numbersLength=$rootScope.currentUser.numbers.length;CampaignComposeService.campaignData={caller_id:$rootScope.currentUser.numbers[numbersLength-1].phone_number,get_email_notifications:!0}}if($stateParams.audioFile){CampaignComposeService.composeStep2=!0;({source:$sce.trustAsResourceUrl($stateParams.audioFile.amazon_s3_url),file:$stateParams.audioFile});CampaignComposeService.finalStepData.voiceFile=$stateParams.audioFile,CampaignComposeService.campaignData.campaign_voice_file_id=$stateParams.audioFile._id}CampaignComposeService.campaignData.remaining_repeats=0,CampaignComposeService.campaignData.repeat_days_interval=7}void 0!=$stateParams.tab&&(CampaignComposeService.campaignData.voice_file&&!CampaignComposeService.campaignData.voice_file.is_template?$scope.audioActiveTab=1:$scope.audioActiveTab=$stateParams.tab-1),$stateParams.file_id&&CampaignComposeService.audioTemplates.files.forEach(function(file){$stateParams.file_id===file._id&&(CampaignComposeService.campaignData.uploadetAudioFile={_id:$stateParams.file_id},CampaignComposeService.campaignData.campaign_voice_file_id=$stateParams.file_id)}),$scope.trustSrc=function(src){return $sce.trustAsResourceUrl(src)};var playPauseAudio=function(audioTemplate){var audio=document.getElementById("composeTemplateFile"+audioTemplate._id);audio.setAttribute("src",audioTemplate.amazon_s3_url),audioTemplate.isRecordedFilePlaying?(console.log("Paused"),audio.pause(),audio.currentTime=0,audioTemplate.playButtonClass="fa-play-circle"):(audio.play(),startedPlying("composeTemplateFile"+audioTemplate._id).then(function(){console.log("Playing"),audioTemplate.playButtonClass="black black fa-stop-circle",audioTemplate.showAudioSpinner=!1}),audio.addEventListener("ended",function(){console.log("Ended"),audioTemplate.isRecordedFilePlaying=!1,audioTemplate.playButtonClass="fa-play-circle"},!1)),audioTemplate.isRecordedFilePlaying=!audioTemplate.isRecordedFilePlaying};$scope.playAudio=function(){var a=document.getElementById("aaa");a.muted=!0,a.play()},$scope.playPauseRecordedAudio=function(audioTemplate){audioTemplate.amazon_s3_url?(audioTemplate.showAudioSpinner=!1,playPauseAudio(audioTemplate)):(audioTemplate.showAudioSpinner=!0,$rootScope.getAmazonUrlOfAudio(audioTemplate._id).then(function(url){audioTemplate.amazon_s3_url=url,playPauseAudio(audioTemplate)}))},$scope.checkSelectedItem=function(){CampaignComposeService.campaignData&&CampaignComposeService.campaignData.campaign_voice_file_id&&CampaignComposeService.audioTemplates&&CampaignComposeService.audioTemplates.files.length&&CampaignComposeService.audioTemplates.files.forEach(function(item){if(item._id===CampaignComposeService.campaignData.campaign_voice_file_id){var index=CampaignComposeService.audioTemplates.files.indexOf(item),new_item=item;CampaignComposeService.audioTemplates.files.splice(index,1),CampaignComposeService.audioTemplates.files.unshift(new_item)}})},CampaignComposeService.editingCampaign&&$scope.checkSelectedItem()}]);