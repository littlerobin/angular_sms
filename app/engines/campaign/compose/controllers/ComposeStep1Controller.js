angular.module("callburnApp").controller("ComposeStep1Controller",["$scope","$rootScope","Restangular","notify","FileUploader","$sce","$timeout","CampaignComposeService","growl","$stateParams",function($scope,$rootScope,Restangular,notify,FileUploader,$sce,$timeout,CampaignComposeService,growl){"use strict";$rootScope.tutorialSidePopup=!1;var sortTtsLanguages=function(languages){var currentLanguages=[],anotherLanguages=[];return languages.forEach(function(item){item.languageCode===$rootScope.currentLanguage?currentLanguages.push(item):anotherLanguages.push(item)}),currentLanguages.concat(anotherLanguages)};$scope.selectedTab=function(){clearInterval($scope.navInterval)},$scope.selectTabFromText=function(){$scope.navInterval=setInterval(function(){angular.element(".uib-tab > .nav-link")[0].click()},10)},$scope.editAudioTemplate=function(audio){$scope.audioFiles.push(audio),$scope.lastFileIsUploaded=!0,$scope.selectTabFromText(),$scope.slsectAudio(audio)},$scope.CampaignComposeService=CampaignComposeService,CampaignComposeService.ttsLanguages=sortTtsLanguages(CampaignComposeService.ttsLanguages),CampaignComposeService.ttsLanguages.forEach(function(item){item.selectView=item.languageName+"-"+item.ttsEngine}),$rootScope.$watch("currentLanguage",function(newVal){Restangular.one("data/tts-languages").get().then(function(res){CampaignComposeService.ttsLanguages=sortTtsLanguages(res.resource.languages),CampaignComposeService.ttsLanguages.forEach(function(item){item.selectView=item.languageName+"-"+item.ttsEngine})})}),$scope.audioTemplates=CampaignComposeService.audioTemplates.files,$scope.totalTemplatesCount=CampaignComposeService.audioTemplates.total_templates_count,$scope.audioTemplatesCount=CampaignComposeService.audioTemplates.count,$scope.audioTemplatesPagesCount=Math.ceil(CampaignComposeService.audioTemplates.count/30),$scope.smsTemplates=CampaignComposeService.smsTemplates.files,$scope.images=["/assets/callburn/images/manually-or-file-icon.png"],$scope.ttsData={language:"",text:""};var applyTranslations=function(){$scope.isLoaded=!1,setTimeout(function(){$scope.isLoaded=!0},100);var ttsEnginesNames={en:"Kate",it:"Alice-ML",es:"Monica"};$scope.ttsEngineIndicated=ttsEnginesNames[$rootScope.currentLanguage],$scope.ttsData.language=$scope.ttsEngineIndicated};$rootScope.$watch("currentLanguage",applyTranslations),$rootScope.$watch("isLangLoaded",applyTranslations),$scope.lastFileIsUploaded=!1,$scope.audioFiles=[],$scope.sameText=!1,$scope.checkText=function(){$scope.audioFiles.some(function(item){return $scope.ttsData.text===item.tts_text?$scope.sameText=!0:void($scope.sameText=!1)})},$scope.createAudioFromTextForVoice=function(type){return $rootScope.disableButton(),$rootScope.startModalLoader(),$scope.checkText(),$scope.sameText?($rootScope.enabledButton(),void $rootScope.stopModalLoader()):($scope.ttsData.saved_from="COMPOSE",Restangular.all("campaigns/create-audio-from-text").post($scope.ttsData).then(function(data){if($rootScope.enabledButton(),$rootScope.stopModalLoader(),0===data.resource.error.no){if("editing"!==type){if($scope.sameText)return;$scope.audioFiles.length<6&&!$scope.sameText?(CampaignComposeService.campaignData.campaign_voice_file_id=data.resource.file._id,$scope.audioFiles.push(data.resource.file),CampaignComposeService.finalStepData.voiceFile=data.resource.file):$scope.sameText||($scope.audioFiles.splice($scope.audioFiles.length-1,1),$scope.audioFiles.push(data.resource.file))}"editing"===type&&$scope.ttsData.text&&$scope.ttsData.language&&($scope.editingTemplate.amazon_s3_url=data.resource.file.amazon_s3_url,$scope.editingTemplate.length=data.resource.file.length,$scope.editingTemplate.tts_text=$scope.ttsData.text,$scope.editingTemplate.tts_language=$scope.ttsData.language),$scope.lastFileIsUploaded=!0,growl.success($rootScope.trans(data.resource.error.message))}else growl.error($rootScope.trans(data.resource.error.text))}),void($rootScope.blinkSaveButton=!0))};var campaignVoiceMessageUpload=$scope.campaignVoiceMessageUpload=new FileUploader({url:"/campaigns/upload-audio-file",headers:{JWTAuthorization:"Bearer "+localStorage.getItem("jwtToken"),savedFrom:"COMPOSE"},alias:"file",autoUpload:!0});switch(campaignVoiceMessageUpload.onAfterAddingFile=function(item){$rootScope.disableButton(),$scope.uploadingAudioName=item.file.name},campaignVoiceMessageUpload.onSuccessItem=function(item,response,status,headers){$rootScope.enabledButton(),$rootScope.stopModalLoader(),0==response.resource.error.no?(CampaignComposeService.finalStepData.voiceFile=response.resource.file,CampaignComposeService.campaignData.uploadetAudioFile=response.resource.file,CampaignComposeService.campaignData.campaign_voice_file_id=response.resource.file._id,growl.success($rootScope.trans(response.resource.error.message)),$rootScope.step2Arrow||($rootScope.step2Arrow=!0,$rootScope.arrowHelper=!0,$rootScope.step1Arrow&&$rootScope.step2Arrow&&($rootScope.nextArrowHelper=!0,$rootScope.step1Arrow=!1,$rootScope.arrowHelper=!1,$rootScope.nextArrow()))):growl.error($rootScope.trans(response.resource.error.text))},campaignVoiceMessageUpload.onErrorItem=function(item,response,status,headers){$scope.errors=response,$rootScope.enabledButton(),$rootScope.stopModalLoader()},campaignVoiceMessageUpload.onBeforeUploadItem=function(){$rootScope.disableButton(),$rootScope.startModalLoader()},$scope.getTTSUrl=function(){return $sce.trustAsResourceUrl("/assets/callburn/tts/"+$scope.ttsData.language+".wav")},$scope.playTTSDemo=function(){document.getElementById("ttsDemoAudio").play()},$scope.disabelCompose=function(){return!(""!=$scope.ttsData.language&&""!=$scope.ttsData.text)},$scope.paginateAudio=function(page){if(!(page<0||page>$scope.audioTemplatesPagesCount)){var postData={};postData.page=page,Restangular.one("audio-files/audio-templates").get(postData).then(function(data){$scope.totalTemplatesCount=data.resource.total_templates_count,$scope.audioTemplates=data.resource.files})}},$scope.playTTSDemo=function(){var audio=document.getElementById("ttsDemoAudio"),audioPlayElem=angular.element("#audioFilePlay");$scope.isRecordedFilePlaying?(audio.pause(),audioPlayElem.addClass("fa-play-circle"),audioPlayElem.removeClass("fa-stop-circle")):(audio.play(),audio.currentTime=0,audioPlayElem.removeClass("fa-stop-circle"),audioPlayElem.addClass("fa-stop-circle"),audio.addEventListener("ended",function(){$scope.isRecordedFilePlaying=!1,audioPlayElem.removeClass("fa-stop-circle"),audioPlayElem.addClass("fa-play-circle")},!1)),$scope.isRecordedFilePlaying=!$scope.isRecordedFilePlaying},CampaignComposeService.calculateCostForPreListening(),$scope.editing=!1,$scope.editingTemplate=!1,$scope.slsectAudio=function(template){$scope.disableSmsText=!1,template.tts_text.length||($scope.disableSmsText=!0,CampaignComposeService.campaignData.same_sms_text=!1),$rootScope.blinkSaveButton=!0,$scope.editingTemplate===template?($scope.editing=!1,$scope.editingTemplate="",CampaignComposeService.campaignData.campaign_voice_file_id=template["null"]):($scope.editing=!0,$scope.editingTemplate=template,CampaignComposeService.campaignData.campaign_voice_file_id=template._id),CampaignComposeService.checkIfAlreadyStarted()||(CampaignComposeService.finalStepData.voiceFile=template,$rootScope.step2Arrow||($rootScope.step2Arrow=!0,$rootScope.arrowHelper=!0,$rootScope.step1Arrow&&$rootScope.step2Arrow&&($rootScope.nextArrowHelper=!0,$rootScope.arrowHelper=!1,$rootScope.nextArrow())),CampaignComposeService.campaignData.same_sms_text&&(CampaignComposeService.campaignData.sms_text=template.tts_text),$scope.ttsData.text=template.tts_text,$scope.ttsData.language=template.tts_language)},CampaignComposeService.goToStep=function(step){},$scope.deleteAudio=function(file){var index=$scope.audioFiles.indexOf(file);$scope.audioFiles.splice(index,1)},$scope.editAudio=function(file){$scope.createAudioFromTextForVoice("editing"),$scope.editingTemplate.tts_text=$scope.ttsData.text,$scope.editingTemplate.tts_language=$scope.ttsData.language},CampaignComposeService.campaignData.type){case"VOICE_MESSAGE":$rootScope.selectedType="vm";break;case"VOICE_WITH_SMS":$rootScope.selectedType="vmSms";break;case"SMS":$rootScope.selectedType="sms";break;default:$rootScope.selectedType="vm",CampaignComposeService.campaignData.type="VOICE_MESSAGE"}$scope.selectType=function(type){switch(type){case"vm":Restangular.one("audio-files/audio-templates").get({saved_from:"CALL_MESSAGE"}).then(function(data){$scope.audioTemplates=data.resource.files,$scope.totalTemplatesCount=data.resource.total_templates_count}),$rootScope.selectedType="vm",CampaignComposeService.campaignData.type="VOICE_MESSAGE";break;case"vmSms":Restangular.one("audio-files/audio-templates").get({saved_from:"NOT_SPECIFIED"}).then(function(data){$scope.audioTemplates=data.resource.files,$scope.totalTemplatesCount=data.resource.total_templates_count}),$rootScope.selectedType="vmSms",CampaignComposeService.campaignData.type="VOICE_WITH_SMS";break;case"sms":Restangular.one("audio-files/audio-templates").get({saved_from:"SMS"}).then(function(data){$scope.audioTemplates=data.resource.files,$scope.totalTemplatesCount=data.resource.total_templates_count}),$rootScope.selectedType="sms",CampaignComposeService.campaignData.type="SMS";break;default:$scope.selectedType="vm",CampaignComposeService.campaignData.type="VOICE_MESSAGE"}},$scope.toggleSameAs=function(){CampaignComposeService.campaignData.same_sms_text?CampaignComposeService.campaignData.same_sms_text=!1:(CampaignComposeService.campaignData.same_sms_text=!0,CampaignComposeService.campaignData.sms_text=$scope.ttsData.text)},$scope.calcSmsText=function(){var txt=CampaignComposeService.campaignData.sms_text.length,num=0;return txt>=0&&txt<=160?(num=1," - "+num+" SMS"):txt>=161&&txt<=320?(num=2," - "+num+" SMS"):txt>=321&&txt<=480?(num=3," - "+num+" SMS"):txt>=481&&txt<=640?(num=4," - "+num+" SMS"):txt>=641&&txt<=800?(num=5," - "+num+" SMS"):txt>=801&&txt<=960?(num=6," - "+num+" SMS"):void 0},$scope.selectSmsTemplate=function(text){$scope.selectedSmsText=text,CampaignComposeService.campaignData.sms_text=text}}]);