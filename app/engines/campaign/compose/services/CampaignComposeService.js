angular.module("callburnApp").service("CampaignComposeService",function($rootScope,$sce,Restangular,$state,ModalService,CallBournModal,CampingService,notify,growl,$filter,$q,$stateParams){var composeData={};return composeData.editingCampaign=null,composeData.reusingCampaign=null,composeData.campaignData={phonenumbers:[],repeats_count:0,repeat_days_interval:0,remaining_repeats:0,caller_id:$rootScope.currentUser.numbers&&$rootScope.currentUser.numbers.length>0?$rootScope.currentUser.numbers[$rootScope.currentUser.numbers.length-1].phone_number:null,max_cost:0},window.first_advisable_caller_id=$rootScope.currentUser.numbers&&$rootScope.currentUser.numbers.length>0?$rootScope.currentUser.numbers[$rootScope.currentUser.numbers.length-1].phone_number:null,composeData.step2Phonenumbers=[],composeData.step2PhonenumbersPagesCount=1,composeData.finalStepData={},composeData.ttsLanguages=[],composeData.audioTemplates={},composeData.interactionsForModal=[],composeData.composeStep=1,composeData.chosedInteractions=[],composeData.disablePreListenButton=!0,composeData.replayDigit={showNumbersSelect:!1,checkboxChecked:!1},composeData.transferDigit={showNumbersSelect:!1,checkboxChecked:!1},composeData.callbackDigit={showNumbersSelect:!1,checkboxChecked:!1},composeData.doNotCallDigit={showNumbersSelect:!1,checkboxChecked:!1},composeData.finalStepData.recipientsCounterLoader=!1,composeData.clearComposeData=function(){composeData.editingCampaign=null,composeData.reusingCampaign=null,composeData.campaignData={phonenumbers:[],repeats_count:0,repeat_days_interval:0,remaining_repeats:0,caller_id:$rootScope.currentUser.numbers&&$rootScope.currentUser.numbers.length>0?$rootScope.currentUser.numbers[$rootScope.currentUser.numbers.length-1].phone_number:null,max_cost:0},window.first_advisable_caller_id=$rootScope.currentUser.numbers&&$rootScope.currentUser.numbers.length>0?$rootScope.currentUser.numbers[$rootScope.currentUser.numbers.length-1].phone_number:null,composeData.step2Phonenumbers=[],composeData.step2PhonenumbersPagesCount=1,composeData.finalStepData={},composeData.ttsLanguages=[],composeData.audioTemplates={},composeData.interactionsForModal=[],composeData.composeStep=1,composeData.chosedInteractions=[],composeData.disablePreListenButton=!0,composeData.replayDigit={showNumbersSelect:!1,checkboxChecked:!1},composeData.transferDigit={showNumbersSelect:!1,checkboxChecked:!1},composeData.callbackDigit={showNumbersSelect:!1,checkboxChecked:!1},composeData.doNotCallDigit={showNumbersSelect:!1,checkboxChecked:!1},composeData.finalStepData.recipientsCounterLoader=!1},composeData.getAudioSource=function(audio){return $sce.trustAsResourceUrl(audio.amazon_s3_url)},composeData.scrollToErr=function(elem,type){if("sms"==elem)var elem=angular.element(document.getElementById("sms_err"));else if("vm"==elem)var elem=angular.element(document.getElementById("vm_err"));else if("recipients"==elem)var elem=angular.element(document.getElementById("choose-your-recipients"));angular.element("html, body").animate({scrollTop:elem.offset().top-100})},composeData.doValitation=function(action,from,type){if("start"==action){if($rootScope.fileIdErr=!1,$rootScope.smsTextErr=!1,$rootScope.recipientsErr=!1,!composeData.campaignData.campaign_name)return void($rootScope.disableTagWithName=!0);if("vmSms"===$rootScope.selectedType){if(!composeData.campaignData.campaign_voice_file_id)return $rootScope.fileIdErr=!0,void composeData.scrollToErr("vm");if(!composeData.campaignData.sms_text)return $rootScope.smsTextErr=!0,void composeData.scrollToErr("sms");if(!composeData.finalStepData.maxCost||!composeData.finalStepData.maxCostWithSms||composeData.finalStepData.maxCost==composeData.finalStepData.maxCostWithSms)return composeData.finalStepData.maxCost||composeData.campaignData.campaign_voice_file_id?composeData.finalStepData.maxCost==composeData.finalStepData.maxCostWithSms?void growl.error($rootScope.trans("there_is_no_sms_tariff_for_your_country")):($rootScope.recipientsErr=!0,void composeData.scrollToErr("recipients")):($rootScope.fileIdErr=!0,void composeData.scrollToErr("vm"))}else if("vm"===$rootScope.selectedType){if(!composeData.finalStepData.maxCost&&composeData.campaignData.campaign_voice_file_id)return $rootScope.recipientsErr=!0,void composeData.scrollToErr("recipients");if(!composeData.campaignData.campaign_voice_file_id)return $rootScope.fileIdErr=!0,void composeData.scrollToErr("vm")}else if("sms"===$rootScope.selectedType){if(!composeData.finalStepData.maxCostWithSms&&composeData.campaignData.sms_text)return $rootScope.recipientsErr=!0,composeData.scrollToErr("recipients"),void growl.error($rootScope.trans("send_sms_unsupported_error"));if(!composeData.campaignData.sms_text)return $rootScope.smsTextErr=!0,void composeData.scrollToErr("sms")}else if(checkIfAlreadyStarted())return void growl.error($rootScope.trans("this_campaign_already_started"))}if(!composeData.checkIfAlreadyStarted()||"scheduled"===action){var isValid=!0,errorMessage="";console.log("DoValitation",composeData.campaignData);var campaignData=composeData.campaignData;if(campaignData.from=from,composeData.callbackDigit.onOff&&(campaignData.callback_digit>=0&&campaignData.callback_voice_file_id||(isValid=!1,errorMessage="callback_voice_file_required_with_callback_digit")),composeData.doNotCallDigit.onOff&&(campaignData.do_not_call_digit>=0&&campaignData.do_not_call_voice_file_id||(isValid=!1,errorMessage="donotcall_voice_file_required_with_donotcall_digit")),composeData.transferDigit.onOff&&(campaignData.transfer_digit>=0&&campaignData.transfer_options||(isValid=!1,errorMessage="transfer_options_required_with_transfer_digit")),composeData.replayDigit.onOff&&(campaignData.replay_digit>=0||(isValid=!1,errorMessage="replay_digit_is_activated_but_not_selected")),!isValid)return void(errorMessage.length?growl.error(trans(errorMessage)):growl.error(trans("insufficient_funds")));var isAnyActive=!1,reminigReperats=!1,shcedulationRepeat=!1,playback_count=campaignData.playback_count;if(composeData.replayDigit.onOff){isAnyActive=!0;var replayDigitObject={action:$rootScope.trans("campaign_compose_compose_step_3_replay_voice_message"),keypress:composeData.campaignData.replay_digit};composeData.interactionsForModal.push(replayDigitObject)}if(1!=playback_count&&(composeData.campaignData.playback_count=playback_count),composeData.transferDigit.onOff){isAnyActive=!0;var transferDigitObject={action:$rootScope.trans("campaign_compose_compose_step_3_call_live"),keypress:composeData.campaignData.transfer_digit};composeData.interactionsForModal.push(transferDigitObject)}if(composeData.callbackDigit.onOff){isAnyActive=!0;var callbackDigitObject={action:$rootScope.trans("campaign_compose_compose_step_3_call_me_back"),keypress:composeData.campaignData.callback_digit};composeData.interactionsForModal.push(callbackDigitObject)}if(composeData.doNotCallDigit.onOff){isAnyActive=!0;var doNotCallDigitObject={action:$rootScope.trans("campaign_compose_compose_step_3_blacklist_me"),keypress:composeData.campaignData.do_not_call_digit};composeData.interactionsForModal.push(doNotCallDigitObject)}if(campaignData.remaining_repeats>0&&(reminigReperats=!0),void 0!==campaignData.schedulations&&campaignData.schedulations&&0!==campaignData.schedulations.length&&(campaignData.schedulations_count=campaignData.schedulations.length),(void 0!==campaignData.schedulations_count&&0!==campaignData.schedulations_count||void 0!==campaignData.schedulations&&campaignData.schedulations&&0!==campaignData.schedulations.length)&&(shcedulationRepeat=!0),"saved"===action){var checkSelectedGroups=!(0===Object.keys(campaignData.selected_groups).length&&campaignData.selected_groups.constructor===Object);!campaignData.campaign_name&&checkSelectedGroups&&(campaignData.campaign_name=campaignData.group_name),isAnyActive=!1}isAnyActive?($rootScope.showScheduleSpinner=!1,$rootScope.disableScheduleBtns=!1,CallBournModal.close(),CallBournModal.open({scope:{interactionsForModal:composeData.interactionsForModal,saveWithInteractionsCheckbox:!1,action:action,campaignData:campaignData},templateUrl:"/app/modals/camping-batch/confirm-interactions.html",size:"modal-md"},function(scope){scope.proceedToSaveWithInteraction=function(){composeData.checkForModals(reminigReperats,shcedulationRepeat,action),CallBournModal.close(),composeData.interactionsForModal=[]},scope.dismissModal=function(){CallBournModal.close(),composeData.interactionsForModal=[]}})):"preview"===action?composeData.proceedToSaving(action,type):composeData.checkForModals(reminigReperats,shcedulationRepeat,action)}},composeData.checkForSchedulation=function(dateString){if(!composeData.editingCampaign)return!0;dateString=moment(dateString).format("YYYY-MM-DD hh:mm:ss").trim();for(var i=0;i<composeData.editingCampaign.schedulations.length;i++){var schedulatedDateString=moment(composeData.editingCampaign.schedulations[i].scheduled_date).format("YYYY-MM-DD hh:mm:ss").trim();if(schedulatedDateString===dateString)return!composeData.editingCampaign.schedulations[i].is_finished}return!0},composeData.isAlreadyStarted=!1,composeData.checkIfAlreadyStarted=function(){return composeData.editingCampaign&&composeData.editingCampaign.schedulations.forEach(function(schedulation){schedulation.is_finished&&(composeData.isAlreadyStarted=!0)}),composeData.isAlreadyStarted},composeData.checkForModals=function(reminigReperats,shcedulationRepeat,action){if("saved"===action)return void composeData.proceedToSaving(action);var campaignData=composeData.campaignData;reminigReperats&&shcedulationRepeat?($rootScope.showScheduleSpinner=!1,$rootScope.disableScheduleBtns=!1,CallBournModal.close(),CallBournModal.open({scope:{CampaignComposeService:composeData,campaignData:campaignData},templateUrl:"/app/modals/camping-batch/show-shcdulation-confirm-with-repitation.html",size:"modal-md"},function(scope){scope.schedul=[],scope.dataSaved=[],scope.Math=Math,$rootScope.schedulationModalFlag=!0;for(var index in campaignData.schedulations)scope.CampaignComposeService.finalStepData.sendingTime=campaignData.schedulations[index].delivery_speed>0?campaignData.schedulations[index].delivery_speed:scope.CampaignComposeService.finalStepData.sendingTime,scope.schedul[0]=moment(campaignData.schedulations[index].start).set({hour:moment(campaignData.schedulations[index].start).format("HH"),minute:moment(campaignData.schedulations[index].start).format("mm")}).format("dddd DD, MMMM YYYY - HH:mm -"),scope.dataSaved=moment(campaignData.schedulations[index].start).set({hour:moment(campaignData.schedulations[index].start).format("HH"),minute:moment(campaignData.schedulations[index].start).format("mm")});scope.dates=[];for(var i=0;i<campaignData.remaining_repeats+1;i++)0!=i&&scope.dates.push(moment(scope.dataSaved).add(i*campaignData.repeat_days_interval,"days").format("dddd DD, MMMM YYYY - HH:mm -"));scope.saveTo=function(){composeData.proceedToSaving(action)},scope.dismissModal=function(){CallBournModal.close(),composeData.interactionsForModal=[]}}),composeData.interactionsForModal=[]):reminigReperats?($rootScope.showScheduleSpinner=!1,$rootScope.disableScheduleBtns=!1,CallBournModal.close(),CallBournModal.open({scope:{CampaignComposeService:composeData},templateUrl:"/app/modals/camping-batch/show-repiteation-count-confirm.html",size:"modal-md"},function(scope){scope.Math=Math,scope.dates=[];for(var i=0;i<campaignData.remaining_repeats+1;i++)0!=i&&scope.dates.push(moment(moment().add(i*campaignData.repeat_days_interval,"days")).format("dddd DD, MMMM YYYY - HH:mm -"));$rootScope.schedulationModalFlag=!0,scope.saveTo=function(){composeData.proceedToSaving(action)},composeData.interactionsForModal=[]})):shcedulationRepeat?void 0!==campaignData.schedulations&&0!==campaignData.schedulations.length&&($rootScope.showScheduleSpinner=!1,$rootScope.disableScheduleBtns=!1,CallBournModal.close(),CallBournModal.open({scope:{CampaignComposeService:composeData,campaignData:campaignData},templateUrl:"/app/modals/camping-batch/show-shcdulation-confirm-with-out-repitation.html",size:"modal-md"},function(scope){if(void 0!==scope.campaignData.schedulation_original_data&&scope.campaignData.schedulation_original_data&&0!==scope.campaignData.schedulation_original_data.length&&composeData.saveChanges){var events=JSON.parse(scope.campaignData.schedulation_original_data);events.forEach(function(event,i){event.start=moment(event.start).format("YYYY-MM-DD HH:mm:ss"),campaignData.schedulations.forEach(function(schedulation,j){events.indexOf(event)===campaignData.schedulations.indexOf(schedulation)&&(campaignData.schedulations[j].start=moment(events[i].start))})})}scope.minDate=scope.campaignData.minDate,scope.maxDate=scope.campaignData.maxDate,scope.isLiveTransferLimitExist=void 0!==scope.campaignData.live_transfer_limit,$rootScope.schedulationModalFlag=!0;for(var i=0;i<scope.campaignData.schedulations.length;i++)if(0!==scope.campaignData.schedulations[i].delivery_speed){scope.isAnyDeliverySpeedSet=!0;break}scope.scheduls=[],scope.Math=Math;var delivery=scope.CampaignComposeService.finalStepData.sendingTime;moment.locale($rootScope.currentLanguage);for(var index in campaignData.schedulations){campaignData.schedulations[index].delivery_speed>0&&(delivery=campaignData.schedulations[index].delivery_speed);var schedulData={schedul:moment.tz(campaignData.schedulations[index].start,$rootScope.currentUser.timezone).format("dddd DD, MMMM YYYY - HH:mm -"),delivery:delivery,filterData:moment(campaignData.schedulations[index].start).format(),recipients_count_to_call:campaignData.schedulations[index].recipients_count_to_call},check=composeData.checkForSchedulation(campaignData.schedulations[index].start);check?schedulData.is_pasted=!1:schedulData.is_pasted=!0,scope.scheduls.push(schedulData)}scope.disableButtons=!1,scope.saveTo=function(){composeData.saveChanges?(composeData.proceedToSaving(action),scope.disableButtons=!0):(scope.disableButtons=!0,$rootScope.schedulationModalFlag=!1,campaignData.schedulations.forEach(function(schedulation){schedulation.start=schedulation.start.utc(window.SERVER_TIMEZONE).format("YYYY-MM-DD H:mm:ss")})),composeData.proceedToSaving(action)}})):composeData.proceedToSaving(action)},composeData.proceedToSaving=function(action,type){var campaignData=composeData.campaignData;if(composeData.campaignData.schedulations&&composeData.campaignData.schedulation_original_data&&composeData.campaignData.schedulations.forEach(function(schedulation,i){JSON.parse(composeData.campaignData.schedulation_original_data)}),campaignData.is_replay_active=!!composeData.replayDigit.onOff,campaignData.is_transfer_active=!!composeData.transferDigit.onOff,campaignData.is_callback_active=!!composeData.callbackDigit.onOff,campaignData.is_donotcall_active=!!composeData.doNotCallDigit.onOff,!campaignData.caller_id)return void alert("Caller id is required.");switch("preview"!=action&&(campaignData.status=action),action){case"saved":campaignData.schedulations=null;var templateUrl="/app/modals/camping-batch/voice-message-save.html";break;case"scheduled":var templateUrl="/app/modals/camping-batch/voice-message-sent.html";break;case"start":campaignData.schedulations=null;var templateUrl="/app/modals/camping-batch/voice-message-sent.html";break;case"preview":var templateUrl="/app/modals/camping-batch/voice-message-sent.html",previewCampaignToCreateString=JSON.stringify(campaignData),previewCampaignToCreate=JSON.parse(previewCampaignToCreateString);composeData.campaignData=$rootScope.editingCampaign,delete previewCampaignToCreate.selected_groups,previewCampaignToCreate.status="start",previewCampaignToCreate.is_preview=!0,previewCampaignToCreate.parent_id=$rootScope.editingCampaign._id,previewCampaignToCreate.callback_digit=$rootScope.editingCampaign.callback_digit,previewCampaignToCreate.callback_voice_file_id=$rootScope.editingCampaign.callback_digit_file_id,previewCampaignToCreate.transfer_digit=$rootScope.editingCampaign.transfer_digit,previewCampaignToCreate.transfer_options=$rootScope.editingCampaign.transfer_options,previewCampaignToCreate.transfer_option=$rootScope.editingCampaign.transfer_option,previewCampaignToCreate.do_not_call_digit=$rootScope.editingCampaign.do_not_call_digit,previewCampaignToCreate.do_not_call_voice_file_id=$rootScope.editingCampaign.do_not_call_digit_file_id,previewCampaignToCreate.do_not_call_file=$rootScope.editingCampaign.do_not_call_file,previewCampaignToCreate.replay_digit=$rootScope.editingCampaign.callback_digit,previewCampaignToCreate.campaign_voice_file_id=$rootScope.editingCampaign.campaign_voice_file_id,previewCampaignToCreate.type=$rootScope.editingCampaign.type,previewCampaignToCreate.playback_count=$rootScope.editingCampaign.playback_count,previewCampaignToCreate.is_callback_active=$rootScope.editingCampaign.callback_digit,previewCampaignToCreate.is_replay_active=$rootScope.editingCampaign.replay_digit,previewCampaignToCreate.is_donotcall_active=$rootScope.editingCampaign.do_not_call_digit,previewCampaignToCreate.is_transfer_active=$rootScope.editingCampaign.transfer_digit;var currentCallerId=composeData.campaignData.caller_id.toString();return"+"!==currentCallerId[0]&&(currentCallerId="+"+currentCallerId),previewCampaignToCreate.phonenumbers=[currentCallerId],"vm"===type?previewCampaignToCreate.sms_text="":"sms"===type&&(previewCampaignToCreate.campaign_voice_file_id=!1),void Restangular.all("campaigns/create-campaign").post(previewCampaignToCreate).then(function(data){0==data.resource.error.no?(composeData.editingCampaign=$rootScope.editingCampaign,growl.success($rootScope.trans("Call__made")),Restangular.one("campaigns/show-campaign",$stateParams.campaign_id).get().then(function(res){$rootScope.previews=res.resource.campaign.previews,$rootScope.previews.forEach(function(item){"IN_PROGRESS"===item.preview_phonenumbers[0].status&&($rootScope.enableComposeActions=!1)});var socket_campaign_id;if($rootScope.socket.on("update-preview-message",function(data){socket_campaign_id&&socket_campaign_id!=data.update.campaign_id||(socket_campaign_id=data.update.campaign_id,$rootScope.preview_status=data.update.status,$rootScope.previews.forEach(function(item){"IN_PROGRESS"===item.preview_phonenumbers[0].status&&($rootScope.enableComposeActions=!1)}))}),$rootScope.previews.length){var elem=angular.element(".schedule_sel");angular.element("html, body").animate({scrollTop:elem.offset().top})}})):growl.error($rootScope.trans(data.resource.error.text))})}var url;composeData.editingCampaign?composeData.saveChanges?url="campaigns/update-campaign-name-caller-id":(url="campaigns/update-campaign",campaignData.schedulations&&campaignData.schedulations.forEach(function(schedulation){var check=composeData.checkForSchedulation(schedulation.start);check?schedulation.is_pasted=!1:schedulation.is_pasted=!0})):url="campaigns/create-campaign","contacts"!==campaignData.currentTab&&"manually"!==campaignData.currentTab||delete campaignData.selected_groups,$rootScope.startModalLoader(),Restangular.all(url).post(campaignData).then(function(data){if($rootScope.blinkSaveButton=!1,0===data.resource.error.no)if($rootScope.stopModalLoader(),campaignData.from||"saved"===action){$rootScope.blinkSaveButton=!1;var id=data.resource.campaign_id||$stateParams.campaign_id;"preview"===campaignData.from?$state.go("campaign.edit",{campaign_id:id,from:"preview",type:type}):"fromConfirm"!=campaignData.from?$state.go("campaign.overview"):$state.go($rootScope.toState,$rootScope.toParams)}else $rootScope.showBlurEffect=!0,CallBournModal.open({scope:{},templateUrl:templateUrl,size:"modal-md"},function(scope){scope.goToOverview=function(){if($rootScope.blinkSaveButton=!1,CallBournModal.close(),"start"===action){var campaignId=data.resource.campaign_id;"campaigns/update-campaign"===url&&(campaignId=campaignData.campaign_id),$state.go("campaign.statistics",{campaign_id:campaignId})}else $state.go("campaign.overview")},scope.dismissModal=function(){CallBournModal.close()}});else 0!==data.resource.error.no&&($rootScope.stopModalLoader(),data.resource.error.no==-12?growl.error($rootScope.trans("insufficient_funds")):growl.error(data.resource.error.text))})},composeData.calculateCostForPreListening=function(){var sendData={};sendData.file_id=composeData.campaignData.campaign_voice_file_id,sendData.caller_id=composeData.campaignData.caller_id,CampingService.calculateCostForPreListening(sendData).then(function(data){var maxCost=data.resource.max_cost;composeData.disablePreListenButton=maxCost>=$rootScope.currentUser.balance-$rootScope.currentUser.retainedBalance})},composeData.updateCallerId=function(){var deferred=$q.defer(),campaignId=composeData.campaignData.campaign_id,callerId=composeData.campaignData.caller_id,updateData={campaign_id:campaignId,caller_id:callerId};return Restangular.all("campaigns/update-campaign-caller-id").post(updateData).then(function(data){deferred.resolve(data.resource)}),deferred.promise},composeData});