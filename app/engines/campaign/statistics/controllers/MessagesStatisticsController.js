angular.module("callburnApp").controller("MessagesStatisticsController",["$scope","$rootScope","$state","Restangular","$stateParams","growl","phonenumbers","$httpParamSerializer","$sce","$interval","IconsControl","CallBournModal","$q","$filter",function($scope,$rootScope,$state,Restangular,$stateParams,growl,phonenumbers,$httpParamSerializer,$sce,$interval,IconsControl,CallBournModal,$q,$filter){phonenumbers.resource.error.no===-13&&(growl.error($rootScope.trans("this_campaign_doesnt_exist")),$state.go("campaign.overview")),phonenumbers.resource.phonenumbers.length||phonenumbers.resource.campaign.schedulations.length||$state.go("campaign.edit",{campaign_id:phonenumbers.resource.campaign._id}),$scope.batchRepeats=null,$scope.batchRepeatsText=null,$scope.showEditBox=!1,$scope.redBorder="",$scope.goToNotification=$rootScope.goToNotification,$rootScope.tutorialSidePopup=!1,$scope.isMultiple=$stateParams.is_multiple,$rootScope.currentActiveRoute="campaign",$scope.page=1,$scope.tableSpinnerLoading=!1,$scope.showArrowByField=null,$scope.orderField=null,$scope.firstLoadForStatuses=!0,$scope.firstLoadForInteractions=!0,$rootScope.currentPage="dashboard",$scope.phonenumbers=[],$scope.currentCampaign=phonenumbers.resource.campaign,$scope.serverTimezone=phonenumbers.resource.server_timezone,$scope.interactions=phonenumbers.resource.interactions,$scope.exportCampaignLoader=!1;var applyTranslations=function(){$scope.isLoaded=!1,setTimeout(function(){$scope.isLoaded=!0},100),$scope.multiselectOptionsMessageStatisticsStatusData=[{id:"success",label:trans("campaign_statistics_delivered")},{id:"failed",label:trans("campaign_statistics_not_delivered")},{id:"sent",label:trans("campaign_overview_calling_in_progress")},{id:"IN_PROGRESS",label:trans("waiting_for_schedulation")},{id:"IDLE",label:trans("campaign_statistics_idle")},{id:"CANT_CALL_DUE_TO_EU",label:trans("cant_call_due_eu")}],$scope.multiselectOptionsMessageStatisticsInteractionsData=[{id:"TRANSFER_REQUESTED",label:trans("campaign_statistics_transfer")},{id:"REPLAY_REQUESTED",label:trans("campaign_statistics_replay")},{id:"CALLBACK_REQUESTED",label:trans("campaign_statistics_callback")},{id:"DONOTCALL_REQUESTED",label:trans("campaign_statistics_blacklist")}],"VOICE_WITH_SMS"==$scope.currentCampaign.type&&($scope.smsCount=$scope.currentCampaign.total_phonenumbers[0]&&$scope.currentCampaign.total_phonenumbers[0].count&&($scope.currentCampaign.is_archived&&$scope.currentCampaign.archived_sms_count[0]&&$scope.currentCampaign.archived_sms_count[0].count||0||!$scope.currentCampaign.is_archived&&$scope.currentCampaign.sms_count[0]&&$scope.currentCampaign.sms_count[0].count||0),$scope.voiceCount=$scope.currentCampaign.total_phonenumbers[0]&&$scope.currentCampaign.total_phonenumbers[0].count&&($scope.currentCampaign.is_archived&&$scope.currentCampaign.success_phonenumbers[0]&&$scope.currentCampaign.success_phonenumbers[0].count-($scope.currentCampaign.archived_sms_count[0]&&$scope.currentCampaign.archived_sms_count[0].count||0)||0||!$scope.currentCampaign.is_archived&&$scope.currentCampaign.success_phonenumbers[0]&&$scope.currentCampaign.success_phonenumbers[0].count-($scope.currentCampaign.sms_count[0]&&$scope.currentCampaign.sms_count[0].count||0)||0)),$scope.typeContactsDropdown={0:{value:"all",text:$rootScope.trans("dashboard_welcome_voice_messages")+" + SMS: "+($scope.smsCount+$scope.voiceCount)},1:{value:"sms",text:"SMS: "+$scope.smsCount},2:{value:"callmessage",text:$rootScope.trans("dashboard_welcome_voice_messages")+": "+$scope.voiceCount}},$scope.multiselectStatisticsStatusTranslationTexts={dynamicButtonTextSuffix:trans("multi_checked"),checkAll:trans("multi_check_all"),uncheckAll:trans("multi_uncheck_all"),selectionCount:trans("multi_checked"),buttonDefaultText:trans("multiselect_statistics_status")},$scope.multiselectStatisticsInteractionsTranslationTexts={dynamicButtonTextSuffix:trans("multi_checked"),checkAll:trans("multi_check_all"),uncheckAll:trans("multi_uncheck_all"),selectionCount:trans("multi_checked"),buttonDefaultText:trans("multiselect_statistics_interactions")}};$rootScope.$watch("currentLanguage",applyTranslations),$rootScope.$watch("isLangLoaded",applyTranslations),$scope.IconsControl=IconsControl,$scope.checkedPhonenumbers={};var totalCostOfCampaign=0;if($rootScope.showPreviousIcon=!0,$rootScope.previousStep=function(){$state.go("campaign.overview")},phonenumbers.resource.campaign&&"REPEAT"==phonenumbers.resource.campaign.grouping_type){$scope.batchRepeats=[];var tempRepeats=phonenumbers.resource.campaign;$scope.batchRepeatsText="Batch #1 - "+tempRepeats.created_at;var counter=0,object={campaign_id:tempRepeats._id,showAttr:"Batch #"+counter+" - "+tempRepeats.created_at};$scope.batchRepeats.push(object)}var updatePhonenumbers=function(data){if($scope.tableSpinnerLoading=!1,totalCostOfCampaign=data.resource.total_cost,$scope.phonenumbers=data.resource.phonenumbers,data.resource.campaign){try{$scope.totalCost=data.resource.total_cost}catch(e){$scope.totalCost=null}$scope.campaignRepeats=[];data.resource.campaign}$scope.campingData=data.resource.campaign,$scope.schedulations=data.resource.campaign.schedulations,$scope.campingData.campaign_name=$scope.campingData.campaign_name?$scope.campingData.campaign_name:trans("add_a_name"),$scope.totalPhonenumbers=data.resource.phonenumbers_count,$scope.totalPhonenumbersOrigin=data.resource.total_phonenumbers_count,$scope.succedPhonenumbers=data.resource.campaign.success_phonenumbers[0]?data.resource.campaign.success_phonenumbers[0].count:0,$scope.schedulationDropdownData={0:{value:"all",text:$rootScope.trans("reset_filter")}};var i=0;$scope.schedulations.forEach(function(item,index){var date=moment(item.scheduled_date).tz($rootScope.currentUser.timezone).format("MMMM Do YYYY, HH:mm");if(!moment().tz($rootScope.currentUser.timezone).isBefore(date)){var past=!0;i++}past&&($scope.schedulationDropdownData[i]={value:item._id,text:"#"+i+" "+$rootScope.trans("account_invocies_date")+": "+item.scheduled_date+" "+$rootScope.trans("compose_step_3_text_recipients")+": ---"})})};if(updatePhonenumbers(phonenumbers),$scope.campingData.total_phonenumbers&&$scope.campingData.total_phonenumbers[0]&&$scope.campingData.total_phonenumbers[0].count&&$scope.campingData.success_phonenumbers){if($scope.campingData.success_phonenumbers[0])var data={series:[$scope.campingData.total_phonenumbers[0].count-$scope.campingData.success_phonenumbers[0].count,$scope.campingData.success_phonenumbers[0].count]};else var data={series:[$scope.campingData.total_phonenumbers[0].count,0]};var sum=function(a,b){return a+b},responsiveOptions=[["screen and (max-width: 992px)",{width:320,height:150,labelOffset:40}]],options={chartPadding:30,labelOffset:50,labelInterpolationFnc:function(value){return Math.round(value/data.series.reduce(sum)*100)+"%"},width:300,height:200};new Chartist.Pie(".ct-chart",data,options,responsiveOptions)}$scope.replayCount=$scope.interactions.reply,$scope.transferCount=$scope.interactions.transfer,$scope.callbackCount=$scope.interactions.callback,$scope.blacklistCount=$scope.interactions.blacklist;var barsData={labels:[$rootScope.trans("campaign_statistics_replay")+" ("+$scope.replayCount+")",$rootScope.trans("campaign_statistics_transfer")+" ("+$scope.transferCount+")",$rootScope.trans("campaign_statistics_callback")+" ("+$scope.callbackCount+")",$rootScope.trans("campaign_statistics_blacklist")+" ("+$scope.blacklistCount+")"],series:[$scope.replayCount,$scope.transferCount,$scope.callbackCount,$scope.blacklistCount]},responsiveOptions=[["screen and (max-width: 992px)",{width:320,height:150}]],barsOptions={width:400,height:200,distributeSeries:!0};new Chartist.Bar(".ct-bars",barsData,barsOptions,responsiveOptions),$scope.checkedUncheckPhonenumber=function(phonenumberId,event){$scope.checkedPhonenumbers[phonenumberId]=!$scope.checkedPhonenumbers[phonenumberId]||!$scope.checkedPhonenumbers[phonenumberId]},$scope.currentOrder="ASC",$scope.filterData=$stateParams,$scope.getInteractionSelectData=function(){switch($scope.filterData.action){case"TRANSFER_REQUESTED":return $rootScope.trans("campaign_statistics_transfer");case"REPLAY_REQUESTED":return $rootScope.trans("campaign_statistics_replay");case"CALLBACK_REQUESTED":return $rootScope.trans("campaign_statistics_callback");case"DONOTCALL_REQUESTED":return $rootScope.trans("campaign_statistics_blacklist");default:return $rootScope.trans("campaign_statistics_all_values_shown")}},$scope.interactionsArray=[{keepValue:"",showValue:$rootScope.trans("campaign_statistics_all_values_shown")},{keepValue:"TRANSFER_REQUESTED",showValue:$rootScope.trans("campaign_statistics_transfer")},{keepValue:"REPLAY_REQUESTED",showValue:$rootScope.trans("campaign_statistics_replay")},{keepValue:"CALLBACK_REQUESTED",showValue:$rootScope.trans("campaign_statistics_callback")},{keepValue:"DONOTCALL_REQUESTED",showValue:$rootScope.trans("campaign_statistics_blacklist")}],$scope.getStatusesSelectData=function(){switch($scope.filterData.status){case"success":return $rootScope.trans("campaign_statistics_delivered");case"failed":return $rootScope.trans("campaign_statistics_not_delivered");case"sent":return $rootScope.trans("campaign_sending_in_progress");case"IN_PROGRESS":return $rootScope.trans("waiting_for_schedulation");case"IDLE":return $rootScope.trans("campaign_statistics_idle");case"CANT_CALL_DUE_TO_EU":return $rootScope.trans("cant_call_due_eu");default:return $rootScope.trans("campaign_statistics_all_values_shown")}};var getPhonenumberSchedulationDate=function(phonenumber){if(!$scope.schedulations)return null;for(var i=0;i<$scope.schedulations.length;i++)if($scope.schedulations[i]._id===phonenumber.schedulation_id)return $scope.schedulations[i].scheduled_date;return null};$scope.getStatus=function(phonenumber,campaign){if("IN_PROGRESS"===phonenumber.status){if(!phonenumber.schedulation_id)return phonenumber.statusClass="save-as-draft-status snippet_blinking",$rootScope.trans("campaign_sending_in_progress");var scheduleDate=getPhonenumberSchedulationDate(phonenumber);return scheduleDate?(scheduleDate=moment(scheduleDate,"YYYY-MM-DD h:mm:ss"),moment().tz(window.SERVER_TIMEZONE).diff(scheduleDate)>=0?(phonenumber.statusClass="save-as-draft-status snippet_blinking",$rootScope.trans("campaign_sending_in_progress")):(phonenumber.statusClass="schedulation-in-progress-status",trans("waiting_for_schedulation"))):(phonenumber.statusClass="schedulate-status",trans("waiting_for_schedulation"))}if("VOICE_MESSAGE"===campaign.type){if("SUCCEED"===phonenumber.status)return phonenumber.statusClass="sent-statistics-status",trans("campaign_statistics_delivered")}else if("VOICE_WITH_SMS"===campaign.type){if("SUCCEED"===phonenumber.status||"CALL_FAILED_SMS_SUCCEED"===phonenumber.status)return phonenumber.statusClass="sent-statistics-status",trans("campaign_statistics_delivered")}else if("SMS"===campaign.type&&"SUCCEED"===phonenumber.status)return phonenumber.statusClass="sent-statistics-status",trans("campaign_statistics_delivered");return"IDLE"===phonenumber.status?(phonenumber.statusClass="schedulate-status",trans("campaign_statistics_idle")):"SUCCEED"===phonenumber.status&&(phonenumber.statusClass="save-as-draft-status",phonenumber.calls.length)?$filter("localDate")(phonenumber.calls[phonenumber.calls.length-1].dialled_datetime):"CANT_CALL_DUE_TO_EU"===phonenumber.status?(phonenumber.statusClass="dark_orange",trans("cant_call_due_eu")):(phonenumber.statusClass="dark_orange",trans("campaign_statistics_not_delivere"))},$scope.statusesArray=[{keepValue:"",showValue:$rootScope.trans("campaign_statistics_all_values_shown")},{keepValue:"success",showValue:$rootScope.trans("campaign_statistics_delivered")},{keepValue:"failed",showValue:$rootScope.trans("campaign_statistics_not_delivered")},{keepValue:"sent",showValue:$rootScope.trans("campaign_statistics_in_progress")},{keepValue:"IN_PROGRESS",showValue:$rootScope.trans("campaign_statistics_delivered")},{keepValue:"IDLE",showValue:$rootScope.trans("campaign_statistics_not_delivered")},{keepValue:"CANT_CALL_DUE_TO_EU",showValue:$rootScope.trans("cant_call_due_eu")}],$scope.getCost=function(tariff,duration){return duration<20&&(duration=20),tariff.country.customer_price*duration/60},$scope.filterChanged=function(rejectSpinner){$scope.tableSpinnerLoading=!rejectSpinner,Restangular.all("phonenumbers/campaign-phonenumbers").post($scope.filterData).then(function(phonenumbers){updatePhonenumbers(phonenumbers)})};var intervalPromise=$interval($scope.filterChanged(!0),15e3);$scope.$on("$destroy",function(){$interval.cancel(intervalPromise)}),$scope.searchPhonenumbers=function(phonenumber){$scope.filterData.phonenumber=phonenumber,$scope.page=1,$scope.filterChanged()},$scope.changeCampaignName=function(){if($scope.showEditBox){if(!$scope.campingData.campaign_name)return void($scope.errClass="input-error animated swing");$scope.errClass="";var name=$scope.campingData.campaign_name,id=$scope.campingData._id,editNameData={campaign_name:name,campaign_id:id};Restangular.all("campaigns/update-campaign-name").post(editNameData).then(function(data){0===data.resource.error.no&&($scope.showEditBox=!1,$scope.redBorder="")})}},$scope.showEditNameInput=function(){$scope.showEditBox=!$scope.showEditBox,setTimeout(function(){angular.element("#change-message-name").select()},100)},$scope.currentPage=void 0,$scope.changePage=function(page){$scope.filterData.page=page-1,$scope.currentPage=page,$scope.filterChanged()},$scope.changeOrder=function(field,status){$scope.showArrowByField=field,$scope.currentPage=1,$scope.page=1,$scope.filterData.page=0,field==$scope.filterData.order_field?($scope.currentOrder="ASC"==$scope.currentOrder?"DESC":"ASC",status&&("delivered"==status?$scope.filterData.statuses="success":"not_delivered"==status&&($scope.filterData.statuses="failed"))):$scope.currentOrder="ASC",$scope.orderField=field,$scope.filterData.order_field=field,$scope.filterData.order=$scope.currentOrder,$scope.changePage(1)},$scope.activePhonenumber={actions:[]},$scope.openActionsModal=function(phonenumber){$scope.activePhonenumber=phonenumber,$scope.showAttemptsModal=!0},$scope.removeFromPhonebook=function(){return isPhonenumbersEmpty()?void alert("No phonenumber selected"):($rootScope.startLoader(),void Restangular.all("phonenumbers/remove-from-phonebook").post({phonenumber_ids:$scope.checkedPhonenumbers}).then(function(data){$rootScope.stopLoader(),0===data.resource.error.no}))},window.playPauseRecordedAudio=function(campaignId){var template=$scope.currentCampaign.voice_file,audioId=template._id;template.amazon_s3_url?playPauseAudio(audioId):(document.getElementById("audioFilePlay"+audioId)&&document.getElementById("audioFilePlay"+audioId).setAttribute("src","assets/callburn/images/images/blue-audio-spinner.svg"),$rootScope.getAmazonUrlOfAudio(template._id).then(function(url){document.getElementById("audioFilePlay"+audioId)&&(document.getElementById("audioFilePlay"+audioId).setAttribute("src","/assets/callburn/images/stop.svg"),$scope.currentCampaign.voice_file.amazon_s3_url=url,playPauseAudio(audioId,url))}))};var playPauseAudio=function(audioId,url){var audio=document.getElementById("campaignAudio");url&&audio.setAttribute("src",url),$scope.isRecordedFilePlaying?(audio.pause(),audio.currentTime=0,document.getElementById("audioFilePlay"+audioId)&&(document.getElementById("audioFilePlay"+audioId).setAttribute("src","/assets/callburn/images/play.svg"),document.getElementById("audioFilePlayText"+audioId).innerHTML="&nbsp;&nbsp;Play")):(audio.play(),document.getElementById("audioFilePlay"+audioId).setAttribute("src","/assets/callburn/images/stop.svg"),document.getElementById("audioFilePlayText"+audioId).innerHTML="&nbsp;Pause",audio.addEventListener("ended",function(){$scope.isRecordedFilePlaying=!1,document.getElementById("audioFilePlay"+audioId)&&(document.getElementById("audioFilePlay"+audioId).setAttribute("src","/assets/callburn/images/play.svg"),document.getElementById("audioFilePlayText"+audioId).innerHTML="&nbsp;&nbsp;Play")},!1)),$scope.isRecordedFilePlaying=!$scope.isRecordedFilePlaying};$scope.sendAgain=function(phonenumber){var pushingObject={number:phonenumber.phone_no,status:"success",tariff:phonenumber.tariff},sendingPhonenumbers=[];sendingPhonenumbers.push(pushingObject),$state.go("campaign.compose",{phonenumbers:sendingPhonenumbers})},$scope.openExportModal=function(campaign){CallBournModal.open({scope:{},templateUrl:"/app/modals/campaign-export/campaign-export.html"},function(scope){scope.close=function(){CallBournModal.close()},scope.exportHandler=function(fileFormat){$scope.exportCampaign(fileFormat),CallBournModal.close()}})},$scope.exportCampaign=function(fileFormat){$scope.exportCampaignLoader=!0,$scope.filterData.file_format=fileFormat,Restangular.all("phonenumbers/export-statistics").post($scope.filterData).then(function(data){0===data.resource.error.no?($scope.exportCampaignLoader=!1,growl.success($rootScope.trans("email_will_be_sent_to_you"))):($scope.exportCampaignLoader=!1,growl.error($rootScope.trans("email_will_not_be_sent_to_you")))})},window.document.title=0===$scope.notSeenNotificationsCount?"Messages - Callburn":"("+$scope.notSeenNotificationsCount+") Messages - Callburn";var convertedAudioTooltips={};$scope.getTooltipHtml=function(campaign){if(campaign.voice_file){if(convertedAudioTooltips.hasOwnProperty(campaign._id))return convertedAudioTooltips[campaign._id];if("TTS"===campaign.voice_file.type)var name=$filter("limitTo")(campaign.voice_file.tts_text,25);else if("UPLOADED"===campaign.voice_file.type)var name=campaign.voice_file.orig_filename;var str='<p><span class="in_blue">Name</span>: '+name+"</p>";return str=str+'<p class="in_blue">'+campaign.voice_file.type+" - "+$filter("audioDuration")(campaign.voice_file.length)+"</p>",str=str+'<div class="stop-play left"> <img src="/assets/callburn/images/play.svg" class="compose_method3_icons" id="audioFilePlay'+campaign.voice_file._id+'"style="cursor:pointer;width:20px;" onclick="playPauseRecordedAudio('+campaign._id+')"/><span id="audioFilePlayText'+campaign.voice_file._id+'">&nbsp;&nbsp;Play</span> </div>',str=$sce.trustAsHtml(str),convertedAudioTooltips[campaign._id]=str,str}},$scope.getAudioTooltipHtml=function(campaign,action){if(campaign){if("callback"==action)var voiceFileId=campaign.callback_digit_file_id;else if("donotcall"==action)var voiceFileId=campaign.do_not_call_digit_file_id;else var voiceFileId=campaign.campaign_voice_file_id;var str='<audio src="'+apiUrl+"?key="+$rootScope.currentUser.api_token+"&file_id="+voiceFileId+'" controls style="display:none;" id="campaignAudio'+voiceFileId+'"></audio>';return str=str+'<img src="/assets/callburn/images/play.png" class="compose_method3_icons" onclick="playAudio('+voiceFileId+')" />&nbsp;&nbsp;Play <br><br>',str=str+'<img src="/assets/callburn/images/stop1.png" class="compose_method3_icons" onclick="pauseAudio('+voiceFileId+')" />&nbsp;&nbsp;Pause '}},$scope.addToBlacklist=function(number,name){var data={phonenumbers:[+number],name:name,campaign_id:$scope.currentCampaign._id};Restangular.all("address-book/add-black-list").post(data).then(function(data){if(0==data.resource.error.no){growl.success($rootScope.trans("contact_added_to_blacklist"));var elemPos=$scope.phonenumbers.map(function(item){return item.phone_no}).indexOf(number);$scope.phonenumbers[elemPos].black_list=[{number:number}]}else 0!=data.resource.error.no&&growl.error($rootScope.trans(data.resource.error.text))})},$scope.removeFromBlacklist=function(contact_id,phone_id,id){var data={phonenumber_ids:[id]};Restangular.all("address-book/remove-black-list").post(data).then(function(data){if(0===data.resource.error.no){var elemPos=$scope.phonenumbers.map(function(phonenumber){if(phonenumber._id==contact_id)return phonenumber._id}).indexOf(contact_id);$scope.phonenumbers[elemPos].black_list={}}})};var isPhonenumbersEmpty=function(){for(index in $scope.checkedPhonenumbers)if($scope.checkedPhonenumbers[index])return!1;return!0};window.playAudio=function(id){var audio=document.getElementById("campaignAudio"+id);audio.play()},window.pauseAudio=function(id){var audio=document.getElementById("campaignAudio"+id);audio.pause()},$scope.getFirstElemet=function(){for(var index in $scope.campaignRepeats)return $scope.campaignRepeats[index].showAttr},$scope.getTotalTime=function(phonenumber){return phonenumber.total_cost},$scope.getDuration=function(phonenumber){return phonenumber.total_duration},$scope.showAllAttempts=function(phonenumber){CallBournModal.open({scope:{calls:phonenumber.calls},templateUrl:"/app/modals/campaign-statistics/show-attemps-modal.html"},function(scope){scope.getTranslatedStatus=function(status){switch(status){case"SENT_TO_ASTERISK":return $rootScope.trans("campaign_statistics_status_sent_to_asterix");case"DIALLED":return $rootScope.trans("campaign_statistics_status_dialled");case"CHANNEL_UNAVAILABLE":return $rootScope.trans("campaign_statistics_status_channel_unavailable");case"CONGESTION":return $rootScope.trans("campaign_statistics_status_congestion");case"BUSY":return $rootScope.trans("campaign_statistics_status_busy");case"NO_ANSWER":return $rootScope.trans("campaign_statistics_status_no_answer");case"ANSWERED":return $rootScope.trans("campaign_statistics_status_answer");case"BLACKLISTED":return $rootScope.trans("campaign_statistics_status_blacklisted");case"TRANSFER":return $rootScope.trans("campaign_statistics_status_transfer");case"ERROR_MARKED":return $rootScope.trans("campaign_statistics_status_error_marked");case"FATAL_ERROR":return $rootScope.trans("campaign_statistics_status_fatal_error")}},scope.close=function(){CallBournModal.close()}})},$scope.getCampaignStatusText=function(campaign){if("scheduled"===campaign.status&&campaign.first_scheduled_date)for(var i=0;i<campaign.schedulations.length;i++)if(!campaign.schedulations[i].is_finished){var nextSchedule=moment(moment.tz(campaign.schedulations[i].scheduled_date,"YYYY-MM-DD HH:mm:ss","utc")._d).add(1,"minute"),duration=moment().diff(nextSchedule),humanize=humanizeDuration(duration,{units:["d","h","m"],round:!0,language:$rootScope.currentLanguage});return trans("next_run_in")+" "+humanize}var updatedAt=moment(campaign.updated_at,"YYYY-MM-DD HH:mm:ss").tz($scope.serverTimezone).format("YYYY-MM-DD HH:mm:ss"),createdAt=moment(campaign.created_at,"YYYY-MM-DD HH:mm:ss").tz($scope.serverTimezone).format("YYYY-MM-DD HH:mm:ss");return"dialing_completed"===campaign.status?trans("completed_on")+" "+$filter("localDate")(updatedAt):"start"!==campaign.status||campaign.schedulation_original_data?"schedulation_in_progress"===campaign.status?trans("started_on")+" "+$filter("localDate")(updatedAt):"saved"===campaign.status?trans("saved_on")+" "+$filter("localDate")(createdAt):"stop"===campaign.status?trans("manually_stopped_on")+" "+$filter("localDate")(updatedAt):null:trans("started_on")+" "+$filter("localDate")(createdAt)},$scope.getStatusClass=function(campaign){if($rootScope.currentUser.balance<=0){if("dialing_completed"!==campaign.status&&"saved"!==campaign.status)return"dark_orange snippet_blinking"}else{if("stop"===campaign.status)return"dark_orange";if("stopped_low_balance"===campaign.status)return"dark_orange";if("saved"===campaign.status)return"schedulation-in-progress-status";if("dialing_completed"===campaign.status)return"sent-statistics-status";if("schedulation_idle"===campaign.status)return"schedulation-idle-status";if("scheduled"===campaign.status)return"schedulate-status";if("start"===campaign.status)return"save-as-draft-status";if("schedulation_in_progress"===campaign.status)return"save-as-draft-status snippet_blinking"}},$scope.getCostOfCampaign=function(campaign){return campaign.amount_spent},$scope.getSuccessOfCampaign=function(campaign){return campaign.success_phonenumbers[0]?campaign.success_phonenumbers[0].count:0},$scope.getTotalOfCampaign=function(campaign){return campaign.totalRecipientsIfGroups?campaign.totalRecipientsIfGroups:campaign.total_phonenumbers[0]?campaign.total_phonenumbers[0].count:0},$scope.hideOnDisabled=!1,$scope.getCampaignStatus=function(campaign){if(1==campaign.is_first_run&&"saved"!==campaign.status&&"scheduled"!==campaign.status&&"stop"!==campaign.status&&"schedulation_idle"!==campaign.status)return $rootScope.trans("in_process");switch(campaign.status){case"stopped_low_balance":return $rootScope.trans("stopped_low_balance");case"dialing_completed":return $rootScope.trans("campaign_overview_chackbox_dialing_completed");case"start":return campaign.schedulation_original_data?$rootScope.currentUser.balance>0?$rootScope.trans("campaign_overview_chackbox_dialing_scheduled"):($scope.hideOnDisabled=!0,$rootScope.trans("low_balance_disabled")):$rootScope.currentUser.balance>0?$rootScope.trans("campaign_sending_in_progress"):($scope.hideOnDisabled=!0,$rootScope.trans("low_balance_disabled"));case"saved":return $rootScope.trans("campaign_overview_chackbox_dialing_saved");case"scheduled":return $rootScope.currentUser.balance>0?$rootScope.trans("campaign_overview_chackbox_dialing_scheduled"):($scope.hideOnDisabled=!0,$rootScope.trans("low_balance_disabled"));case"schedulation_idle":return $rootScope.currentUser.balance>0?$rootScope.trans("campaign_overview_chackbox_schedulation_idle"):$rootScope.trans("low_balance_disabled");case"stop":return $rootScope.currentUser.balance>0?$rootScope.trans("campaign_overview_chackbox_dialing_stopped"):$rootScope.trans("low_balance_disabled");case"schedulation_in_progress":return $rootScope.currentUser.balance>0?$rootScope.trans("campaign_sending_in_progress"):$rootScope.trans("low_balance_disabled");default:return""}},$scope.accessForMarkAsCompleted=function(campaign){return"stop"===campaign.status},$scope.transferClass=function(phonenumber){phonenumber.actions_log.forEach(function(item){return"TRANSFER_ENDED"==item.call_status?$scope.transClass="sent-statistics-status":"TRANSFER_REQUESTED"==item.call_status||"TRANSFER_CONNECTED"==item.call_status?$scope.transClass="dark_orange":void 0})},$scope.multiselectOptionsMessageStatisticsDataCallback=function(){var q=$q.defer();return $scope.multiselectOptionsMessageStatisticsStatusData?q.resolve($scope.multiselectOptionsMessageStatisticsStatusData):($interval(function(){if($scope.multiselectOptionsMessageStatisticsStatusData)return q.resolve($scope.multiselectOptionsMessageStatisticsStatusData)},500),q.promise)},$scope.multiselectOptionsMessageStatisticsDataCallback().then(function(data){$scope.checkedOptionsModel=[],$scope.checkedInteractionsOptionsModel=[],$scope.multiSelectEventsStatuses.onSelectionChanged(),$scope.multiSelectEventsInteractions.onSelectionChanged()}),$scope.multiselectMessageStatisticsStatusSettings={template:"{{option.label}}",buttonClasses:""},$scope.multiSelectEventsStatuses={onSelectionChanged:function(){$scope.checkedOptions=[],$scope.filterData.page=0,$scope.page=1,$scope.checkedOptionsModel.forEach(function(option){$scope.checkedOptions.push(option.id),$scope.checkedOptionsModel.length>0&&($scope.checkedInteractionsOptionsModel.length=0)}),$scope.filterData.actions=null,$scope.filterData.statuses=JSON.stringify($scope.checkedOptions),$scope.firstLoadForStatuses||$scope.filterChanged(),$scope.firstLoadForStatuses=!1}},$scope.multiSelectEventsInteractions={onSelectionChanged:function(){$scope.checkedInteractionsOptions=[],$scope.filterData.page=0,$scope.page=1,$scope.checkedInteractionsOptionsModel.forEach(function(option){$scope.checkedInteractionsOptions.push(option.id),$scope.checkedInteractionsOptions.length>0&&($scope.checkedOptionsModel.length=0)}),$scope.filterData.statuses=null,$scope.filterData.actions=JSON.stringify($scope.checkedInteractionsOptions),$scope.firstLoadForInteractions||$scope.filterChanged(),$scope.firstLoadForInteractions=!1}},$scope.showStatusLoader=!1,$scope.reuseCampaign=function(campaign){},$scope.reuseReceipents=function(campaignId){},$scope.reuseMessage=function(campaignId){},$scope.changeMessageStatus=function(status,campaign){id=campaign._id,$scope.showStatusLoader=!0,Restangular.all("campaigns/update-campaign-status").post({status:status,campaign_id:id}).then(function(data){if(0===data.resource.error.no){var copy=Object.assign({},campaign);$scope.showStatusLoader=!1,copy.status=status,$scope.currentCampaign=copy}})},$scope.showSearch=!1,$scope.StatsEnterPress=function(key){13===key.which?$scope.searchPhonenumbers():null},$scope.toggleSearch=function(){$scope.showSearch&&$rootScope.importantShowSearch?$scope.searchPhonenumbers():$scope.showSearch=!0},$scope.filterBy=function(field){return $scope.activeFilterField==field?($scope.filterChanged(),$scope.activeFilterField=null,$scope.filterData.only=null,void($scope.filterData.except=null)):($scope.activeFilterField=field,$scope.currentPage=1,$scope.page=1,$scope.filterData.page=0,"delivered"==field?($scope.filterData.only="status",$scope.filterData.except=null):"not_delivered"==field&&($scope.filterData.except="status",$scope.filterData.only=null),void $scope.changePage(1))},$scope.resetFilters=function(){$scope.filterData=$stateParams,$scope.activeFilterInteraction=null,$scope.activeFilterField=null,$scope.filterData.except=null,$scope.filterData.only=null,$scope.filterData.actions=null,$scope.filterChanged()},$scope.filterInteraction=function(filterType){$scope.activeFilterInteraction=filterType,$scope.checkedInteractionsOptions=[],$scope.filterData.page=0,$scope.page=1,$scope.multiselectOptionsMessageStatisticsInteractionsData.forEach(function(option){option.id==filterType&&$scope.checkedInteractionsOptions.push(option.id)}),$scope.filterData.statuses=null,$scope.filterData.actions=JSON.stringify($scope.checkedInteractionsOptions),$scope.firstLoadForInteractions||$scope.filterChanged(),$scope.firstLoadForInteractions=!1},$scope.resetInteractionFilter=function(type){$scope.activeFilterInteraction=null,$scope.checkedInteractionsOptions=[],$scope.filterData.actions=null,$scope.filterChanged()},setTimeout(function(){var seriesA=angular.element(".ct-series-a")[1],seriesB=angular.element(".ct-series-b")[1],seriesC=angular.element(".ct-series-c")[0],seriesD=angular.element(".ct-series-d")[0];seriesA&&seriesA.addEventListener("click",function(){"REPLAY_REQUESTED"==$scope.activeFilterInteraction?(angular.element(".ct-bars .ct-series-a").removeClass("active"),$scope.resetInteractionFilter("REPLAY_REQUESTED")):(angular.element(".ct-bars .ct-series-a").addClass("active"),angular.element(".ct-bars .ct-series-b").removeClass("active"),angular.element(".ct-bars .ct-series-c").removeClass("active"),angular.element(".ct-bars .ct-series-d").removeClass("active"),$scope.filterInteraction("REPLAY_REQUESTED"))}),seriesB&&seriesB.addEventListener("click",function(){"TRANSFER_REQUESTED"==$scope.activeFilterInteraction?(angular.element(".ct-bars .ct-series-b").removeClass("active"),$scope.resetInteractionFilter("TRANSFER_REQUESTED")):(angular.element(".ct-bars .ct-series-b").addClass("active"),angular.element(".ct-bars .ct-series-a").removeClass("active"),angular.element(".ct-bars .ct-series-c").removeClass("active"),angular.element(".ct-bars .ct-series-d").removeClass("active"),$scope.filterInteraction("TRANSFER_REQUESTED"))}),seriesC&&seriesC.addEventListener("click",function(){"CALLBACK_REQUESTED"==$scope.activeFilterInteraction?(angular.element(".ct-bars .ct-series-c").removeClass("active"),$scope.resetInteractionFilter("CALLBACK_REQUESTED")):(angular.element(".ct-bars .ct-series-c").addClass("active"),angular.element(".ct-bars .ct-series-a").removeClass("active"),angular.element(".ct-bars .ct-series-b").removeClass("active"),angular.element(".ct-bars .ct-series-d").removeClass("active"),$scope.filterInteraction("CALLBACK_REQUESTED"))}),seriesD&&seriesD.addEventListener("click",function(){"DONOTCALL_REQUESTED"==$scope.activeFilterInteraction?(angular.element(".ct-bars .ct-series-d").removeClass("active"),$scope.resetInteractionFilter("DONOTCALL_REQUESTED")):(angular.element(".ct-bars .ct-series-d").addClass("active"),angular.element(".ct-bars .ct-series-a").removeClass("active"),
angular.element(".ct-bars .ct-series-b").removeClass("active"),angular.element(".ct-bars .ct-series-c").removeClass("active"),$scope.filterInteraction("DONOTCALL_REQUESTED"))})},1e3),$scope.filterOrReset=function(type){switch(type){case"REPLAY_REQUESTED":"REPLAY_REQUESTED"==$scope.activeFilterInteraction?(angular.element(".ct-bars .ct-series-a").removeClass("active"),$scope.resetInteractionFilter("REPLAY_REQUESTED")):(angular.element(".ct-bars .ct-series-a").addClass("active"),angular.element(".ct-bars .ct-series-b").removeClass("active"),angular.element(".ct-bars .ct-series-c").removeClass("active"),angular.element(".ct-bars .ct-series-d").removeClass("active"),$scope.filterInteraction("REPLAY_REQUESTED"));break;case"TRANSFER_REQUESTED":"TRANSFER_REQUESTED"==$scope.activeFilterInteraction?(angular.element(".ct-bars .ct-series-b").removeClass("active"),$scope.resetInteractionFilter("TRANSFER_REQUESTED")):(angular.element(".ct-bars .ct-series-b").addClass("active"),angular.element(".ct-bars .ct-series-a").removeClass("active"),angular.element(".ct-bars .ct-series-c").removeClass("active"),angular.element(".ct-bars .ct-series-d").removeClass("active"),$scope.filterInteraction("TRANSFER_REQUESTED"));break;case"CALLBACK_REQUESTED":"CALLBACK_REQUESTED"==$scope.activeFilterInteraction?(angular.element(".ct-bars .ct-series-c").removeClass("active"),$scope.resetInteractionFilter("CALLBACK_REQUESTED")):(angular.element(".ct-bars .ct-series-c").addClass("active"),angular.element(".ct-bars .ct-series-a").removeClass("active"),angular.element(".ct-bars .ct-series-b").removeClass("active"),angular.element(".ct-bars .ct-series-d").removeClass("active"),$scope.filterInteraction("CALLBACK_REQUESTED"));break;case"DONOTCALL_REQUESTED":"DONOTCALL_REQUESTED"==$scope.activeFilterInteraction?(angular.element(".ct-bars .ct-series-d").removeClass("active"),$scope.resetInteractionFilter("DONOTCALL_REQUESTED")):(angular.element(".ct-bars .ct-series-d").addClass("active"),angular.element(".ct-bars .ct-series-a").removeClass("active"),angular.element(".ct-bars .ct-series-b").removeClass("active"),angular.element(".ct-bars .ct-series-c").removeClass("active"),$scope.filterInteraction("DONOTCALL_REQUESTED"))}},$scope.OpenMarUnmarkModal=function(phonenumber){CallBournModal.open({scope:{markData:{comment:""},phonenumber:phonenumber,comments:JSON.parse(phonenumber.comment)||[]},templateUrl:"/app/modals/campaign-statistics/mark-unmark.html"},function(scope){scope.close=function(){CallBournModal.close()},scope.save=function(comment){scope.comments.push(comment);var postData={comments:scope.comments,phonenumberId:scope.phonenumber._id};scope.phonenumber.marked=!scope.phonenumber.marked,Restangular.all("phonenumbers/add-comment").post(postData).then(function(data){scope.markData.comment="",scope.comments=data.resource.comment,scope.phonenumber.comment=scope.comments,$scope.filterChanged(),scope.close()})}})},$scope.MarkOrUnmarkPhonenumber=function(id){},$scope.showGroupNames=function(groups){var dataToShow="";return groups.forEach(function(item){dataToShow+=item.name+"<br>"}),$sce.trustAsHtml(dataToShow)},$scope.clockHover=function(data,pastDate){var dateData=[],dataToShow="";return data.forEach(function(item){var date=moment(item.scheduled_date).tz($rootScope.currentUser.timezone).format("MMMM Do YYYY, HH:mm");if(!moment().tz($rootScope.currentUser.timezone).isBefore(date))var past=!0;dateData.push({date:date,recipients:item.recipients,past:past})}),dateData.forEach(function(data,index){(pastDate&&data.past||!pastDate&&!data.past)&&(dataToShow+=data.date+" - "+data.recipients+" "+$rootScope.trans("compose_step_3_text_recipients")+";<br>")}),$sce.trustAsHtml(dataToShow)},$scope.clockHoverPast=function(data){var dateData=[],dataToShow="";return data.forEach(function(item){var date=moment(item.scheduled_date).tz($rootScope.currentUser.timezone).format("MMMM Do YYYY, HH:mm");if(!moment().tz($rootScope.currentUser.timezone).isBefore(date))var past=!0;dateData.push({date:date,recipients:item.recipients,past:past})}),dateData.forEach(function(data,index){data.past&&(dataToShow+=data.date+" - "+data.recipients+" "+$rootScope.trans("compose_step_3_text_recipients")+";<br>")}),$sce.trustAsHtml(dataToShow)},$scope.getDeliveredHour=function(data){if(data){var hour=moment(data).format("HH:mm:ss");return hour}},$scope.getDeliveredDate=function(data){if(data){var date=moment(data).format("YYYY-MM-DD");return date}},$scope.getUpdatedAt=function(date,type){var serverTimezoneDate=moment.tz(date,"YYYY-MM-DD HH:mm:ss",window.SERVER_TIMEZONE);if("updated"===type)return moment(serverTimezoneDate).fromNow();var updatedAt=serverTimezoneDate.clone().tz($rootScope.currentUser.timezone).format("YYYY-MM-DD HH:mm:ss");return $filter("localDate")(updatedAt)},$scope.getSuccessSmsVoiceOfCampaign=function(campaign){return $scope.smsCount=campaign.total_phonenumbers[0].count&&(campaign.is_archived&&campaign.archived_sms_count[0]&&campaign.archived_sms_count[0].count||0||!campaign.is_archived&&campaign.sms_count[0]&&campaign.sms_count[0].count||0)||0,$scope.voiceCount=campaign.total_phonenumbers[0].count&&(campaign.is_archived&&campaign.success_phonenumbers[0]&&campaign.success_phonenumbers[0].count-(campaign.archived_sms_count[0]&&campaign.archived_sms_count[0].count||0)||0||!campaign.is_archived&&campaign.success_phonenumbers[0]&&campaign.success_phonenumbers[0].count-(campaign.sms_count[0]&&campaign.sms_count[0].count||0)||0),$scope.voiceCount+" "+$rootScope.trans("dashboard_welcome_voice_messages")+" & "+$scope.smsCount+" SMS"},$scope.calcSmsText=function(sms_text){var txt=sms_text.length,num=0;return txt>=0&&txt<=160?(num=1," "+$rootScope.trans("compose_step_1_method_1_characters_count")+": "+txt+" - "+num+" SMS"):txt>=161&&txt<=320?(num=2," "+$rootScope.trans("compose_step_1_method_1_characters_count")+": "+txt+" - "+num+" SMS"):txt>=321&&txt<=480?(num=3," "+$rootScope.trans("compose_step_1_method_1_characters_count")+": "+txt+" - "+num+" SMS"):txt>=481&&txt<=640?(num=4," "+$rootScope.trans("compose_step_1_method_1_characters_count")+": "+txt+" - "+num+" SMS"):txt>=641&&txt<=800?(num=5," "+$rootScope.trans("compose_step_1_method_1_characters_count")+": "+txt+" - "+num+" SMS"):txt>=801&&txt<=960?(num=6," "+$rootScope.trans("compose_step_1_method_1_characters_count")+": "+txt+" - "+num+" SMS"):void 0},$scope.calcSmsTextSmsCount=function(sms_text){var txt=sms_text.length,num=0;return txt>=0&&txt<=160?(num=1,"X"+num):txt>=161&&txt<=320?(num=2,"X"+num):txt>=321&&txt<=480?(num=3,"X"+num):txt>=481&&txt<=640?(num=4,"X"+num):txt>=641&&txt<=800?(num=5,"X"+num):txt>=801&&txt<=960?(num=6,"X"+num):void 0}}]);