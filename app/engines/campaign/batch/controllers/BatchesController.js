angular.module("callburnApp").controller("BatchesController",["$scope","$rootScope","$state","$stateParams","FileUploader","$sce","$timeout","BatchesService","CallBournModal","ttsLanguages","CallBournScrollTop","$location","growl","Restangular","SettingsService","audioFiles","CampaignComposeService",function($scope,$rootScope,$state,$stateParams,FileUploader,$sce,$timeout,BatchesService,CallBournModal,ttsLanguages,CallBournScrollTop,$location,growl,Restangular,SettingsService,audioFiles,CampaignComposeService){$scope.availableTts={"Alice-ML":!0,"Anna-ML":!0,Daniel:!0,Ellen:!0,Empar:!0,Joana:!0,Jordi:!0,Lekha:!0,Milena:!0,Monica:!0,Paulina:!0,Samantha:!0,Satu:!0,Tarik:!0,Thomas:!0,Zosia:!0},$rootScope.tutorialSidePopup=!1,$scope.CampaignComposeService=CampaignComposeService,$rootScope.currentActiveUrl=$state.current.name,$scope.finalStepData={sendingTime:3},$scope.isFileUploaded=0,$scope.callbackAudioFiles=[],$scope.resipentsCount=1,$scope.CampaignComposeService.ttsLanguages=ttsLanguages.resource.languages,$scope.chosedInteractions=[],$scope.interactionsForModal=[],$scope.campaignData={remaining_repeats:0,repeat_days_interval:0,caller_id:$rootScope.currentUser.numbers.length>0?$rootScope.currentUser.numbers[0].phone_number:{},playback_count:1},$scope.replayDigit={onOff:!1},$scope.transferDigit={onOff:!1},$scope.callbackDigit={onOff:!1},$scope.doNotCallDigit={onOff:!1},$scope.CampaignComposeService.ttsLanguages.forEach(function(item){item.selectView=item.languageName+"-"+item.ttsEngine}),$scope.CampaignComposeService.audioTemplates=audioFiles.resource,$scope.CampaignComposeService.audioTemplates.files.forEach(function(item){item.selectView=item.orig_filename+" - "+item.length}),$scope.getTTSUrl=function(){return $sce.trustAsResourceUrl("/assets/callburn/tts/"+$scope.campaignData.tts_language+".wav")},$scope.playTTSDemo=function(){document.getElementById("ttsDemoAudio").play()},$scope.storeFromData={},$scope.reloadUsersData=function(){SettingsService.getShowUser().then(function(data){data.resource.user_data&&($rootScope.currentUser=data.resource.user_data)})},$scope.hasEnoughBalanceToValidate=function(){var messageCost=$scope.finalStepData.maxCost,freeBalance=$rootScope.currentUser.balance-$scope.finalStepData.maxGiftCost-$rootScope.currentUser.retainedBalance;return freeBalance>messageCost},$scope.changePlaybackCount=function(count){$scope.campaignData.playback_count=count},$scope.getPlaybackCount=function(count){return $scope.campaignData.playback_count==count},$scope.changeRepeatsCount=function(action){"-"==action&&$scope.campaignData.remaining_repeats>0&&($scope.campaignData.remaining_repeats=Number($scope.campaignData.remaining_repeats)-1),"+"==action&&($scope.campaignData.remaining_repeats=Number($scope.campaignData.remaining_repeats)+1)};var campaignBatchFileUpload=$scope.campaignBatchFileUpload=new FileUploader({url:"/phonenumbers/validate-batch-file",alias:"file",autoUpload:!0,formData:[$scope.batchTtsData]});campaignBatchFileUpload.onAfterAddingFile=function(item){$rootScope.disableButton(),$scope.uploadingBatchName=item.file.name},campaignBatchFileUpload.onSuccessItem=function(item,response){$rootScope.enabledButton(),response.resource&&0==response.resource.error.no?0==response.resource.phonenumbers.length?growl.error($rootScope.trans("No__valid_phone_numbers")):($scope.campaignData.phonenumbers_with_text=response.resource.phonenumbers_with_text,$scope.finalStepData.maxCost=response.resource.max_cost,$scope.finalStepData.maxGiftCost=response.resource.max_gift_cost,$scope.finalStepData.numbersCount=response.resource.phonenumbers.length,$scope.pagesCount=Math.ceil(response.resource.phonenumbers.length/10),$scope.isFileUploaded=1,setTimeout(function(){window.scrollTo(0,document.body.scrollHeight)},1e3)):growl.error($rootScope.trans("File_format_not_supported"))},campaignBatchFileUpload.onErrorItem=function(item,response){$rootScope.enabledButton(),$scope.errors=response},$scope.startBatchFileUpload=function(){campaignBatchFileUpload.uploadAll()},$scope.openCampaignVoiceFileSelect=function(){$timeout(function(){angular.element("#campaignDoNotCallFileInput").trigger("click")},100)},$scope.hasInArray=function(array,item){for(var j=0;j<array.length;j++)if(array[j]===item)return!0;return!1},$scope.showReplayModal=function(){$scope.replayDigit.onOff=!1,CallBournModal.open({scope:{$scope:$scope,CampaignComposeService:CampaignComposeService},templateUrl:"/app/modals/camping-batch/activate-replay.html"},function(scope){$scope.CampaignComposeService.replayDigit.checkboxChecked=!1,scope.replyDigitActivated=function(){CampaignComposeService.replayDigit.checkboxChecked&&($scope.replayDigit.onOff=!0,CallBournModal.close(),CallBournModal.open({scope:{chosedInteractions:$scope.chosedInteractions,hasInArray:$scope.hasInArray},templateUrl:"/app/modals/camping-batch/dijit-choosen.html"},function(scope){scope.selectInteraction=function(interaction){$scope.campaignData.replay_digit=interaction,$scope.chosedInteractions[0]=interaction,CallBournModal.close()}}))}})},$scope.showTransferModal=function(){$scope.transferDigit.onOff=!1,$scope.transferDigit.checkboxChecked=!1,CallBournModal.open({scope:{$scope:$scope,currentUser:$rootScope.currentUser,liveTransferNumbers:[],transferStep:1,CampaignComposeService:$scope.CampaignComposeService,campaignData:$scope.campaignData},templateUrl:"/app/modals/camping-batch/activate-transfer.html",size:"modal-md"},function(scope){scope.transferLimit={1:{value:1},2:{value:2},3:{value:3},4:{value:4},5:{value:5},6:{value:6},7:{value:7},8:{value:8},9:{value:9},10:{value:10}},$scope.liveTransferNumbers=[],scope.activateTransferDigit=function(){CampaignComposeService.transferDigit.checkboxChecked&&($scope.transferDigit.onOff=!0,$scope.campaignData.transfer_options=scope.liveTransferNumbers.join(),CallBournModal.close(),CallBournModal.open({scope:{chosedInteractions:$scope.chosedInteractions,hasInArray:$scope.hasInArray},templateUrl:"/app/modals/camping-batch/dijit-choosen.html"},function(scope){scope.selectInteraction=function(interaction){$scope.campaignData.transfer_digit=interaction,$scope.chosedInteractions[1]=interaction,CallBournModal.close()}}))},scope.addRemoveTransfer=function(number,tariffId){var index=scope.liveTransferNumbers.indexOf(number);index>-1?scope.liveTransferNumbers.splice(index,1):scope.liveTransferNumbers.push(number)},scope.chnageTransferStep=function(step){scope.transferStep=step}})},$scope.showCallbackModal=function(){$scope.callbackDigit.onOff=!1,$scope.callbackDigit.checkboxChecked=!1,CallBournModal.open({scope:{availableTts:$scope.availableTts,ttsLanguages:$scope.ttsLanguage,callbackTtsData:{},uploadingCallbackAudioName:"",tempAudioTemplateModel:{},callbackAudioFiles:[],callbackStep:1,checkedAll:!1,CampaignComposeService:CampaignComposeService},templateUrl:"/app/modals/camping-batch/activate-callback.html",size:"modal-md"},function(scope){scope.activateCallbackDigit=function(){$scope.callbackDigit.onOff=!0,CallBournModal.close(),CallBournModal.open({scope:{chosedInteractions:$scope.chosedInteractions,hasInArray:$scope.hasInArray},templateUrl:"/app/modals/camping-batch/dijit-choosen.html"},function(scope){scope.selectInteraction=function(interaction){$scope.campaignData.callback_digit=interaction,$scope.chosedInteractions[2]=interaction,CallBournModal.close()}})},scope.changeCallbackStep=function(step){scope.callbackStep=step},scope.openBatchFileSelect=function(){$timeout(function(){angular.element("#campaignBatchFileInput").trigger("click")},100)},scope.checkAll=function(){return!$scope.callbackDigit.checkboxChecked},scope.callbackAudioTemplateSelected=function(file){scope.selectedCallbackAudioTemplateFile=file},scope.selectCallbackNewCreatedAudioFile=function(file){scope.newCallbackSelectedAudioFile=file.file,$scope.campaignData.callback_voice_file_id=file.file._id},scope.playPauseCallbackTemplateAudio=function(action){if(scope.selectedCallbackAudioTemplateFile._id){var audio=document.getElementById("callbackAudioFileTemplate");"play"==action?(audio.play(),scope.isCallbackTemplateFilePlaying=!0,audio.addEventListener("ended",function(){scope.isCallbackTemplateFilePlaying=!1,scope.$apply()},!1)):(audio.pause(),scope.isCallbackTemplateFilePlaying=!1)}},scope.playPauseCallbackNewCreatedAudio=function(action){if(scope.newCallbackSelectedAudioFile._id){var audio=(scope.newCallbackSelectedAudioFile._id,document.getElementById("callbackCreatedAudioFile"));"play"==action?(audio.play(),scope.isCallbackNewCreatedFilePlaying=!0,audio.addEventListener("ended",function(){scope.isCallbackNewCreatedFilePlaying=!1,scope.$apply()},!1)):(audio.pause(),scope.isCallbackNewCreatedFilePlaying=!1)}},scope.saveTemplateAsCallback=function(){scope.callbackAudioFiles.push({file:scope.selectedCallbackAudioTemplateFile,name:scope.selectedCallbackAudioTemplateFile.map_filename+" - "+scope.selectedCallbackAudioTemplateFile.length})},scope.isCallbackAlreadyAdded=function(){if(!scope.selectedCallbackAudioTemplateFile)return!1;for(index in scope.callbackAudioFiles)return scope.callbackAudioFiles[index].file._id==scope.selectedCallbackAudioTemplateFile._id},scope.callbackDigitFileUpload=new FileUploader({url:"/campaigns/upload-audio-file",alias:"file",autoUpload:!0}),scope.callbackDigitFileUpload.onAfterAddingFile=function(item){$rootScope.startModalLoader(),scope.uploadingAudioName=item.file.name},scope.callbackDigitFileUpload.onSuccessItem=function(item,response,status,headers){if($rootScope.stopModalLoader(),0==response.resource.error.no){scope.uploadingCallbackAudioName=!1;var file=response.resource.file,audioData={source:$sce.trustAsResourceUrl(file.amazon_s3_url),file:file,name:file.orig_filename+" - "+file.length};scope.callbackAudioFiles.push(audioData),growl.success(trans(response.resource.error.message))}else growl.error(trans(response.resource.error.text))},scope.callbackDigitFileUpload.onErrorItem=function(item,response,status,headers){$rootScope.stopModalLoader(),$scope.errors=response},scope.startCallbackUpload=function(){$rootScope.startLoader(),$scope.callbackDigitFileUpload.uploadAll()},scope.openCallbackFileSelect=function(){$timeout(function(){angular.element("#campaignCallbackFileInput").trigger("click")},100)},scope.createAudioFromTextForCallback=function(){$rootScope.startModalLoader(),Restangular.all("campaigns/create-audio-from-text").post(scope.callbackTtsData).then(function(data){if($rootScope.stopModalLoader(),0==data.resource.error.no){scope.callbackTtsData={language:null};var file=data.resource.file,audioData={source:$sce.trustAsResourceUrl(file.amazon_s3_url),file:file,name:file.orig_filename+" - "+file.length};scope.callbackAudioFiles.push(audioData),$scope.CampaignComposeService.audioTemplates.files.push(data.resource.file),$scope.campaignData.callback_voice_file_id=file._id,$scope.CampaignComposeService.audioTemplates.files.forEach(function(item){item.selectView=item.orig_filename+" - "+item.length})}else growl.error(trans(data.resource.error.text))})},scope.getTTSUrl=function(){return $sce.trustAsResourceUrl("/assets/callburn/tts/"+$scope.campaignData.tts_language+".wav")},scope.playTTSDemo=function(){document.getElementById("ttsDemoAudio").play()}})},$scope.showDoNotCallModal=function(){$scope.doNotCallDigit.onOff=!1,$scope.doNotCallDigit.checkboxChecked=!1,CallBournModal.open({scope:{$scope:$scope,availableTts:$scope.availableTts,doNotCallTtsData:{},uploadingDoNotCallAudioName:"",tempAudioTemplateModel:{},doNotCallAudioFiles:[],doNotCallStep:1,checkedAll:!1,CampaignComposeService:$scope.CampaignComposeService},templateUrl:"/app/modals/camping-batch/activate-do-not-call.html",size:"modal-md"},function(scope){scope.activateDoNotCallDigit=function(){$scope.doNotCallDigit.onOff=!0,CallBournModal.close(),CallBournModal.open({scope:{chosedInteractions:$scope.chosedInteractions,hasInArray:$scope.hasInArray},templateUrl:"/app/modals/camping-batch/dijit-choosen.html"},function(scope){scope.selectInteraction=function(interaction){$scope.campaignData.do_not_call_digit=interaction,$scope.chosedInteractions[3]=interaction,CallBournModal.close()}})},scope.changeDoNotCallStep=function(step){scope.doNotCallStep=step},scope.openBatchFileSelect=function(){alert("ok"),$timeout(function(){angular.element("#campaignBatchFileInput").trigger("click")},100)},scope.checkAll=function(){return!CampaignComposeService.callbackDigit.checkboxChecked},scope.doNotCallAudioTemplateSelected=function(file){scope.selectedDoNotCallAudioTemplateFile=file},scope.selectDoNotCallNewCreatedAudioFile=function(file){scope.newDoNotCallSelectedAudioFile=file.file,$scope.campaignData.do_not_call_voice_file_id=file.file._id},scope.playPauseDoNotCallTemplateAudio=function(action){if(scope.selectedDoNotCallAudioTemplateFile._id){var audio=document.getElementById("doNotCallAudioFileTemplate");"play"==action?(audio.play(),scope.isDoNotCallTemplateFilePlaying=!0,audio.addEventListener("ended",function(){scope.isDoNotCallTemplateFilePlaying=!1,scope.$apply()},!1)):(audio.pause(),scope.isDoNotCallTemplateFilePlaying=!1)}},scope.playPauseDoNotCallNewCreatedAudio=function(action){if(scope.newDoNotCallSelectedAudioFile._id){var audio=(scope.newDoNotCallSelectedAudioFile._id,document.getElementById("doNotCallCreatedAudioFile"));"play"==action?(audio.play(),scope.isDoNotCallNewCreatedFilePlaying=!0,audio.addEventListener("ended",function(){scope.isDoNotCallNewCreatedFilePlaying=!1,scope.$apply()},!1)):(audio.pause(),scope.isDoNotCallNewCreatedFilePlaying=!1)}},scope.saveTemplateAsDoNotCall=function(){scope.doNotCallAudioFiles.push({file:scope.selectedDoNotCallAudioTemplateFile,name:scope.selectedDoNotCallAudioTemplateFile.map_filename+" - "+scope.selectedDoNotCallAudioTemplateFile.length})},scope.isDoNotCallAlreadyAdded=function(){if(!scope.selectedDoNotCallAudioTemplateFile)return!1;for(index in scope.doNotCallAudioFiles)return scope.doNotCallAudioFiles[index].file._id==scope.selectedDoNotCallAudioTemplateFile._id},scope.doNotCallDigitFileUpload=new FileUploader({url:"/campaigns/upload-audio-file",alias:"file",autoUpload:!0}),scope.doNotCallDigitFileUpload.onAfterAddingFile=function(item){$rootScope.startModalLoader(),scope.uploadingAudioName=item.file.name},scope.doNotCallDigitFileUpload.onSuccessItem=function(item,response,status,headers){if($rootScope.stopModalLoader(),0==response.resource.error.no){scope.uploadingDoNotCallAudioName=!1;var file=response.resource.file,audioData={source:$sce.trustAsResourceUrl(file.amazon_s3_url),file:file,name:file.orig_filename+" - "+file.length};scope.doNotCallAudioFiles.push(audioData),growl.success(trans(response.resource.error.message))}else growl.error(trans(response.resource.error.text))},scope.doNotCallDigitFileUpload.onErrorItem=function(item,response,status,headers){$scope.errors=response,$rootScope.stopModalLoader()},scope.startDoNotCallUpload=function(){alert("ok"),scope.doNotCallDigitFileUpload.uploadAll()},scope.openDoNotCallFileSelect=function(){$timeout(function(){angular.element("#campaignDoNotCallFileInput").trigger("click")},100)},scope.createAudioFromTextForDoNotCall=function(){$rootScope.startModalLoader(),BatchesService.createAudioFromText(scope.doNotCallTtsData).then(function(data){if($rootScope.stopModalLoader(),0==data.resource.error.no){scope.doNotCallTtsData={},file=data.resource.file;var audioData={source:$sce.trustAsResourceUrl(file.amazon_s3_url),file:file,name:file.orig_filename+" - "+file.length};scope.doNotCallAudioFiles.push(audioData),scope.seletedTemplateId=file._id,$scope.CampaignComposeService.audioTemplates.files.push(data.resource.file),$scope.CampaignComposeService.audioTemplates.files.forEach(function(item){item.selectView=item.orig_filename+" - "+item.length})}})},scope.getTTSUrl=function(){return $sce.trustAsResourceUrl("/assets/callburn/tts/"+$scope.campaignData.tts_language+".wav")},scope.playTTSDemo=function(){document.getElementById("ttsDemoAudio").play()}})},$scope.showChangeDeliverySpeedModal=function(){CallBournModal.open({scope:{campaignData:$scope.campaignData},templateUrl:"/app/modals/camping-batch/change-message-delivery-speed.html"},function(scope){scope.maxSpeedSelect={0:{value:"",text:$rootScope.trans("message_delivery_speed_modal_max_speed")},1:{value:30,text:$rootScope.trans("message_delivery_speed_modal_Inside")+" 30  "+$rootScope.trans("message_delivery_speed_modal_minutes")},2:{value:60,text:$rootScope.trans("message_delivery_speed_modal_Inside")+" 60  "+$rootScope.trans("message_delivery_speed_modal_minutes")},3:{value:90,text:$rootScope.trans("message_delivery_speed_modal_Inside")+" 90  "+$rootScope.trans("message_delivery_speed_modal_minutes")},4:{value:120,text:$rootScope.trans("message_delivery_speed_modal_Inside")+" 120 "+$rootScope.trans("message_delivery_speed_modal_minutes")}},scope.selectSendingTime=function(data){""==data.sending_time?$scope.finalStepData.sendingTime=3:$scope.finalStepData.sendingTime=data.sending_time}})},$scope.changeCallerIdModal=function(){CallBournModal.open({scope:{currentUser:$rootScope.currentUser,selectedCallerId:$scope.campaignData.caller_id},templateUrl:"/app/modals/camping-batch/change-caller-id.html"},function(scope){console.log(scope.currentUser),scope.callerIdSelected=function(number){scope.selectedCallerId=number},scope.changeCallerId=function(){$scope.campaignData.caller_id=scope.selectedCallerId,$scope.campaignData.caller_id=scope.selectedCallerId,CallBournModal.close()}})},$scope.removeOneBatch=function(index){return 1==$scope.campaignData.phonenumbers_with_text.length?void growl.info($rootScope.trans("You_need_to_have_at_least_1_receipent")):($scope.campaignData.phonenumbers_with_text.splice(index,1),void($scope.finalStepData.numbersCount=$scope.finalStepData.numbersCount-1))},$scope.inlineDataChanged=function(whichOne,index,event){var text=$(event.target).text();$scope.campaignData.phonenumbers_with_text[index][whichOne]=text},$scope.page=0,$scope.pagesCount=0,$scope.listingSkip=0,$scope.changePage=function(pageNumber){pageNumber<0||pageNumber>$scope.pagesCount-1||($scope.page=pageNumber,$scope.listingSkip=10*$scope.page)},$scope.saveCampaign=function(){$rootScope.disableButton();var campaignData=$scope.campaignData,isValid=!0,errorMessage="",isInteraction=!1;if($scope.callbackDigit.onOff)if(campaignData.callback_digit&&campaignData.callback_voice_file_id){isInteraction=!0;var callbackDigitObject={action:$rootScope.trans("campaign_compose_compose_step_3_call_me_back"),keypress:campaignData.callback_digit};$scope.interactionsForModal.push(callbackDigitObject)}else isValid=!1,errorMessage="callback_voice_file_required_with_callback_digit";if($scope.doNotCallDigit.onOff)if(campaignData.do_not_call_digit&&campaignData.do_not_call_voice_file_id){isInteraction=!0;var doNotCallDigitObject={action:$rootScope.trans("campaign_compose_compose_step_3_blacklist_me"),keypress:campaignData.do_not_call_digit};$scope.interactionsForModal.push(doNotCallDigitObject)}else isValid=!1,errorMessage="donotcall_voice_file_required_with_donotcall_digit";if($scope.transferDigit.onOff)if(campaignData.transfer_digit&&campaignData.transfer_options){isInteraction=!0;var transferDigitObject={action:$rootScope.trans("campaign_compose_compose_step_3_call_live"),keypress:campaignData.transfer_digit};$scope.interactionsForModal.push(transferDigitObject)}else isValid=!1,errorMessage="transfer_options_required_with_transfer_digit";if($scope.replayDigit.onOff)if(campaignData.replay_digit){isInteraction=!0;var replayDigitObject={action:$rootScope.trans("campaign_compose_compose_step_3_replay_voice_message"),keypress:campaignData.replay_digit};$scope.interactionsForModal.push(replayDigitObject)}else isValid=!1,errorMessage="replay_digit_is_activated_but_not_selected";return isValid?(isInteraction?CallBournModal.open({scope:{interactionsForModal:$scope.interactionsForModal,saveWithInteractionsCheckbox:!1},templateUrl:"/app/modals/camping-batch/confirm-interactions.html"},function(scope){scope.dismissModal=function(){CallBournModal.close()},scope.proceedToSaveWithInteraction=function(){proceedSaveCampaign()}}):proceedSaveCampaign(),void $rootScope.enabledButton()):($rootScope.enabledButton(),void growl.error(trans(errorMessage)))};var proceedSaveCampaign=function(){var postData=$scope.campaignData;console.log(postData),postData.schedulations=null,postData.status="start",postData.is_replay_active=$scope.replayDigit.onOff,postData.is_transfer_active=$scope.transferDigit.onOff,postData.is_callback_active=$scope.callbackDigit.onOff,postData.is_donotcall_active=$scope.doNotCallDigit.onOff,BatchesService.campaignsBatchSend(postData).then(function(data){$rootScope.stopLoader(),0==data.resource.error.no?$scope.batchSendSuccess():growl.error(trans(data.resource.error.text))})};$scope.batchSendSuccess=function(){CallBournModal.open({scope:{},templateUrl:"/app/modals/camping-batch/voice-message-sent.html"},function(scope){scope.goToOverview=function(){CallBournModal.close(),$state.go("campaign.overview")},scope.dismissModal=function(){CallBournModal.close()}})},$scope.showRepitationConfirmModal=function(){CallBournModal.open({scope:{CampaignComposeService:CampaignComposeService},templateUrl:"/app/modals/camping-batch/show-repiteation-count-confirm.html"},function(scope){scope.dates=[];for(var i=0;i<CampaignComposeService.campaignData.remaining_repeats;i++)scope.dates.push(moment().add(i*CampaignComposeService.campaignData.repeat_days_interval,"days").format("LLLL"))})}}]);