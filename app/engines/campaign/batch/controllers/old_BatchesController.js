angular.module("callburnApp").controller("BatchesController",["$scope","$rootScope","$state","$stateParams","FileUploader","$sce","$timeout","BatchesService","CampaignComposeService","CallBournModal",function($scope,$rootScope,$state,$stateParams,FileUploader,$sce,$timeout,BatchesService,CampaignComposeService,CallBournModal){$rootScope.currentActiveUrl=$state.current.name,$scope.CampaignComposeService=CampaignComposeService,$scope.ttsCallbackData={},$scope.uploadingCallbackAudioName="",$scope.tempAudioTemplateModel={},$scope.tempNewCreatedModel={},$scope.liveTransferNumbers=[],$scope.doNotCallAudioFiles=[],$scope.showInteractionModal=function(){CallBournModal.open({scope:{CampaignComposeService:CampaignComposeService},templateUrl:"/app/modals/camping-batch/activate-replay.html"},function(scope){scope.replyDigitActivated=function(){CampaignComposeService.replayDigit.checkboxChecked&&($scope.replayDigit.modalStep=-1,$scope.replayDigit.onOff="on",CallBournModal.close())}})},$scope.showBatchesChangeMessageDeliverySpeedModal=function(){CallBournModal.open({scope:{campaignData:$scope.campaignData},templateUrl:"/app/modals/camping-batch/change-message-delivery-speed.html"},function(scope){scope.maxSpeedSelect={0:{value:"",text:"Max Speed"},1:{value:30,text:"Inside 30 minutes"},2:{value:60,text:"Inside 60 minutes"},3:{value:90,text:"Inside 90 minutes"},4:{value:120,text:"Inside 120 minutes"}},scope.selectSendingTime=function(data){""==data.sending_time?$scope.finalStepData.sendingTime=data.sending_time:$scope.finalStepData.sendingTime=data.sending_time}})},$scope.showVoiceMessageModal=function(){CampaignComposeService.doValitation("start")},$scope.showComposeActivateCallbackModal=function(){CallBournModal.open({scope:{CampaignComposeService:CampaignComposeService,callbackTtsData:$scope.ttsCallbackData,createAudioFromTextForCallback:$scope.createAudioFromTextForCallback,uploadingCallbackAudioName:$scope.uploadingCallbackAudioName,callbackAudioTemplateSelected:$scope.callbackAudioTemplateSelected,tempAudioTemplateModel:$scope.tempAudioTemplateModel,tempNewCreatedModel:$scope.tempNewCreatedModel,callbackAudioFiles:$scope.callbackAudioFiles},templateUrl:"/app/modals/camping-batch/activate-callback.html"},function(scope){scope.activateCallbackDigit=function(){$scope.callbackDigit.onOff="on",CallBournModal.close()},scope.callbackDigitFileUpload=new FileUploader({url:"/campaigns/upload-audio-file",alias:"file",autoUpload:!0}),scope.callbackDigitFileUpload.onAfterAddingFile=function(item){scope.uploadingCallbackAudioName=item.file.name},scope.callbackDigitFileUpload.onSuccessItem=function(item,response,status,headers){if($rootScope.stopLoader(),0==response.resource.error.no){scope.uploadingCallbackAudioName=!1;var audioData={source:$sce.trustAsResourceUrl(apiUrl+"?key="+$rootScope.currentUser.api_token+"&file_id="+response.resource.file._id),file:response.resource.file};$scope.callbackAudioFiles.push(audioData),$scope.callbackAudioFiles.forEach(function(item){item.viewSelect=item.file.orig_filename+" - "+item.file.length})}else alert(response.resource.error.text)},scope.callbackDigitFileUpload.onErrorItem=function(item,response,status,headers){$scope.errors=response,$rootScope.stopLoader()},scope.startCallbackUpload=function(){$rootScope.startLoader(),$scope.callbackDigitFileUpload.uploadAll()},scope.openCallbackFileSelect=function(){$timeout(function(){angular.element("#campaignCallbackFileInput").trigger("click")},100)},scope.selectCallbackNewCreatedAudioFile=function(file){$scope.newCallbackSelectedAudioFile=file,$scope.showNewCreatedCallbacksDropDown=!1,$scope.campaignData.callback_voice_file_id=$scope.newCallbackSelectedAudioFile._id}})},$scope.showTransferModal=function(){CallBournModal.open({scope:{CampaignComposeService:CampaignComposeService,currentUser:$rootScope.currentUser,liveTransferNumbers:[]},templateUrl:"/app/modals/camping-batch/activate-transfer.html"},function(scope){CampaignComposeService.editingCampaign&&CampaignComposeService.editingCampaign.transfer_options?$scope.liveTransferNumbers=CampaignComposeService.editingCampaign.transfer_options.split():$scope.liveTransferNumbers=[],scope.activateTransferDigit=function(){CampaignComposeService.transferDigit.checkboxChecked&&($scope.transferDigit.onOff="on",CampaignComposeService.campaignData.transfer_options=scope.liveTransferNumbers.join(),CallBournModal.close())},scope.addRemoveTransfer=function(number,tariffId){var index=scope.liveTransferNumbers.indexOf(number);index>-1?scope.liveTransferNumbers.splice(index,1):scope.liveTransferNumbers.push(number)}})},$scope.showCallbackModal=function(){CallBournModal.open({scope:{},templateUrl:"/app/modals/camping-batch/activate-callback.html"},function(scope){scope.testFunction=function(){alert("ok")}})},$scope.showDoNotCallModal=function(){CallBournModal.open({scope:{openCampaignVoiceFileSelect:$scope.openCampaignVoiceFileSelect,CampaignComposeService:CampaignComposeService,donotcallNewCreatedTemp:$scope.donotcallNewCreatedTemp,doNotCallAudioFiles:$scope.doNotCallAudioFiles},templateUrl:"/app/modals/camping-batch/activate-do-not-call.html"},function(scope){scope.createAudioFromTextForDoNotCall=function(){$rootScope.startLoader(),BatchesService.createAudioFromText($scope.doNotCallTtsData).then(function(data){if($rootScope.stopLoader(),0==data.resource.error.no){$scope.doNotCallTtsData={language:null};var audioData={source:$sce.trustAsResourceUrl(apiUrl+"?key="+$rootScope.currentUser.api_token+"&file_id="+data.resource.file._id),file:data.resource.file};$scope.doNotCallAudioFiles.push(audioData),$scope.doNotCallAudioFiles.forEach(function(item){item.viewSelect=item.file.orig_filename+" - "+item.file.length})}else $scope.voiceTtsError=data.resource.error.text})},scope.openCampaignVoiceFileSelect=function(){$timeout(function(){angular.element("#campaignDoNotCallFileInput").trigger("click")},100)},scope.newDoNotCallSelectedAudioFile={},scope.showNewCreatedDoNotCallsDropDown=!1,scope.isDoNotCallNewCreatedFilePlaying=!1,scope.selectDoNotCallNewCreatedAudioFile=function(file){scope.newDoNotCallSelectedAudioFile=file,scope.showNewCreatedDoNotCallsDropDown=!1},scope.saveNewCreatedAsDoNotCall=function(){scope.campaignData.do_not_call_voice_file_id=scope.newDoNotCallSelectedAudioFile._id},scope.playPauseDoNotCallNewCreatedAudio=function(action){if(scope.newDoNotCallSelectedAudioFile._id){var audio=document.getElementById("doNotCallCreatedAudioFile");"play"==action?(audio.play(),scope.isDoNotCallNewCreatedFilePlaying=!0,audio.addEventListener("ended",function(){scope.isDoNotCallNewCreatedFilePlaying=!1,scope.$apply()},!1)):(audio.pause(),scope.isDoNotCallNewCreatedFilePlaying=!1)}},scope.donotcallDigitActivated=function(){CampaignComposeService.doNotCallDigit.checkboxChecked&&($scope.doNotCallDigit.modalStep=-1,$scope.doNotCallDigit.onOff="on",CallBournModal.close())},scope.doNotCallDigitFileUpload=new FileUploader({url:"/campaigns/upload-audio-file",alias:"file",autoUpload:!0}),scope.doNotCallDigitFileUpload.onAfterAddingFile=function(item){scope.uploadingDoNotCallAudioName=item.file.name},scope.doNotCallDigitFileUpload.onSuccessItem=function(item,response,status,headers){if($rootScope.stopLoader(),0==response.resource.error.no){scope.uploadingDoNotCallAudioName=!1;var audioData={source:$sce.trustAsResourceUrl(apiUrl+"?key="+$rootScope.currentUser.api_token+"&file_id="+response.resource.file._id),file:response.resource.file};$scope.doNotCallAudioFiles.push(audioData),$scope.doNotCallAudioFiles.forEach(function(item){item.viewSelect=item.file.orig_filename+" - "+item.file.length})}else alert(response.resource.error.text)},scope.doNotCallDigitFileUpload.onErrorItem=function(item,response,status,headers){$scope.errors=response,$rootScope.stopLoader()},scope.startCallbackUpload=function(){$rootScope.startLoader(),scope.doNotCallDigitFileUpload.uploadAll()}})},$scope.showChangeRepeatsCountModal=function(){CallBournModal.open({scope:{},templateUrl:"/app/modals/camping-batch/change-repeat-count.html"},function(scope){scope.testFunction=function(){alert("ok")}})},$scope.showCallerIdModal=function(){CallBournModal.open({scope:{currentUser:$rootScope.currentUser,selectedCallerId:$scope.campaignData.caller_id},templateUrl:"/app/modals/camping-batch/change-caller-id.html"},function(scope){scope.callerIdSelected=function(number){scope.selectedCallerId=number},scope.changeCallerId=function(){$scope.campaignData.caller_id=scope.selectedCallerId,CampaignComposeService.campaignData.caller_id=scope.selectedCallerId,CallBournModal.close()}})},$scope.goToNotification=$rootScope.goToNotification,$scope.todaysDate=moment(),$rootScope.currentActiveRoute="campaign",$rootScope.currentUser.numbers[0]&&($scope.campaignData={caller_id:$rootScope.currentUser.numbers[0].phone_number,get_email_notifications:!0}),$scope.finalStepData={},$scope.batchStep=1,$rootScope.previousStep=function(){$scope.batchStep=2},$rootScope.nextStep=function(){$scope.batchStep=3},$scope.page=0,$scope.pagesCount=0,$scope.listingSkip=0,$scope.changePage=function(pageNumber){pageNumber<0||pageNumber>$scope.pagesCount-1||($scope.page=pageNumber,$scope.listingSkip=10*$scope.page)},$scope.replayDigit={showNumbersSelect:!1,onOff:"off",modalStep:-1,checkboxChecked:!1},$scope.transferDigit={showNumbersSelect:!1,onOff:"off",modalStep:-1,checkboxChecked:!1},$scope.callbackDigit={showNumbersSelect:!1,onOff:"off",modalStep:-1,checkboxChecked:!1},$scope.doNotCallDigit={showNumbersSelect:!1,onOff:"off",modalStep:-1,checkboxChecked:!1},$scope.currentAction=!1;var checkIfActiveInteraction=function(callback,action){$scope.interactionsForModal=[];var isAnyActive=!1;if("on"==$scope.replayDigit.onOff){isAnyActive=!0;var replayDigitObject={action:"Replay Voice Message",keypress:$scope.campaignData.replay_digit};$scope.interactionsForModal.push(replayDigitObject)}if("on"==$scope.transferDigit.onOff){isAnyActive=!0;var transferDigitObject={action:"Transfer Voice Message",keypress:$scope.campaignData.transfer_digit};$scope.interactionsForModal.push(transferDigitObject)}if("on"==$scope.callbackDigit.onOff){isAnyActive=!0;var callbackDigitObject={action:"Callback",keypress:$scope.campaignData.callback_digit};$scope.interactionsForModal.push(callbackDigitObject)}if("on"==$scope.doNotCallDigit.onOff){isAnyActive=!0;var doNotCallDigitObject={action:"Blacklist",keypress:$scope.campaignData.do_not_call_digit};$scope.interactionsForModal.push(doNotCallDigitObject)}return isAnyActive?($scope.showSaveCampaignModalWithInteractions=!0,void($scope.currentAction=action)):callback()};$scope.proceedToSaveWithInteraction=function(action){switch($scope.showSaveCampaignModalWithInteractions=!1,action){case"save":return proceedSaveCampaign();case"schedule":return scheduleCampaignProceed();case"draft":return saveAsDraftProceed()}},$scope.callbackAudioFiles=[],$scope.isCallbackFilePlaying=[],$scope.callbackAudioFileId=null,$scope.callbackDigitActivated=function(){$scope.callbackDigit.checkboxChecked&&($scope.callbackDigit.modalStep=-1,$scope.callbackDigit.onOff="on")},$scope.transferDigitActivated=function(){$scope.transferDigit.checkboxChecked&&($scope.transferDigit.modalStep=-1,$scope.transferDigit.onOff="on",$scope.campaignData.transfer_options=$scope.liveTransferNumbers.join())},$scope.createAudioFromTextForCallback=function(){$scope.ttsCallbackData.user_id=$scope.campaignData.user_id,BatchesService.createAudioFromText($scope.ttsCallbackData).then(function(data){$scope.showTtsCallbackFile=!0,angular.element(document.getElementById("ttsFileCallback")).attr("src","/uploads/audio/"+data.resource.map_filename),$scope.campaignData.callback_digit_file_id=data.resource._id})},$scope.isCallbackRecordedFilePlaying=!1,$scope.isCallbackRecording=!1,$scope.recordedCallbackAudio=new Audio,$scope.startBrowserAudioRecordingCallback=function(){$scope.isCallbackRecording=!0,Fr.voice.record(!0,function(){})},$scope.callbackMessageRecordFinish=function(){Fr.voice["export"](function(url){Fr.voice.stop(),$scope.isCallbackRecording=!1;var base64=url.split(",");$scope.audioRecordedBase64Callback=base64[base64.length-1],$scope.recordedCallbackAudio=new Audio("data:audio/wav;base64,"+$scope.audioRecordedBase64Callback),$scope.$apply()},"base64")},$scope.playPauseCallbackRecordedAudio=function(){$scope.isCallbackRecordedFilePlaying?$scope.recordedCallbackAudio.pause():($scope.recordedCallbackAudio.play(),$scope.recordedCallbackAudio.addEventListener("ended",function(){$scope.isCallbackRecordedFilePlaying=!1,$scope.$apply()},!1)),$scope.isCallbackRecordedFilePlaying=!$scope.isCallbackRecordedFilePlaying},$scope.saveCallbackRecordedFile=function(){BatchesService.createFileFromBase({base64_data:$scope.audioRecordedBase64Callback}).then(function(data){var audioData={source:$sce.trustAsResourceUrl(apiUrl+"?key="+$rootScope.currentUser.api_token+"&file_id="+data.resource.file._id),file:data.resource.file};$scope.callbackAudioFiles.push(audioData)})},$scope.selectedCallbackAudioTemplateFile={},$scope.showCallbackTemplateSelectDropDown=!1,$scope.isCallbackTemplateFilePlaying=!1,$scope.callbackAudioTemplateSelected=function(file){$scope.selectedCallbackAudioTemplateFile=file,$scope.showCallbackTemplateSelectDropDown=!1},$scope.isCallbackAlreadyAdded=function(){for(index in $scope.callbackAudioFiles)if($scope.callbackAudioFiles[index].file._id==$scope.selectedCallbackAudioTemplateFile._id)return!0;return!1},$scope.saveTemplateAsCallback=function(){$scope.callbackAudioFiles.push({file:$scope.selectedCallbackAudioTemplateFile})},$scope.playPauseCallbackTemplateAudio=function(action){if($scope.selectedCallbackAudioTemplateFile._id){var audio=document.getElementById("callbackAudioFileTemplate");"play"==action?(audio.play(),$scope.isCallbackTemplateFilePlaying=!0,audio.addEventListener("ended",function(){$scope.isCallbackTemplateFilePlaying=!1,$scope.$apply()},!1)):(audio.pause(),$scope.isCallbackTemplateFilePlaying=!1)}},$scope.showSelectCallerIdModel=!1,$scope.isDoNotCallFilePlaying=[],$scope.doNotCallAudioFileId=null,$scope.doNotCallTtsData={language:null},$scope.uploadingBatchName="",$scope.batchTtsData={tts_language:null},$scope.openBatchFileSelect=function(){$timeout(function(){angular.element("#campaignBatchFileInput").trigger("click")},100)};var campaignBatchFileUpload=$scope.campaignBatchFileUpload=new FileUploader({url:"/phonenumbers/validate-batch-file",alias:"file",autoUpload:!0,formData:[$scope.batchTtsData]});campaignBatchFileUpload.onAfterAddingFile=function(item){$scope.uploadingBatchName=item.file.name},$scope.showTtsPriceNotificationModal=!1,campaignBatchFileUpload.onSuccessItem=function(item,response,status,headers){$rootScope.stopLoader(),response.resource&&0==response.resource.error.no&&($scope.campaignData.phonenumbers_with_text=response.resource.phonenumbers_with_text,$scope.campaignData.tts_language=response.resource.tts_language,$scope.finalStepData.maxCost=response.resource.max_cost,$scope.finalStepData.numbersCount=response.resource.phonenumbers.length,$scope.uploadingBatchName=!1,$scope.pagesCount=Math.ceil(response.resource.phonenumbers.length/10),$scope.showTtsPriceNotificationModal=!0)},$scope.agreeToTtsPrice=function(){$scope.batchStep=3,$scope.showTtsPriceNotificationModal=!1},campaignBatchFileUpload.onErrorItem=function(item,response,status,headers){$scope.errors=response,$rootScope.stopLoader()},$scope.startBatchFileUpload=function(){$rootScope.startLoader(),campaignBatchFileUpload.uploadAll()},$scope.inlineDataChanged=function(whichOne,index,event){var text=$(event.target).text();$scope.campaignData.phonenumbers_with_text[index][whichOne]=text},$scope.removeOneBatch=function(index){return 1==$scope.campaignData.phonenumbers_with_text.length?void alert("You need to have at least 1 receipent"):($scope.campaignData.phonenumbers_with_text.splice(index,1),void($scope.finalStepData.numbersCount=$scope.finalStepData.numbersCount-1))},$scope.currentMaximumAvailable=$scope.finalStepData.numbersCount;$scope.schedulations=[{date:"",min:1,max:1}],$scope.canAddSchedule=function(){var schedCount=$scope.schedulations.length+1,phonenumbersCount=$scope.finalStepData.numbersCount;return phonenumbersCount/schedCount>=1},$scope.$watch("schedulations",function(newVal,oldVal){for(index in newVal)newVal[index].date<new Date&&(newVal[index].date="")},!0),$scope.addSchedule=function(){$scope.schedulations.push({date:"",min:1,max:1})},$scope.removeSchedule=function(ind){$scope.schedulations.splice(ind,1)},$scope.getMaximum=function(ind){if(!$scope.finalStepData.numbersCount)return $scope.schedulations[ind].max;var currentSum=0;for(index in $scope.schedulations)currentSum+=Number($scope.schedulations[index].max);$scope.currentMaximumAvailable=$scope.finalStepData.numbersCount-Number(currentSum);var currentCount=$scope.schedulations[ind].max,finalRes=Number(currentCount+$scope.currentMaximumAvailable);return finalRes?finalRes:1},$scope.canScheduleCampaign=function(){var maxSums=0;for(index in $scope.schedulations){if(!$scope.schedulations[index].date)return!1;maxSums+=$scope.schedulations[index].max}return maxSums==$scope.finalStepData.numbersCount},$scope.composeStep1ErrorMessage=!1,$scope.showSentMessageSuccessModal=!1;var proceedSaveCampaign=function(){var postData=$scope.campaignData;postData.schedulations=null,postData.status="start",postData.is_replay_active="on"==$scope.replayDigit.onOff,postData.is_transfer_active="on"==$scope.transferDigit.onOff,postData.is_callback_active="on"==$scope.callbackDigit.onOff,postData.is_donotcall_active="on"==$scope.doNotCallDigit.onOff,$rootScope.startLoader(),BatchesService.campaignsBatchSend(postData).then(function(data){$rootScope.stopLoader(),0==data.resource.error.no?($scope.showSentMessageSuccessModal=!0,$scope.showSaveCampaignModalWithInteractions=!1):$scope.composeStep1ErrorMessage=data.resource.error.text})};$scope.saveCampaign=function(){doValidation(proceedSaveCampaign,"save")},$scope.showSchedulationSuccessModal=!1,$scope.scheduleCampaign=function(){doValidation(scheduleCampaignProceed,"schedule")};var scheduleCampaignProceed=function(){var postData=$scope.campaignData;postData.schedulations=$scope.schedulations;for(index in postData.schedulations)postData.schedulations[index].date=moment(postData.schedulations[index].date).format("YYYY-MM-DD HH:mm:ss");postData.status="scheduled",postData.is_replay_active="on"==$scope.replayDigit.onOff,postData.is_transfer_active="on"==$scope.transferDigit.onOff,postData.is_callback_active="on"==$scope.callbackDigit.onOff,postData.is_donotcall_active="on"==$scope.doNotCallDigit.onOff,$rootScope.startLoader(),BatchesService.campaignsBatchSend(postData).then(function(data){$rootScope.stopLoader(),0==data.resource.error.no?$scope.showSchedulationSuccessModal=!0:$scope.composeStep1ErrorMessage=data.resource.error.text})};$scope.saveAsDraft=function(){doValidation(saveAsDraftProceed,"draft")};var saveAsDraftProceed=function(){var postData=$scope.campaignData;postData.schedulations=null,postData.status="saved",postData.status="saved",postData.is_replay_active="on"==$scope.replayDigit.onOff,postData.is_transfer_active="on"==$scope.transferDigit.onOff,postData.is_callback_active="on"==$scope.callbackDigit.onOff,postData.is_donotcall_active="on"==$scope.doNotCallDigit.onOff,$rootScope.startLoader(),BatchesService.campaignsBatchSend(postData).then(function(data){$rootScope.stopLoader(),0==data.resource.error.no?$state.go("campaign.overview"):$scope.composeStep1ErrorMessage=data.resource.error.text})},doValidation=function(cb){var campaignData=$scope.campaignData,isValid=!0,errorMessage="";"on"==$scope.callbackDigit.onOff&&(campaignData.callback_digit&&campaignData.callback_voice_file_id||(isValid=!1,errorMessage="callback_voice_file_required_with_callback_digit")),"on"==$scope.doNotCallDigit.onOff&&(campaignData.do_not_call_digit&&campaignData.do_not_call_voice_file_id||(isValid=!1,errorMessage="donotcall_voice_file_required_with_donotcall_digit")),"on"==$scope.transferDigit.onOff&&(campaignData.transfer_digit&&campaignData.transfer_options||(isValid=!1,errorMessage="transfer_options_required_with_transfer_digit")),"on"==$scope.replayDigit.onOff&&(campaignData.replay_digit||(isValid=!1,errorMessage="replay_digit_is_activated_but_not_selected")),isValid?checkIfActiveInteraction(cb,arguments[1]):notify({message:errorMessage,classes:["notification-alert-danger"]})},arrayOfModals=["showSendPreviewCallModal","showSelectCallerIdModel","showSchedulationModal","showSchedulationSuccessModal","showSentMessageSuccessModal","showTtsNotificationModal","showSaveCampaignModalWithInteractions","showEstimatedSendingTimeModal","contactsModalShow"],arrayOfInteractionModals=["callbackDigit.modalStep","doNotCallDigit.modalStep","replayDigit.modalStep","transferDigit.modalStep"];$scope.$watchGroup(arrayOfModals,function(newValues){var needBlur=!1;for(index in newValues)if(newValues[index]){needBlur=!0;break}$rootScope.showBlurEffect=needBlur}),$scope.$watchGroup(arrayOfInteractionModals,function(newValues,oldValues,scope){var needBlur=!1;for(index in newValues)if(1==newValues[index]||2==newValues[index]){needBlur=!0;break}$rootScope.showBlurEffect=needBlur})}]).directive("selectNumber",function(){return{restrict:"E",templateUrl:"/app/templates/select-number.html",scope:{interactionName:"=interaction",origscope:"=origscope",camelInteraction:"=camelinteraction"},controller:["$scope",function($scope){$scope.actionNumbersMatrix=[["1","2","3"],["4","5","6"],["7","8","9"],["","0",""]]}]}});