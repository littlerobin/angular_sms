angular.module("callburnApp").controller("MessagesOverviewController",["$scope","$rootScope","$state","$filter","Restangular","$stateParams","campaigns","$timeout","FileUploader","$sce","$interval","$httpParamSerializer","$q","growl","CallBournModal",function($scope,$rootScope,$state,$filter,Restangular,$stateParams,campaigns,$timeout,FileUploader,$sce,$interval,$httpParamSerializer,$q,growl,CallBournModal){$rootScope.currentActiveUrl="campaign.overview",$rootScope.tutorialSidePopup=!0,$rootScope.showTutorial=!!$stateParams.showTutorial,$scope.goToNotification=$rootScope.goToNotification,$rootScope.currentPage="dashboard",$rootScope.currentActiveRoute="campaign",$scope.currentOrder="DESC",$scope.showArrowByField="updated_at",$scope.filterData={checkbox:{},order:"DESC",order_field:"updated_at"},$scope.selectedCampaign=null,$scope.orderField=null,$scope.retryUndeliverSpinner=!1,$scope.exportCampaignLoader=!1,$scope.campaigns=[],$scope.campaignsData=[],$scope.prevPage=1,$scope.campaignsToShow=[];var applyTranslations=function(){$scope.isLoaded=!1,setTimeout(function(){$scope.isLoaded=!0},100),$scope.days={1:{value:0,text:"--------"},2:{value:1,text:$rootScope.trans("campaign_overview_last_day")},3:{value:7,text:$rootScope.trans("campaign_overview_last_week")},4:{value:30,text:$rootScope.trans("campaign_overview_last_month")},5:{value:90,text:$rootScope.trans("campaign_overview_last_90_days")}},$scope.types={1:{value:"VOICE_MESSAGE",text:$rootScope.trans("dashboard_welcome_voice_messages")},2:{value:"SMS",text:"SMS"},3:{value:"VOICE_WITH_SMS",text:$rootScope.trans("voice_with_sms")},4:{value:"all",text:$rootScope.trans("all")}},$scope.multiselectOptionsMessagesOverviewData=[{id:"dialing_completed",label:$rootScope.trans("campaign_overview_chackbox_dialing_completed")},{id:"start",label:$rootScope.trans("campaign_overview_calling_in_progress")},{id:"saved",label:$rootScope.trans("campaign_overview_chackbox_dialing_saved")},{id:"scheduled",label:$rootScope.trans("campaign_overview_chackbox_dialing_scheduled")},{id:"schedulation_idle",label:$rootScope.trans("campaign_overview_chackbox_schedulation_idle")},{id:"stop",label:$rootScope.trans("campaign_overview_chackbox_dialing_stopped")}],$scope.multiselectMessageOverviewTranslationTexts={dynamicButtonTextSuffix:trans("multi_checked"),checkAll:trans("multi_check_all"),uncheckAll:trans("multi_uncheck_all"),selectionCount:trans("multi_checked"),buttonDefaultText:trans("multiselect_statistics_status")}};$rootScope.$watch("currentLanguage",applyTranslations),$rootScope.$watch("isLangLoaded",applyTranslations),$scope.goToStatistics=function(campaign){"BATCH"==campaign.grouping_type?$state.go("campaign.statistics",{campaign_id:campaign._id,is_multiple:!0}):$state.go("campaign.statistics",{campaign_id:campaign._id,is_multiple:!1})},$scope.getCurrentBatchNumber=function(campaign){return 1},$scope.showInput=[],$rootScope.hideOverviewArrows=!0;var getNewCampaigns=function(data,spinner,filterType){filterType&&($scope.tableSpinnerLoading=!0),Restangular.one("campaigns/index-campaigns").get(data).then(function(campaigns){updateCampaigns(campaigns,filterType)})};$scope.isCampaignsexist=campaigns.resource.total_campaigns_count>0,$scope.campaignsTotalCount=campaigns.resource.total_campaigns_count;var updateCampaigns=function(data,filterType){var campaigns=data.resource.campaigns;filterType?($scope.campaignsToShow=[],campaigns.forEach(function(item){$scope.campaignsToShow.push(item)})):campaigns.forEach(function(item){$scope.campaignsToShow.push(item)}),$scope.tableSpinnerLoading=!1,$scope.showMoreLoader=!1,$scope.totalCampaigns=data.resource.campaigns_count,$scope.isCampaignsexist=data.resource.total_campaigns_count>0,$scope.phonenumbersPerPage=7,$scope.totalCampaignsCount=data.resource.total_campaigns_count,$scope.campaignsCount=data.resource.campaigns_count,$scope.tableSpinnerLoading=!1};updateCampaigns(campaigns),$scope.filterCampaigns=function(status,filter,filterType){if($scope.filterData.page=0,$scope.page.number=1,"all"==status){var allStatus=$scope.filterData.checkbox.all;$scope.filterData.checkbox.dialing_completed=allStatus,$scope.filterData.checkbox.scheduled=allStatus,$scope.filterData.checkbox.saved=allStatus}else $scope.filterData.checkbox.dialing_completed&&$scope.filterData.checkbox.scheduled&&$scope.filterData.checkbox.saved?$scope.filterData.checkbox.all=!0:$scope.filterData.checkbox.all=!1;getNewCampaigns($scope.filterData,null,!0)},$stateParams.status&&($scope.filterData.checkbox[$stateParams.status]=!0),$stateParams.orderBy?($scope.filterData.order_field=$stateParams.orderBy,$scope.showArrowByField=$stateParams.orderBy):$scope.showArrowByField="updated_at",$scope.page={},$scope.filterData.order="DESC",$scope.changeOrder=function(field){$scope.showMoreLoader=!0,$scope.showArrowByField=field,$scope.page.number=1,$scope.filterData.page=0,field==$scope.filterData.order_field?$scope.currentOrder="ASC"==$scope.currentOrder?"DESC":"ASC":$scope.currentOrder="ASC",$scope.orderField=field,$scope.filterData.order_field=field,$scope.filterData.order=$scope.currentOrder,$scope.changePage($scope.page.number,!0)},$scope.openExportModal=function(campaign){CallBournModal.open({scope:{campaign:campaign},templateUrl:"/app/modals/campaign-export/campaign-export.html"},function(scope){scope.close=function(){CallBournModal.close()},scope.exportHandler=function(fileFormat){scope.campaign?($scope.exportCampaign(scope.campaign,fileFormat),CallBournModal.close()):snippetId&&filterData&&CallBournModal.close()}})};var channel="update-message-"+$rootScope.currentUser._id;$rootScope.socket.on(channel,function(res){if("phonenumber"===res.data.type&&$scope.campaignsData&&$scope.campaignsData.length)for(var i=0;i<$scope.campaignsData.length;i++)$scope.campaignsData[i]._id===res.data.campaign_id&&getNewCampaigns($scope.filterData,!0);if("status"===res.data.type&&$scope.campaignsData&&$scope.campaignsData.length)for(var i=0;i<$scope.campaignsData.length;i++)$scope.campaignsData[i]._id===res.data.campaign_id&&getNewCampaigns($scope.filterData,!0)}),$scope.currentPage=void 0,$scope.changePage=function(page,filtered){$scope.filterData.page=page-1,$scope.currentPage=page,getNewCampaigns($scope.filterData,null,filtered)},$scope.removeCampaign=function(id){ConfirmDeleteModal().then(function(){$scope.tableSpinnerLoading=!0,Restangular.one("campaigns/remove-campaign",id).remove().then(function(data){$scope.tableSpinnerLoading=!1,getNewCampaigns($scope.filterData,null,!0);var elemPos=$scope.campaignsToShow.map(function(item){return item.id}).indexOf(id);$scope.campaignsToShow.splice(elemPos,1)})})},$scope.changeSelectedCampaign=function(id){$scope.selectedCampaign=id},$scope.exportCampaign=function(campaign,fileFormat){$scope.exportCampaignLoader=!0;var postData={campaign_id:campaign._id,file_format:fileFormat};Restangular.all("phonenumbers/export-statistics").post(postData).then(function(data){0===data.resource.error.no?($scope.exportCampaignLoader=!1,growl.success($rootScope.trans("email_will_be_sent_to_you"))):($scope.exportCampaignLoader=!1,growl.error($rootScope.trans("email_will_not_be_sent_to_you")))})},window.document.title=0===$scope.notSeenNotificationsCount?"Messages - Callburn":"("+$scope.notSeenNotificationsCount+") Messages - Callburn",$scope.getSchedulationTooltipHtml=function(campaign){var str="";for(index in campaign.schedulations)str+=campaign.schedulations[index].scheduled_date+" - "+campaign.schedulations[index].calls_limit+" Receipent(s) <br>";return str};var playPauseAudio=function(audioId,url){var audio=document.getElementById("campaignAudio");url&&audio.setAttribute("src",url),$scope.isRecordedFilePlaying?(audio.pause(),audio.currentTime=0,document.getElementById("audioFilePlay"+audioId)&&(document.getElementById("audioFilePlay"+audioId).setAttribute("src","/assets/callburn/images/play.svg"),document.getElementById("audioFilePlayText"+audioId).innerHTML="&nbsp;&nbsp;Play")):(audio.play(),document.getElementById("audioFilePlay"+audioId).setAttribute("src","/assets/callburn/images/stop.svg"),document.getElementById("audioFilePlayText"+audioId).innerHTML="&nbsp;Pause",audio.addEventListener("ended",function(){$scope.isRecordedFilePlaying=!1,document.getElementById("audioFilePlay"+audioId)&&(document.getElementById("audioFilePlay"+audioId).setAttribute("src","/assets/callburn/images/play.svg"),document.getElementById("audioFilePlayText"+audioId).innerHTML="&nbsp;&nbsp;Play")},!1)),$scope.isRecordedFilePlaying=!$scope.isRecordedFilePlaying};window.playPauseRecordedAudio=function(campaignId){$scope.campaignsToShow.forEach(function(campaign,i,campaigns){if(campaign._id===campaignId){var template=campaign.voice_file,audioId=template._id;template.amazon_s3_url?playPauseAudio(audioId):(document.getElementById("audioFilePlay"+audioId)&&document.getElementById("audioFilePlay"+audioId).setAttribute("src","assets/callburn/images/images/blue-audio-spinner.svg"),$rootScope.getAmazonUrlOfAudio(template._id).then(function(url){document.getElementById("audioFilePlay"+audioId)&&(document.getElementById("audioFilePlay"+audioId).setAttribute("src","/assets/callburn/images/stop.svg"),campaigns[i].voice_file.amazon_s3_url=url,playPauseAudio(audioId,url))}))}})};var convertedAudioTooltips={};$scope.getAudioTooltipHtml=function(campaign){if(convertedAudioTooltips.hasOwnProperty(campaign._id))return convertedAudioTooltips[campaign._id];if(campaign.voice_file&&"TTS"===campaign.voice_file.type)var name=$filter("limitTo")(campaign.voice_file.tts_text,25);else if(campaign.voice_file&&"UPLOADED"===campaign.voice_file.type)var name=campaign.voice_file.orig_filename;var str='<p><span class="blue-sp">Name</span>: '+name+"</p>";return str=str+'<p class="blue-sp">'+(campaign.voice_file&&campaign.voice_file.type)+" - "+$filter("audioDuration")(campaign.voice_file&&campaign.voice_file.length)+"</p>",str=str+'<div class="stop-play left"> <img src="/assets/callburn/images/play.svg" class="compose_method3_icons" id="audioFilePlay'+(campaign.voice_file&&campaign.voice_file._id)+'"style="cursor:pointer" onclick="playPauseRecordedAudio('+campaign._id+')"/><span id="audioFilePlayText'+(campaign.voice_file&&campaign.voice_file._id)+'">&nbsp;&nbsp;Play</span> </div>',str=$sce.trustAsHtml(str),convertedAudioTooltips[campaign._id]=str,str},window.playAudio=function(id){var audio=document.getElementById("campaignAudio");audio.play()},window.pauseAudio=function(id){var audio=document.getElementById("campaignAudio");audio.pause()},$scope.getInteractionsTooltipHtml=function(campaign){var replay_digit=campaign.replay_digit?$rootScope.trans("campaign_compose_compose_step_3_replay_voice_message")+" ("+campaign.replay_digit+")":"";return transfer_digit=campaign.transfer_digit?"<div></div>"+$rootScope.trans("campaign_compose_compose_step_3_call_live")+" ("+campaign.transfer_digit+")":"",callback_digit=campaign.callback_digit?"<div></div>"+$rootScope.trans("campaign_compose_compose_step_3_call_me_back")+" ("+campaign.callback_digit+")":"",do_not_call_digit=campaign.do_not_call_digit?"<div></div>"+$rootScope.trans("campaign_compose_compose_step_3_blacklist_me")+" ("+campaign.do_not_call_digit+")":"",replay_digit+transfer_digit+callback_digit+do_not_call_digit},$scope.getUpdatedAt=function(date,type){var serverTimezoneDate=moment.tz(date,"YYYY-MM-DD HH:mm:ss",window.SERVER_TIMEZONE);if("updated"===type)return moment(serverTimezoneDate).fromNow();var updatedAt=serverTimezoneDate.clone().tz($rootScope.currentUser.timezone).format("YYYY-MM-DD HH:mm:ss");return $filter("localDate")(updatedAt)},$scope.getCampaignRecipientsText=function(campaign){if("scheduled"===campaign.status&&campaign.first_scheduled_date)for(var i=0;i<campaign.schedulations.length;i++)if(!campaign.schedulations[i].is_finished){var recipients=campaign.schedulations[i].recipients,recipientsText=recipients?recipients+" "+trans("modals_campaign_schedulation_recipient")+" ":"";return recipientsText}},$scope.getCampaignStatusText=function(campaign){if("scheduled"===campaign.status&&campaign.first_scheduled_date&&campaign.calls_count.length&&campaign.total_phonenumbers[0].count>campaign.calls_count[0].count||!campaign.calls_count.length)for(var i=0;i<campaign.schedulations.length;i++)if(!campaign.schedulations[i].is_finished){var nextSchedule=moment.tz(campaign.schedulations[i].scheduled_date,"YYYY-MM-DD HH:mm:ss",window.SERVER_TIMEZONE).add(1,"minute"),duration=moment().diff(nextSchedule),humanize=humanizeDuration(duration,{units:["d","h","m"],round:!0,largest:4,language:$rootScope.currentLanguage});return trans("next_run_in")+" "+humanize}var updatedAt=moment(campaign.updated_at,"YYYY-MM-DD HH:mm:ss").tz(window.SERVER_TIMEZONE).format("YYYY-MM-DD HH:mm:ss"),createdAt=moment(campaign.created_at,"YYYY-MM-DD HH:mm:ss").tz(window.SERVER_TIMEZONE).format("YYYY-MM-DD HH:mm:ss");return"dialing_completed"===campaign.status?trans("completed_on")+" "+$filter("localDate")(updatedAt):"start"!==campaign.status||campaign.schedulation_original_data?"schedulation_in_progress"===campaign.status?trans("started_on")+" "+$filter("localDate")(updatedAt):"saved"===campaign.status?trans("saved_on")+" "+$filter("localDate")(createdAt):"stop"===campaign.status?trans("manually_stopped_on")+" "+$filter("localDate")(updatedAt):null:trans("started_on")+" "+$filter("localDate")(updatedAt)},$scope.getStatusClass=function(campaign){return $rootScope.currentUser.balance<=0&&"dialing_completed"!==campaign.status&&"saved"!==campaign.status?"dark_orange snippet_blinking":"stop"===campaign.status?"dark_orange":"stopped_low_balance"===campaign.status?"dark_orange":"saved"===campaign.status?"saved_status schedulation-in-progress-status":"dialing_completed"===campaign.status?"sent-statistics-status":"schedulation_idle"===campaign.status?"schedulation-idle-status":"scheduled"===campaign.status?"schedulate-status":"start"===campaign.status?"save-as-draft-status snippet_blinking":"schedulation_in_progress"===campaign.status?"save-as-draft-status snippet_blinking":void 0},$scope.hideOnDisabled=!1,$scope.getCampaignStatus=function(campaign){if(1==campaign.is_first_run&&"saved"!==campaign.status&&"scheduled"!==campaign.status&&"stop"!==campaign.status&&"schedulation_idle"!==campaign.status)return $rootScope.trans("in_process");switch(campaign.status){case"stopped_low_balance":return $rootScope.trans("stopped_low_balance");case"dialing_completed":return $rootScope.trans("campaign_overview_chackbox_dialing_completed");case"start":return campaign.schedulation_original_data?$rootScope.currentUser.balance>0?$rootScope.trans("campaign_overview_chackbox_dialing_scheduled"):($scope.hideOnDisabled=!0,$rootScope.trans("low_balance_disabled")):$rootScope.currentUser.balance>0?$rootScope.trans("campaign_sending_in_progress"):($scope.hideOnDisabled=!0,$rootScope.trans("low_balance_disabled"));case"saved":return $rootScope.trans("campaign_overview_chackbox_dialing_saved");case"scheduled":return $rootScope.trans("campaign_overview_chackbox_dialing_scheduled");case"schedulation_idle":return $rootScope.currentUser.balance>0?$rootScope.trans("campaign_overview_chackbox_schedulation_idle"):$rootScope.trans("low_balance_disabled");case"stop":return $rootScope.currentUser.balance>0?$rootScope.trans("campaign_overview_chackbox_dialing_stopped"):$rootScope.trans("low_balance_disabled");case"schedulation_in_progress":return $rootScope.currentUser.balance>0?$rootScope.trans("campaign_sending_in_progress"):$rootScope.trans("low_balance_disabled");default:return""}},$scope.goToEdit=function(campaign_id,action){$state.go("campaign.edit",{campaign_id:campaign_id,action:action})},$scope.accessForMarkAsCompleted=function(campaign){return!!("stop"===campaign.status||"schedulation_idle"===campaign.status&&campaign.calls_count.length||"scheduled"===campaign.status&&campaign.calls_count.length)},$scope.isWaitingNextBatch=function(campaign){return!1},$scope.getSuccessSmsVoiceOfCampaign=function(campaign){return campaign.success_phonenumbers[0].count-(campaign.sms_count[0]&&campaign.sms_count[0].count||0)+" "+$rootScope.trans("dashboard_welcome_voice_messages")+" & "+(campaign.sms_count[0]&&campaign.sms_count[0].count||0)+" SMS"},$scope.getSuccessOfCampaign=function(campaign){return campaign.success_phonenumbers[0]?campaign.success_phonenumbers[0].count:0},$scope.getTotalOfCampaign=function(campaign){return campaign.totalRecipientsIfGroups?campaign.totalRecipientsIfGroups:campaign.total_phonenumbers[0]?campaign.total_phonenumbers[0].count:0},$scope.getCostOfCampaign=function(campaign){return campaign.amount_spent};var openReusingCampaignModal=function(campaign){CallBournModal.open({scope:{campaign:campaign,phonenumbersCount:null},templateUrl:"/app/modals/campaign-overview/reuse-campaign-modal.html"},function(scope){scope.campaign.total_phonenumbers.length&&(scope.phonenumbersCount=0,scope.campaign.total_phonenumbers.forEach(function(phonenumber){scope.phonenumbersCount+=phonenumber.count})),scope.withSameRecipients=function(){$state.go("campaign.compose",{reusing_source:"both",campaign_id:campaign._id,hide_all_arrows:!0}),CallBournModal.close()},scope.withOutSameRecipients=function(){$state.go("campaign.compose",{reusing_source:"both",without_recipients:!0,campaign_id:campaign._id,hide_all_arrows:!0}),CallBournModal.close()},scope.hideOverlay=function(){CallBournModal.close()}})};$scope.reuseCampaign=function(campaign){campaign.total_phonenumbers.length+campaign.totalRecipientsIfGroups===0?$state.go("campaign.compose",{reusing_source:"both",without_recipients:!0,campaign_id:campaign._id,hide_all_arrows:!0}):openReusingCampaignModal(campaign)},$scope.changeMessageStatus=function(status,campaign){id=campaign._id,CallBournModal.open({scope:{campaign:campaign},templateUrl:"/app/modals/campaign-statistics/confirm.html"},function(scope){scope.close=function(){campaign.showStatusLoader=!1,CallBournModal.close()},scope.acceptStopMessage=function(campaign){campaign.showStatusLoader=!0,Restangular.all("campaigns/update-campaign-status").post({status:status,campaign_id:id}).then(function(data){if(0===data.resource.error.no){var copy=Object.assign({},campaign);campaign.showStatusLoader=!1,copy.status=status,campaign.status=$scope.getCampaignStatus(copy),getNewCampaigns($scope.filterData)}CallBournModal.close()})}})},$scope.multiselectOptionsMessageOverviewDataCallback=function(){var q=$q.defer();return $scope.multiselectOptionsMessagesOverviewData?q.resolve($scope.multiselectOptionsMessagesOverviewData):($interval(function(){if($scope.multiselectOptionsMessagesOverviewData)return q.resolve($scope.multiselectOptionsMessagesOverviewData)},500),q.promise)},$scope.multiselectOptionsMessageOverviewDataCallback().then(function(data){$stateParams.retainedBalance?$scope.checkedOptionsModel=[$scope.multiselectOptionsMessagesOverviewData[1],$scope.multiselectOptionsMessagesOverviewData[3],$scope.multiselectOptionsMessagesOverviewData[4]]:$scope.checkedOptionsModel=[],$scope.multiSelectEvents.onSelectionChanged()}),$scope.multiselectMessageOverviewSettings={template:"{{option.label}}",buttonClasses:""},$scope.firstLoadForStatuses=!0,$scope.multiSelectEvents={onSelectionChanged:function(){$scope.checkedOptions=[],$scope.checkedOptionsModel.forEach(function(option){$scope.checkedOptions.push(option.id)}),$scope.filterData.checkbox=JSON.stringify($scope.checkedOptions),$scope.filterData.page=0,$scope.page.number=1,$scope.firstLoadForStatuses||getNewCampaigns($scope.filterData,null,!0),$scope.firstLoadForStatuses=!1}},$scope.allowDelete=function(campaign){return(!campaign.calls_count.length||"scheduled"!==campaign.status)&&("saved"==campaign.status||"scheduled"===campaign.status)},$scope.allowDeleteIfNotInProgress=function(campaign){return"start"!=campaign.status&&"schedulation_in_progress"!=campaign.status},$scope.retryUndelivered=function(campaign){$scope.retryUndeliverSpinner=!0;var voice_file_id=campaign.voice_file?campaign.voice_file._id:null;Restangular.one("campaigns/retry-undelivered/"+campaign._id).get().then(function(data){var neverCalled=data.resource.neverCalled,undelivered=data.resource.undelivered;data.resource.undeliveredAndNeverCalled;!neverCalled&&undelivered?Restangular.all("campaigns/create-group-for-undelivered").post({condition:"undelivered",message_id:campaign._id}).then(function(data){var groupObject={};groupObject[data.resource.group_id]=!0,$scope.retryUndeliverSpinner=!1,$state.go("campaign.compose",{reusing_source:"both",campaign_id:campaign._id,file_id:voice_file_id,group_ids:groupObject,hide_all_arrows:!0})}):!undelivered&&neverCalled?Restangular.all("campaigns/create-group-for-undelivered").post({condition:"neverCalled",message_id:campaign._id}).then(function(data){var groupObject={};groupObject[data.resource.group_id]=!0,$scope.retryUndeliverSpinner=!1,$state.go("campaign.compose",{reusing_source:"both",campaign_id:campaign._id,file_id:voice_file_id,group_ids:groupObject,hide_all_arrows:!0})}):neverCalled&&undelivered||!neverCalled&&!undelivered?($scope.retryUndeliverSpinner=!1,CallBournModal.open({scope:{neverCalled:data.resource.neverCalled,undelivered:data.resource.undelivered,undeliveredAndNeverCalled:data.resource.undeliveredAndNeverCalled},templateUrl:"app/modals/camping-batch/retry-undelivered.html"},function(scope){scope.makeRetryDisable=!1,scope.send=function(part){switch(scope.makeRetryDisable=!0,scope.undeliverSpinner=!1,scope.neverCalledSpinner=!1,part){case"undelivered":scope.undeliverSpinner=!0;break;case"neverCalled":scope.neverCalledSpinner=!0;break;case"undeliveredAndNeverCalled":scope.undeliveredAndNeverCalledSpinner=!0}Restangular.all("campaigns/create-group-for-undelivered").post({condition:part,message_id:campaign._id}).then(function(data){CallBournModal.close();var groupObject={};groupObject[data.resource.group_id]=!0,$state.go("campaign.compose",{reusing_source:"both",campaign_id:campaign._id,file_id:voice_file_id,group_ids:groupObject,hide_all_arrows:!0})})},scope.close=function(){CallBournModal.close()}})):$scope.retryUndeliverSpinner=!1})},$scope.showSearch=!1,$scope.OverEnterPress=function(key){13===key.which?$scope.filterCampaigns():null},$scope.toggleSearch=function(){$scope.showSearch&&$rootScope.importantShowSearch?$scope.filterCampaigns():$scope.showSearch=!0},$scope.uiSref=function(campaign){campaign.is_first_run&&"saved"!==campaign.status||("saved"===campaign.status?$state.go("campaign.edit",{campaign_id:campaign._id}):$state.go("campaign.statistics",{campaign_id:campaign._id}))},$scope.uiSrefToSchedule=function(campaign,action){$state.go("campaign.edit",{campaign_id:campaign._id,action:action,openModal:!0})},$scope.clockHover=function(data,pastDate){var dateData=[],dataToShow="";return data.forEach(function(item){var date=moment(item.scheduled_date).tz($rootScope.currentUser.timezone).format("MMMM Do YYYY, HH:mm");if(!moment().tz($rootScope.currentUser.timezone).isBefore(date))var past=!0;dateData.push({date:date,recipients:item.recipients,past:past})}),dateData.forEach(function(data,index){(pastDate&&data.past||!pastDate&&!data.past)&&(dataToShow+=data.date+" - "+data.recipients+" "+$rootScope.trans("compose_step_3_text_recipients")+";<br>")}),$sce.trustAsHtml(dataToShow)},$scope.calculateInteractionCost=function(count,interactionsCost,campaignCost){return count&&(interactionsCost||campaignCost)?(interactionsCost=interactionsCost?interactionsCost:0,campaignCost=campaignCost?campaignCost:0,Math.round((interactionsCost+campaignCost)/count*100)/100):""},$scope.resetWindowVars=function(){window.goToCompose=!1,window.goToApi=!1,$rootScope.hideFormQuestions=!1},$scope.resetWindowVars(),$scope.showGroupNames=function(groups){var dataToShow="";return groups.forEach(function(item){dataToShow+=item.name+"<br>"}),$sce.trustAsHtml(dataToShow)},$scope.tableInit=function(){var elem=angular.element("#overviewTable")[0];elem.addEventListener("scroll",function(event){if(Math.floor(elem.scrollTop)+elem.clientHeight===elem.scrollHeight){if($scope.campaignsToShow.length==$scope.campaignsCount||$scope.campaignsToShow.length>$scope.campaignsCount||$scope.showMoreLoader||$scope.tableSpinnerLoading)return!0;$scope.campaignsTotalCount>$scope.phonenumbersPerPage&&($scope.showMoreLoader=!0,$scope.page.number++,$scope.changePage($scope.page.number))}})},$scope.scrollDownTable=function(){var elem=angular.element("#overviewTable")[0];angular.element("#overviewTable").animate({scrollTop:elem.scrollHeight},800,function(){})},$scope.calcSmsTextSmsCount=function(sms_text){if(sms_text){var txt=sms_text.length,num=0;return txt>=0&&txt<=160?(num=1,"X"+num):txt>=161&&txt<=320?(num=2,"X"+num):txt>=321&&txt<=480?(num=3,"X"+num):txt>=481&&txt<=640?(num=4,"X"+num):txt>=641&&txt<=800?(num=5,"X"+num):txt>=801&&txt<=960?(num=6,"X"+num):void 0}},$scope.calcSmsText=function(sms_text){if(sms_text){var txt=sms_text.length,num=0;return txt>=0&&txt<=160?(num=1," "+$rootScope.trans("compose_step_1_method_1_characters_count")+": "+txt+" - "+num+" SMS"):txt>=161&&txt<=320?(num=2," "+$rootScope.trans("compose_step_1_method_1_characters_count")+": "+txt+" - "+num+" SMS"):txt>=321&&txt<=480?(num=3," "+$rootScope.trans("compose_step_1_method_1_characters_count")+": "+txt+" - "+num+" SMS"):txt>=481&&txt<=640?(num=4," "+$rootScope.trans("compose_step_1_method_1_characters_count")+": "+txt+" - "+num+" SMS"):txt>=641&&txt<=800?(num=5," "+$rootScope.trans("compose_step_1_method_1_characters_count")+": "+txt+" - "+num+" SMS"):txt>=801&&txt<=960?(num=6," "+$rootScope.trans("compose_step_1_method_1_characters_count")+": "+txt+" - "+num+" SMS"):void 0}}}]);