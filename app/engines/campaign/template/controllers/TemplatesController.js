"use strict";angular.module("callburnApp").controller("TemplatesController",["$scope","$rootScope","$state","Restangular","$stateParams","audioFiles","$sce","TemplateService","CallBournModal","FileUploader","$timeout","growl","ttsLanguages","IconsControl","$q","$interval",function($scope,$rootScope,$state,Restangular,$stateParams,audioFiles,$sce,TemplateService,CallBournModal,FileUploader,$timeout,growl,ttsLanguages,IconsControl,$q,$interval){$rootScope.fileUploader=FileUploader,$scope.availableTts={"Alice-ML":!0,"Anna-ML":!0,Daniel:!0,Ellen:!0,Empar:!0,Joana:!0,Jordi:!0,Lekha:!0,Milena:!0,Monica:!0,Paulina:!0,Samantha:!0,Satu:!0,Tarik:!0,Thomas:!0,Zosia:!0},$rootScope.showTutorial=!1,$scope.IconsControl=IconsControl,$scope.currentAudioId=null,$rootScope.currentPage="dashboard",$rootScope.currentActiveUrl=$state.current.name,$rootScope.currentActiveRoute="templates",$scope.goToNotification=$rootScope.goToNotification,$scope.filterData={type:"all",order_field:"updated_at",order:"DESC"},$scope.checkedTemplates={},$scope.isAllChecked=!1,$scope.tableSpinnerLoading=!0,$scope.showFilesInput=[],$scope.audioFilePlayPause={},$scope.showInput={},$scope.orderField=null,$scope.currentOrder="ASC",$scope.filterData.checkbox=[],$scope.ttsLanguages=ttsLanguages.resource.languages,$scope.ttsLanguages.forEach(function(item){item.selectView=item.languageName+"-"+item.ttsEngine}),$scope.chosedInteractions=[],$scope.checkEnter=function($event,id,name,template){var keyCode=$event.which||$event.keyCode;13===keyCode&&$scope.changeName(id,name,template)},window.document.title=0===$scope.notSeenNotificationsCount?"Messages - Callburn":"("+$scope.notSeenNotificationsCount+") Messages - Callburn",$scope.filterData.checkbox.all=!1;var applyTranslations=function(){$scope.isLoaded=!1,setTimeout(function(){$scope.isLoaded=!0},100),$scope.multiselectOptionsTemplateOverviewData=[{id:"UPLOADED",label:trans("campaign_template_index_file_upload")},{id:"TTS",label:trans("campaign_template_index_tts_generated")},{id:"SMS",label:"SMS"}],$scope.multiselectTemplatesTranslationTexts={dynamicButtonTextSuffix:trans("multi_checked"),checkAll:trans("multi_check_all"),uncheckAll:trans("multi_uncheck_all")};var ttsEnginesNames={en:"Kate",it:"Alice-ML",es:"Monica"};$scope.ttsEngineIndicated=ttsEnginesNames[$rootScope.currentLanguage]};$rootScope.$watch("currentLanguage",applyTranslations),$rootScope.$watch("isLangLoaded",applyTranslations);var updateTemplates=function(templates){$scope.isTemplatesExist=templates.resource.total_templates_count>0,$scope.templates=templates.resource.files;for(var i=0;i<=$scope.templates.length;i++)$scope.audioFilePlayPause[i]=!1;$scope.total=templates.resource.count,$scope.templatesPage=templates.resource.page,$scope.templatesCount=templates.resource.count,$scope.templatesPagesCount=Math.ceil(templates.resource.count/10),$scope.templatesPerPage=10,$scope.tableSpinnerLoading=!1},index=function(){updateTemplates(audioFiles)};index(),$scope.isTemplatesExist=audioFiles.resource.total_templates_count>0,$scope.getAudioSource=function(audioTemplate){return $sce.trustAsResourceUrl(audioTemplate.amazon_s3_url)};var stopAllAudios=function(){var q=$q.defer();return $scope.templates.forEach(function(template,i,templates){templates[i].playPauseIconClass="fa-play-circle",q.resolve()}),q.promise},playPauseAudio=function(template){var audio=document.getElementById("AudioTemplateFile");$scope.isRecordedFilePlaying?(audio.pause(),audio.currentTime=0,template.playPauseIconClass="fa-play-circle"):(audio.play(),startedPlying("AudioTemplateFile").then(function(){template.showAudioSpinner=!1,template.playPauseIconClass="fa-stop-circle"}),audio.addEventListener("ended",function(){$scope.isRecordedFilePlaying=!1,template.playPauseIconClass="fa-play-circle"},!1))};$scope.playAudio=function(){var a=document.getElementById("aaa");a.muted=!0,a.play()},$scope.playPauseRecordedAudio=function(template){template._id===$scope.currentAudioId?($scope.isRecordedFilePlaying=!$scope.isRecordedFilePlaying,playPauseAudio(template)):($scope.isRecordedFilePlaying=!1,stopAllAudios().then(function(){if(template.amazon_s3_url){var currentAudioUrl=$sce.trustAsResourceUrl(template.amazon_s3_url);document.getElementById("AudioTemplateFile").setAttribute("src",currentAudioUrl),playPauseAudio(template),template.showAudioSpinner=!1}else template.playPauseIconClass="hidden",template.showAudioSpinner=!0,$rootScope.getAmazonUrlOfAudio(template._id).then(function(url){template.amazon_s3_url=url;var currentAudioUrl=$sce.trustAsResourceUrl(url);document.getElementById("AudioTemplateFile").setAttribute("src",currentAudioUrl),playPauseAudio(template)})}),$scope.currentAudioId=template._id)},$scope.currentPage=void 0,$scope.changeTemplatesPage=function(page){$scope.tableSpinnerLoading=!0;var postData=$scope.filterData;postData.page=page-1,$scope.currentPage=page,TemplateService.getAudioTemplates(postData).then(function(data){updateTemplates(data)})},$scope.templateSpinner=!1,$scope.changeName=function(id,name,template){$scope.templateSpinner=template,TemplateService.putUpdateFileName(id,{name:name}).then(function(data){if(0==data.resource.error.no){$scope.templateSpinner=!1;for(index in $scope.templates)if($scope.templates[index]._id==id){$scope.templates[index].orig_filename=name,$scope.showInput[id]=!1;break}}})},$scope.changeOrder=function(field){$scope.tableSpinnerLoading=!0,$scope.filterData.page=0,field==$scope.filterData.order_field&&($scope.currentOrder="ASC"==$scope.currentOrder?"DESC":"ASC",$scope.orderField=field),$scope.filterData.order_field=field,$scope.filterData.order=$scope.currentOrder,TemplateService.getAudioTemplates($scope.filterData).then(function(data){updateTemplates(data)})},$scope.deleteAudioTemplates=function(template){ConfirmDeleteModal().then(function(){TemplateService.removeAudioTemplates({ids:template._id}).then(function(data){$scope.changeTemplatesPage($scope.templatesPage)})})},$scope.sendMessageAgain=function(template){$state.go("campaign.compose",{audioFile:template,tab:3})},$scope.filterTemplate=function(status,filter){$scope.tableSpinnerLoading=!0,TemplateService.getAudioTemplates($scope.filterData).then(function(data){updateTemplates(data)})},$scope.hasInArray=function(array,item,index,except){if(index)return array[index]==item;if(array&&array.length)for(var i=0;i<array.length;i++)if(except){if(except!=i&&array.indexOf(item)!=-1)return!0}else if(array.indexOf(item)!=-1)return!0;return!1},$rootScope.interData={},$rootScope.interData.replayDigit={checkboxChecked:!1,digit:null,onOff:!1},$rootScope.interData.transferDigit={checkboxChecked:!1,digit:null,onOff:!1},$rootScope.interData.callbackDigit={checkboxChecked:!1,digit:null,onOff:!1},$rootScope.interData.blacklistDigit={checkboxChecked:!1,digit:null,onOff:!1},$rootScope.interData.transferDigit.live_transfer_limit=null,$rootScope.liveTransferNumbers=[],$scope.addNewTemplate=function(){CallBournModal.open({scope:{chosedInteractions:$scope.chosedInteractions,ttsEngineIndicated:$scope.ttsEngineIndicated,availableTts:$scope.availableTts,multiSelectEvents:$scope.multiSelectEvents,ttsData:{},ttsLanguagesItems:$scope.ttsLanguages,audioData:{is_template:1},textErr:!1,smsError:!1},templateUrl:"/app/modals/templates/templates.html",size:"modal-md"},function(scope){scope.templateData={},scope.ttsData.language=scope.ttsEngineIndicated,scope.openTemplateAudioSelect=function(){$timeout(function(){angular.element("#campaignBatchFileInput").trigger("click")},100)},scope.createTemplate=function(){},scope.getPlaybackCount=function(count){return $rootScope.playbackCount==count},scope.changePlaybackCount=function(count){$rootScope.playbackCount=count},scope.showInteractionModal=function(checked){console.log(checked),checked?CallBournModal.open({scope:{chosedInteractions:$scope.chosedInteractions,hasInArray:$scope.hasInArray},templateUrl:"/app/modals/camping-batch/activate-replay-template.html",size:"modal-md"},function(scope){scope.isInactive=function(item,index){switch(index){case 0:if($rootScope.interData.callbackDigit.digit==item||$rootScope.interData.transferDigit.digit==item||$rootScope.interData.blacklistDigit.digit==item)return!0}},scope.selectInteraction=function(interaction){$scope.chosedInteractions[0]=interaction,$rootScope.interData.replayDigit.digit=interaction},scope.cancelModal=function(){scope.chosedInteractions[0]=null,$rootScope.interData.replayDigit.digit=null,$rootScope.interData.replayDigit.onOff=!1,angular.element("call-modal")[angular.element("call-modal").length-1].remove()},scope.digitError=!1,scope.checkboxError=!1,scope.finishModal=function(checked){checked&&($rootScope.interData.replayDigit.checkboxChecked=!0),$scope.chosedInteractions[0]||0===$scope.chosedInteractions[0]?$rootScope.interData.replayDigit.checkboxChecked?($rootScope.showBlurEffect=!1,$rootScope.interData.replayDigit.digit=$scope.chosedInteractions[0],angular.element("call-modal")[angular.element("call-modal").length-1].remove()):scope.checkboxError=!0:scope.digitError=!0}}):($scope.chosedInteractions[0]=null,$rootScope.interData.replayDigit={checkboxChecked:!1,digit:null,onOff:!1})},scope.showTransferModal=function(checked){checked?($rootScope.interData.transferDigit.onOff=!1,$rootScope.interData.transferDigit.checkboxChecked=!1,CallBournModal.open({scope:{currentUser:$rootScope.currentUser,transferStep:1,chosedInteractions:$scope.chosedInteractions,hasInArray:$scope.hasInArray},templateUrl:"/app/modals/camping-batch/activate-transfer-template.html",size:"modal-md"},function(scope){scope.transferLimitValue="",scope.checkRadioForManuallyNumber=function(number){$rootScope.interData.transferDigit.live_transfer_limit=number},scope.checkRadioForTransferLimit=function(){$rootScope.interData.transferDigit.live_transfer_limit=""},scope.transferLimit={1:{key:$rootScope.trans("transfer_unlimited2"),value:""},2:{key:1,value:1},3:{key:2,value:2},4:{key:3,value:3},5:{key:4,value:4},6:{key:5,value:5},7:{key:6,value:6},8:{key:7,value:7},9:{key:8,value:8},10:{key:9,value:9},11:{key:10,value:10}},scope.isInactive=function(item,index){switch(index){case 1:if($rootScope.interData.callbackDigit.digit==item||$rootScope.interData.replayDigit.digit==item||$rootScope.interData.blacklistDigit.digit==item)return!0}},scope.selectInteraction=function(interaction){$rootScope.interData.transferDigit.onOff=!0,$rootScope.interData.transferDigit.digit=interaction,scope.chosedInteractions[1]=interaction},$rootScope.currentUser.numbers&&$rootScope.currentUser.numbers[0].phone_number&&($scope.liveTransferDemo=[],$scope.liveTransferDemo.push({number:$rootScope.currentUser.numbers[0].phone_number,countryId:$rootScope.currentUser.numbers[0].tariff.country_id}),$rootScope.liveTransferNumbers.push($rootScope.currentUser.numbers[0].phone_number)),scope.addRemoveTransfer=function(number,countryId){var index=$scope.liveTransferDemo.map(function(e){return e.number}).indexOf(number);index>-1?($rootScope.liveTransferNumbers.splice(index,1),$scope.liveTransferDemo.splice(index,1)):scope.liveTransferNumbers.length?$scope.liveTransferDemo.forEach(function(item){item.countryId===countryId?($scope.liveTransferDemo.push({number:number,countryId:countryId}),scope.liveTransferNumbers.push(number)):growl.error($rootScope.trans("country_id_dont_match"))}):($scope.liveTransferDemo.push({number:number,countryId:countryId}),scope.liveTransferNumbers.push(number))},scope.chnageTransferStep=function(step){scope.transferStep=step},scope.cancelModal=function(){$rootScope.interData.transferDigit.checkboxChecked=!1,$rootScope.interData.transferDigit.onOff=!1,$rootScope.interData.transferDigit.digit=null,$scope.chosedInteractions[1]=null,angular.element("call-modal")[angular.element("call-modal").length-1].remove()},scope.digitError=!1,scope.checkboxError=!1,scope.liveNumberErr=!1,scope.finishModal=function(checked){checked&&$rootScope.interData.replayDigit.checkboxChecked,$scope.chosedInteractions[1]||0===$scope.chosedInteractions[1]?$rootScope.interData.transferDigit.checkboxChecked?$rootScope.liveTransferNumbers.length?($rootScope.showBlurEffect=!1,$rootScope.transfer_options=$rootScope.liveTransferNumbers.join(),angular.element("call-modal")[angular.element("call-modal").length-1].remove()):scope.liveNumberErr=!0:scope.checkboxError=!0:scope.digitError=!0}})):$scope.chosedInteractions[1]=null},scope.showCallbackModal=function(checked){checked?($rootScope.interData.callbackDigit.onOff=!1,$rootScope.interData.callbackDigit.checkboxChecked=!1,CallBournModal.open({scope:{availableTts:$scope.availableTts,ttsEngineIndicated:$scope.ttsEngineIndicated,callbackTtsData:{},uploadingCallbackAudioName:"",tempAudioTemplateModel:{},callbackAudioFiles:[],playPauseRecordedAudio:$scope.playPauseRecordedAudio,getAudioSource:$scope.getAudioSource,activationCheckboxStep:!1,callbackStep:1,checkedAll:!1,tabIsOpen:[!1,!1,!1],uploadedAudioFile:{},isPlayed:!1,isTtsUploaded:!1,chosedInteractions:$scope.chosedInteractions,hasInArray:$scope.hasInArray,seletedTemplateId:null},templateUrl:"/app/modals/camping-batch/activate-callback-template.html",size:"modal-md"},function(scope){Restangular.one("audio-files/audio-templates").get({saved_from:"CALL_ME_BACK"}).then(function(data){scope.callbackTemplates=data.resource}),scope.selectInteraction=function(interaction){$rootScope.interData.callbackDigit.onOff=!0,$rootScope.interData.callbackDigit.digit=interaction,$scope.chosedInteractions[2]=interaction},scope.callbackTtsData.language=scope.ttsEngineIndicated,scope.changeCallbackStep=function(step){scope.callbackStep=step},scope.isInactive=function(item,index){switch(index){case 2:if($rootScope.interData.replayDigit.digit==item||$rootScope.interData.transferDigit.digit==item||$rootScope.interData.blacklistDigit.digit==item)return!0}},scope.openTab=function(index){angular.element(".openTabs").collapse("hide"),angular.element("#collapseMethod"+index).collapse("show"),scope.tabIsOpen[index-1]=!scope.tabIsOpen[index-1]},scope.openBatchFileSelect=function(){$timeout(function(){angular.element("#campaignBatchFileInput").trigger("click")},100)},scope.checkAll=function(){return!$rootScope.interData.callbackDigit.checkboxChecked},scope.callbackAudioTemplateSelected=function(file){scope.callbackTtsData.text=file.tts_text,scope.seletedTemplateId=file._id,$rootScope.interData.callbackDigit.voiceFileId=file._id,scope.selectedCallbackAudioTemplateFile=file,scope.tempNewCreatedModel=file,scope.activationCheckboxStep=!0},scope.slsectAudio=function(template){$rootScope.interData.callbackDigit.voiceFile=template,$rootScope.interData.callbackDigit.voiceFileId=template._id},scope.playPauseCallbackTemplateAudio=function(action){if(scope.selectedCallbackAudioTemplateFile._id){var audio=document.getElementById("callbackAudioFileTemplate");"play"==action?(audio.play(),scope.isCallbackTemplateFilePlaying=!0,audio.addEventListener("ended",function(){scope.isCallbackTemplateFilePlaying=!1},!1)):(audio.pause(),scope.isCallbackTemplateFilePlaying=!1)}},scope.playPauseCallbackNewCreatedAudio=function(action){if(scope.newCallbackSelectedAudioFile._id){var audio=(scope.newCallbackSelectedAudioFile._id,document.getElementById("callbackCreatedAudioFile"));"play"==action?(audio.play(),scope.isCallbackNewCreatedFilePlaying=!0,audio.addEventListener("ended",function(){scope.isCallbackNewCreatedFilePlaying=!1},!1)):(audio.pause(),scope.isCallbackNewCreatedFilePlaying=!1)}},scope.saveTemplateAsCallback=function(){scope.callbackAudioFiles.push({file:scope.selectedCallbackAudioTemplateFile,name:scope.selectedCallbackAudioTemplateFile.map_filename+" - "+scope.selectedCallbackAudioTemplateFile.length})},scope.isCallbackAlreadyAdded=function(){if(!scope.selectedCallbackAudioTemplateFile)return!1;for(index in scope.callbackAudioFiles)return scope.callbackAudioFiles[index].file._id==scope.selectedCallbackAudioTemplateFile._id},scope.callbackDigitFileUpload=new $rootScope.fileUploader({url:"/campaigns/upload-audio-file",alias:"file",headers:{JWTAuthorization:"Bearer "+localStorage.getItem("jwtToken"),savedFrom:"CALL_ME_BACK"},autoUpload:!0}),scope.callbackDigitFileUpload.onAfterAddingFile=function(item){$rootScope.startModalLoader(),scope.uploadingAudioName=item.file.name},scope.callbackDigitFileUpload.onSuccessItem=function(item,response,status,headers){if($rootScope.stopModalLoader(),0==response.resource.error.no){scope.uploadingCallbackAudioName=!1;var file=response.resource.file,audioData={source:$sce.trustAsResourceUrl(file.amazon_s3_url),file:file,name:file.orig_filename+" - "+file.length};scope.callbackAudioFiles.push(audioData),scope.uploadedAudioFile=response.resource.file,scope.seletedTemplateId=response.resource.file._id,scope.isUploaded=!0,scope.callbackAudioTemplateSelected(response.resource.file),growl.success($rootScope.trans(response.resource.error.message))}else growl.error($rootScope.trans(response.resource.error.text))},scope.callbackDigitFileUpload.onErrorItem=function(item,response,status,headers){$scope.errors=response,$rootScope.stopModalLoader()},scope.startCallbackUpload=function(){$scope.callbackDigitFileUpload.uploadAll()},scope.openCallbackFileSelect=function(){$timeout(function(){angular.element("#campaignCallbackFileInput").trigger("click")},100)},scope.getTTSUrl=function(){return $sce.trustAsResourceUrl("/assets/callburn/tts/"+scope.callbackTtsData.language+".wav")},scope.playCallbackTTSDemo=function(){var audio=document.getElementById("ttsCallbackDemoAudio");$scope.isRecordedFilePlaying?(audio.pause(),audio.currentTime=0,angular.element("#audioFilePlay").addClass("fa-play-circle"),angular.element("#audioFilePlay").removeClass("fa-stop-circle")):(audio.play(),angular.element("#audioFilePlay").removeClass("fa-stop-circle"),angular.element("#audioFilePlay").addClass("fa-stop-circle"),audio.addEventListener("ended",function(){$scope.isRecordedFilePlaying=!1,angular.element("#audioFilePlay").removeClass("fa-stop-circle"),angular.element("#audioFilePlay").addClass("fa-play-circle")},!1)),$scope.isRecordedFilePlaying=!$scope.isRecordedFilePlaying},scope.createAudioFromTextForCallback=function(){$rootScope.startModalLoader(),scope.callbackTtsData.saved_from="CALL_ME_BACK",Restangular.all("campaigns/create-audio-from-text").post(scope.callbackTtsData).then(function(data){if($rootScope.stopModalLoader(),0==data.resource.error.no){var file=data.resource.file,audioData={source:$sce.trustAsResourceUrl(file.amazon_s3_url),file:file,name:file.orig_filename+" - "+file.length};scope.callbackAudioFiles.push(audioData),scope.ttsUploadedAudioFile=file,$rootScope.interData.callbackDigit.voicefileId=file._id,scope.tempNewCreatedModel=file,scope.seletedTemplateId=file._id,scope.isTtsUploaded=!0,scope.activationCheckboxStep=!0}else growl.error($rootScope.trans(data.resource.error.text))})},scope.cancelModal=function(){$rootScope.interData.callbackDigit.checkboxChecked=!1,$rootScope.interData.callbackDigit.digit=null,$rootScope.interData.callbackDigit.onOff=!1,$scope.chosedInteractions[2]=null,angular.element("call-modal")[angular.element("call-modal").length-1].remove()},scope.finishModal=function(checked){checked&&($rootScope.interData.callbackDigit.checkboxChecked=!0),scope.digitError=!1,scope.checkboxError=!1,scope.tempError=!1,$scope.chosedInteractions[2]||0===$scope.chosedInteractions[2]?$rootScope.interData.callbackDigit.checkboxChecked?scope.tempNewCreatedModel?($rootScope.showBlurEffect=!1,angular.element("call-modal")[angular.element("call-modal").length-1].remove()):scope.tempError=!0:scope.checkboxError=!0:scope.digitError=!0}})):$scope.chosedInteractions[2]=null},scope.showDoNotCallModal=function(checked){checked?($rootScope.interData.blacklistDigit.onOff=!1,$rootScope.interData.blacklistDigit.checkboxChecked=!1,CallBournModal.open({scope:{ttsEngineIndicated:$scope.ttsEngineIndicated,doNotCallTtsData:{},uploadingDoNotCallAudioName:"",tempAudioTemplateModel:{},doNotCallAudioFiles:[],doNotCallStep:1,playPauseRecordedAudio:$scope.playPauseRecordedAudio,getAudioSource:$scope.getAudioSource,checkedAll:!1,activationCheckboxStep:!1,availableTts:$scope.availableTts,audioTemplates:$scope.audioTemplates,seletedTemplateId:null,tabIsOpen:[!1,!1,!1],chosedInteractions:$scope.chosedInteractions,hasInArray:$scope.hasInArray},templateUrl:"/app/modals/camping-batch/activate-do-not-call-template.html",size:"modal-md",isUploaded:!1,isTtsUploaded:!1},function(scope){Restangular.one("audio-files/audio-templates").get({saved_from:"BLACKLIST"}).then(function(data){scope.blacklistTemplates=data.resource}),scope.isInactive=function(item,index){switch(index){case 3:if($rootScope.interData.replayDigit.digit==item||$rootScope.interData.transferDigit.digit==item||$rootScope.interData.callbackDigit.digit==item)return!0}},scope.selectInteraction=function(interaction){$rootScope.interData.blacklistDigit.onOff=!0,$rootScope.interData.blacklistDigit.digit=interaction,$scope.chosedInteractions[3]=interaction},scope.doNotCallTtsData.language=scope.ttsEngineIndicated,scope.openTab=function(index){angular.element(".openTabs").collapse("hide"),angular.element("#collapseMethod"+index).collapse("show"),scope.tabIsOpen[index-1]=!scope.tabIsOpen[index-1]},scope.changeDoNotCallStep=function(step){scope.doNotCallStep=step},scope.openBatchFileSelect=function(){$timeout(function(){angular.element("#campaignBatchFileInput").trigger("click")},100)},scope.checkAll=function(){return!$rootScope.interData.blacklistDigit.checkboxChecked},scope.doNotCallAudioTemplateSelected=function(file){scope.doNotCallTtsData.text=file.tts_text,scope.seletedTemplateId=file._id,scope.selectedDoNotCallAudioTemplateFile=file,scope.tempNewCreatedModel=file,$rootScope.interData.blacklistDigit.voiceFileId=file._id,scope.activationCheckboxStep=!0},scope.selectDoNotCallNewCreatedAudioFile=function(file){scope.newDoNotCallSelectedAudioFile=file.file,$rootScope.interData.blacklistDigit.voiceFileId=file.file._id},scope.playPauseDoNotCallTemplateAudio=function(action){if(scope.selectedDoNotCallAudioTemplateFile._id){var audio=document.getElementById("doNotCallAudioFileTemplate");"play"==action?(audio.play(),scope.isDoNotCallTemplateFilePlaying=!0,audio.addEventListener("ended",function(){scope.isDoNotCallTemplateFilePlaying=!1},!1)):(audio.pause(),scope.isDoNotCallTemplateFilePlaying=!1)}},scope.playPauseDoNotCallNewCreatedAudio=function(action){if(scope.newDoNotCallSelectedAudioFile._id){var audio=(scope.newDoNotCallSelectedAudioFile._id,document.getElementById("doNotCallCreatedAudioFile"));"play"==action?(audio.play(),scope.isDoNotCallNewCreatedFilePlaying=!0,audio.addEventListener("ended",function(){scope.isDoNotCallNewCreatedFilePlaying=!1},!1)):(audio.pause(),scope.isDoNotCallNewCreatedFilePlaying=!1)}},scope.saveTemplateAsDoNotCall=function(){scope.doNotCallAudioFiles.push({file:scope.selectedDoNotCallAudioTemplateFile,name:scope.selectedDoNotCallAudioTemplateFile.map_filename+" - "+scope.selectedDoNotCallAudioTemplateFile.length})},scope.isDoNotCallAlreadyAdded=function(){if(!scope.selectedDoNotCallAudioTemplateFile)return!1;for(index in scope.doNotCallAudioFiles)return scope.doNotCallAudioFiles[index].file._id==scope.selectedDoNotCallAudioTemplateFile._id},scope.blacklistDigitFileUpload=new $rootScope.fileUploader({url:"/campaigns/upload-audio-file",alias:"file",headers:{JWTAuthorization:"Bearer "+localStorage.getItem("jwtToken"),savedFrom:"BLACKLIST"},autoUpload:!0}),scope.blacklistDigitFileUpload.onAfterAddingFile=function(item){$rootScope.startModalLoader(),scope.uploadingAudioName=item.file.name},scope.blacklistDigitFileUpload.onSuccessItem=function(item,response,status,headers){if($rootScope.stopModalLoader(),0==response.resource.error.no){scope.uploadingDoNotCallAudioName=!1;var file=response.resource.file,audioData={source:$sce.trustAsResourceUrl(file.amazon_s3_url),file:file,name:file.orig_filename+" - "+file.length};scope.doNotCallAudioFiles.push(audioData),scope.isUploaded=!0,scope.uploadedAudioFile=file,scope.doNotCallAudioTemplateSelected(file),scope.seletedTemplateId=file._id,scope.tempNewCreatedModel=file,scope.activationCheckboxStep=!0,growl.success($rootScope.trans(response.resource.error.message))}else growl.error($rootScope.trans(response.resource.error.text))},scope.blacklistDigitFileUpload.onErrorItem=function(item,response,status,headers){$scope.errors=response,$rootScope.stopModalLoader()},scope.startDoNotCallUpload=function(){$scope.blacklistDigitFileUpload.uploadAll()},scope.openDoNotCallFileSelect=function(){$timeout(function(){angular.element("#campaignDoNotCallFileInput").trigger("click")},100)},scope.getTTSUrl=function(){return $sce.trustAsResourceUrl("/assets/callburn/tts/"+scope.doNotCallTtsData.language+".wav")},scope.playDoNotCallTTSDemo=function(){var audio=document.getElementById("ttsDoNotCallDemoAudio");$scope.isRecordedFilePlaying?(audio.pause(),audio.currentTime=0,angular.element("#audioFilePlay").addClass("fa-play-circle"),angular.element("#audioFilePlay").removeClass("fa-stop-circle")):(audio.play(),angular.element("#audioFilePlay").removeClass("fa-stop-circle"),angular.element("#audioFilePlay").addClass("fa-stop-circle"),audio.addEventListener("ended",function(){$scope.isRecordedFilePlaying=!1,angular.element("#audioFilePlay").removeClass("fa-stop-circle"),angular.element("#audioFilePlay").addClass("fa-play-circle")},!1)),$scope.isRecordedFilePlaying=!$scope.isRecordedFilePlaying},scope.createAudioFromTextForDoNotCall=function(){$rootScope.startModalLoader(),scope.doNotCallTtsData.saved_from="BLACKLIST",CampingService.createAudioFromText(scope.doNotCallTtsData).then(function(data){if($rootScope.stopModalLoader(),0==data.resource.error.no){file=data.resource.file;var audioData={source:$sce.trustAsResourceUrl(file.amazon_s3_url),file:file,name:file.orig_filename+" - "+file.length};scope.ttsUploadedAudioFile=file,scope.seletedTemplateId=file._id,scope.doNotCallAudioTemplateSelected(file),scope.doNotCallAudioFiles.push(audioData),scope.isTtsUploaded=!0,scope.tempNewCreatedModel=file,scope.activationCheckboxStep=!0}})},scope.cancelModal=function(){$rootScope.interData.blacklistDigit.onOff=!1,$scope.chosedInteractions[3]=null,$rootScope.interData.blacklistDigit.digit=null,angular.element("call-modal")[angular.element("call-modal").length-1].remove()},scope.finishModal=function(checked){checked&&($rootScope.interData.blacklistDigit.checkboxChecked=!0),scope.digitError=!1,scope.checkboxError=!1,scope.tempError=!1,$scope.chosedInteractions[3]||0===$scope.chosedInteractions[3]?$rootScope.interData.blacklistDigit.checkboxChecked?scope.tempNewCreatedModel?($rootScope.showBlurEffect=!1,angular.element("call-modal")[angular.element("call-modal").length-1].remove()):scope.tempError=!0:scope.checkboxError=!0:scope.digitError=!0}})):($scope.chosedInteractions[3]=null,$rootScope.interData.blacklistDigit={checkboxChecked:!1,digit:null,onOff:!1})},scope.callbackDigitFileUpload=new $rootScope.fileUploader({url:"/campaigns/upload-audio-file",headers:{JWTAuthorization:"Bearer "+localStorage.getItem("jwtToken")},alias:"file",autoUpload:!0,formData:[scope.audioData]}),scope.callbackDigitFileUpload.onAfterAddingFile=function(item){$rootScope.disableButton(),$rootScope.startModalLoader(),scope.uploadingAudioName=item.file.name},scope.callbackDigitFileUpload.onSuccessItem=function(item,response,status,headers){$rootScope.enabledButton(),$rootScope.stopModalLoader(),0==response.resource.error.no?(scope.uploadingCallbackAudioName=!1,TemplateService.getAudioTemplates({}).then(function(data){updateTemplates(data),CallBournModal.close(),$scope.filterTemplate()}),growl.success($rootScope.trans(response.resource.error.message)),CallBournModal.close):(growl.error($rootScope.trans(response.resource.error.text)),CallBournModal.close())},scope.callbackDigitFileUpload.onErrorItem=function(item,response,status,headers){$scope.errors=response,$rootScope.stopLoader(),$rootScope.enabledButton(),$rootScope.stopModalLoader(),CallBournModal.close()},scope.startCallbackUpload=function(){$scope.callbackDigitFileUpload.uploadAll()},scope.saveTypes={1:{value:"TEMPLATES",text:"Templates"},2:{value:"CALL_MESSAGE",text:$rootScope.trans("dashboard_welcome_voice_messages")},3:{value:"CALL_ME_BACK",text:$rootScope.trans("campaign_statistics_callback")},4:{value:"BLACKLIST",text:$rootScope.trans("campaign_statistics_blacklist")},5:{value:"SMS",text:"SMS"}},scope.ttsData.saved_from="TEMPLATE",scope.createAudioFromTextForVoice=function(){scope.ttsData.interactionInfo={replay:{digit:$rootScope.interData.replayDigit.digit},transfer:{number:$rootScope.liveTransferNumbers,limit:$rootScope.interData.transferDigit.live_transfer_limit,digit:$rootScope.interData.transferDigit.digit},callback:{digit:$rootScope.interData.callbackDigit.digit,voiceFileId:$rootScope.interData.callbackDigit.voiceFileId},blacklist:{digit:$rootScope.interData.blacklistDigit.digit,voiceFileId:$rootScope.interData.blacklistDigit.voiceFileId}},delete scope.ttsData.replayDigit,delete scope.ttsData.transferDigit,delete scope.ttsData.callbackDigit,delete scope.ttsData.blacklistDigit,scope.ttsData.playbackNumber=$rootScope.playbackCount,scope.textErr=!1,scope.ttsData.text&&scope.ttsData.text.length?($rootScope.disableButton(),$rootScope.startModalLoader(),Restangular.all("campaigns/create-audio-from-text").post(scope.ttsData).then(function(data){$rootScope.stopModalLoader(),$rootScope.enabledButton(),0==data.resource.error.no?(growl.success(trans(data.resource.error.message)),TemplateService.getAudioTemplates({}).then(function(data){updateTemplates(data),CallBournModal.close(),$scope.filterData.saved_from=null,$scope.filterTemplate()})):"-1"==data.resource.error.no?growl.error(trans("endpoint_connecting_failed")):growl.error(trans(data.resource.error.text))}),$scope.multiSelectEvents.onSelectionChanged()):scope.textErr=!0},scope.getTTSUrl=function(){return $sce.trustAsResourceUrl("/assets/callburn/tts/"+scope.ttsData.language+".wav")},scope.playTTSDemo=function(){var audio=document.getElementById("ttsDemoAudio");$scope.isRecordedFilePlaying?(audio.pause(),angular.element("#audioFilePlay").addClass("fa-play-circle"),angular.element("#audioFilePlay").removeClass("fa-stop-circle")):(audio.play(),audio.currentTime=0,angular.element("#audioFilePlay").removeClass("fa-stop-circle"),angular.element("#audioFilePlay").addClass("fa-stop-circle"),audio.addEventListener("ended",function(){$scope.isRecordedFilePlaying=!1,angular.element("#audioFilePlay").removeClass("fa-stop-circle"),angular.element("#audioFilePlay").addClass("fa-play-circle")},!1)),$scope.isRecordedFilePlaying=!$scope.isRecordedFilePlaying},scope.selectedTemplateType=!1,scope.selectTemplateType=function(type){scope.selectedTemplateType=type},scope.calcSmsText=function(){var txt=scope.templateData.sms_text.length,num=0;return txt>=0&&txt<=160?(num=1," - "+num+" SMS"):txt>=161&&txt<=320?(num=2," - "+num+" SMS"):txt>=321&&txt<=480?(num=3," - "+num+" SMS"):txt>=481&&txt<=640?(num=4," - "+num+" SMS"):txt>=641&&txt<=800?(num=5," - "+num+" SMS"):txt>=801&&txt<=960?(num=6," - "+num+" SMS"):void 0},scope.createSmsTemplate=function(){scope.smsError=!1;var data={sms_text:scope.templateData.sms_text,saved_from:"TEMPLATE",interactionInfo:$rootScope.interData,playbackCount:$rootScope.playbackCount};data.sms_text&&data.sms_text.length?Restangular.all("audio-files/make-sms-template").post(data).then(function(data){TemplateService.getAudioTemplates({}).then(function(data){updateTemplates(data),CallBournModal.close(),$scope.filterData.saved_from=null,$scope.filterTemplate()})}):scope.smsError=!0}})},$scope.multiselectOptionsTemplatesDataCallback=function(){var q=$q.defer();return $scope.multiselectOptionsTemplateOverviewData?q.resolve($scope.multiselectOptionsTemplateOverviewData):($interval(function(){if($scope.multiselectOptionsTemplateOverviewData)return q.resolve($scope.multiselectOptionsTemplateOverviewData)},500),q.promise)},$scope.multiselectOptionsTemplatesDataCallback().then(function(data){$scope.checkedOptionsModel=[$scope.multiselectOptionsTemplateOverviewData[0],$scope.multiselectOptionsTemplateOverviewData[1],$scope.multiselectOptionsTemplateOverviewData[2]],
$scope.multiSelectEvents.onSelectionChanged()}),$scope.multiselectTemplateSettings={template:"{{option.label}}",buttonClasses:""},$scope.firstLoadForStatuses=!0,$scope.multiSelectEvents={onSelectionChanged:function(){$scope.checkedOptions=[],$scope.checkedOptionsModel.forEach(function(option){$scope.checkedOptions.push(option.id)}),$scope.filterData.checkbox=JSON.stringify($scope.checkedOptions),$scope.firstLoadForStatuses||$scope.filterTemplate($scope.filterData),$scope.firstLoadForStatuses=!1}},$scope.showSearch=!1,$scope.TempEnterPress=function(key){13===key.which?$scope.filterTemplate():null},$scope.toggleSearch=function(){$scope.showSearch&&$rootScope.importantShowSearch?$scope.filterTemplate():$scope.showSearch=!0},$scope.selectedFilter=null,$scope.filterTemplates=function(type){$scope.selectedFilter==type?($scope.selectedFilter=null,$scope.filterData.saved_from=null,$scope.filterTemplate()):($scope.selectedFilter=type,$scope.filterData.saved_from=type,$scope.filterTemplate())}}]);