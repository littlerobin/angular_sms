angular.module("callburnApp").controller("MainController",["$scope","$rootScope","$state","Restangular","$stateParams","$sce","$http","$timeout","$interval","LanguageControl","CallBournModal","$q","filterFilter","$filter",function($scope,$rootScope,$state,Restangular,$stateParams,$sce,$http,$timeout,$interval,LanguageControl,CallBournModal,$q,filterFilter,$filter){function getUserData(){Restangular.one("users/show-user").get().then(function(data){if(data.resource.user_data){if($rootScope.currentUser=data.resource.user_data,parseInt($rootScope.currentUser.can_access_beta)?$rootScope.checkAccessBeta=!0:$rootScope.checkAccessBeta=!1,$rootScope.currentUser.birthday){var birthday=$filter("localDate")(moment($rootScope.currentUser.birthday,"YYYY-MM-DD h:mm:ss "));$rootScope.currentUser.birthday=$filter("limitTo")(birthday,10)}var userNotifications=("user_id="+data.resource.user_data._id+"&api_key="+data.resource.api_token,data.resource.user_data.notifications);$scope.notifications=[],$scope.notSeenNotificationsCount=0;for(index in userNotifications)$scope.notifications.push(userNotifications[index]),$scope.notSeenNotificationsCount++;if(!data.resource.user_data.numbers||0==data.resource.user_data.numbers.length){var callerIdNotification={created_at:null,text:$rootScope.trans("caller__id _is__missing_1"),route:"account.settings",params:!1,is_seen:!1,can_remove:!1};$scope.notifications.unshift(callerIdNotification),$scope.notSeenNotificationsCount++}if(data.resource.user_data.show_validate_now_your_phonenumber){var callerIdNotification={created_at:null,text:trans("validate_now_your_phonenumber_and_receive_a_welcome_credit"),route:"account.settings",params:!1,is_seen:!1,can_remove:!1};$scope.notifications.unshift(callerIdNotification),$scope.notSeenNotificationsCount++}if(data.resource.user_data.balance<5&&data.resource.user_data.invoice_transaction_count>0){var lowBalanceNotification={created_at:null,text:$rootScope.trans("your__balance__is_low"),route:"account.financials",params:!1,is_seen:!1,can_remove:!1};$scope.notifications.unshift(lowBalanceNotification),$scope.notSeenNotificationsCount++}$rootScope.currentUser.api_token=data.resource.api_token;var usersLanguage=data.resource.user_data.language?data.resource.user_data.language.full_name:"";nudgespot.identify(data.resource.user_data.email,{language:usersLanguage,balance:data.resource.user_data.balance}),data.resource.user_data.language&&($rootScope.currentLanguage=data.resource.user_data.language.code,$rootScope.currentLanguageName=data.resource.user_data.language.name,$http.get("/assets/translations/back_translate_"+data.resource.user_data.language.code+".json").success(function(data){$rootScope.translate[$rootScope.currentUser.language.code]=data})),data.resource.user_data.numbers&&0!=data.resource.user_data.numbers.length||($rootScope.currentUser.numbers=[])}$scope.removeDuplicates=function(arr){var uniqueArray=[],lookup={};for(var i in arr)"tickets"==arr[i].route?lookup[arr[i].text]=arr[i]:uniqueArray.push(arr[i]);for(i in lookup)uniqueArray.push(lookup[i]);return uniqueArray},$scope.rootNotifications=$scope.notifications,$scope.notifications=$scope.removeDuplicates($scope.notifications),$scope.scrollBar=$scope.notifications.length>4?"notificationScrollStyle":"",$scope.valueCount=function(value){return filterFilter($scope.rootNotifications,{text:value}).length}})}$rootScope.currentActiveUrl=$state.current.name,$rootScope.showNavbar=!0,$rootScope.apiUrl=window.apiUrl,$scope.scrollBar="",$rootScope.currentActiveRoute=null,$rootScope.currentTime="",$rootScope.dashboardData={},$rootScope.currentUser={numbers:[""]},$rootScope.otherFooterData={},$rootScope.languages={},$rootScope.showBlurEffect=!1,$rootScope.requestShowLoading=!1,$rootScope.disabledButton=!1,$rootScope.waitLightBox=!1,$rootScope.rootConfigs={},$rootScope.rootConfigs.appUrl=window.appUrl,$rootScope.rootConfigs.baseUrl=window.baseUrl,$scope.notifications=[],$scope.notSeenNotificationsCount=0,$rootScope.isFooter1Active=!1,$rootScope.isFooter2Active=!1,$rootScope.isFooter3Active=!1,$rootScope.translate={},setInterval(function(){Restangular.one("auth/refresh-token").get().then(function(response){localStorage.setItem("jwtToken",response.resource.token),Restangular.setDefaultHeaders({JWTAuthorization:"Bearer "+localStorage.getItem("jwtToken")})})},36e5),window.showWaitLightBox=$rootScope.showWaitLightBox=function(){$rootScope.waitLightBox=!0},window.hideWaitLightBox=$rootScope.hideWaitLightBox=function(){$rootScope.waitLightBox=!1},LanguageControl.GetLanguagesList().then(function(data){$rootScope.flags=[],$rootScope.languages=data.resource.languages,$rootScope.languages.forEach(function(language){$rootScope.flags.push("/assets/callburn/images/lang-flags/"+language.code+".svg")})});var CurrentLanguageData=LanguageControl.GetLanguage("CurrentUserLanguageCode",$rootScope.languages);$rootScope.currentLanguage=CurrentLanguageData.code,$rootScope.currentLanguageName=CurrentLanguageData.name,$scope.goToSettingsPage=function(){$state.go("account.settings",{openDropdown:!0})},angular.element(".displayNoneBody").removeClass("displayNoneBody"),$scope.showHideSubmenuIconsGroups=!1,$scope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){$rootScope.showLoading=!0,$rootScope.showBlurEffect=!0,$rootScope.showPreviousIcon=!1,$rootScope.showNextIcon=!1,$rootScope.isFooter1Active=!1,$rootScope.isFooter2Active=!1,$rootScope.isFooter3Active=!1}),$stateParams.status?($scope.phonenumberMenuItem={status:$stateParams.status},$scope.campaignMenuItem={status:$stateParams.status}):($scope.phonenumberMenuItem={status:"addressbook.contacts"},$scope.campaignMenuItem={status:"campaign.overview"}),$scope.activePhonenumberMenu=function(status){$scope.phonenumberMenuItem.status=status||$scope.phonenumberMenuItem.status},$scope.activeCampaignMenu=function(status){$scope.campaignMenuItem.status=status||$scope.campaignMenuItem.status},$rootScope.startLoader=function(){$rootScope.showLoading=!0,$rootScope.showBlurEffect=!0},$rootScope.stopLoader=function(){$rootScope.showLoading=!1,$rootScope.showBlurEffect=!1},$rootScope.disableButton=function(){$rootScope.disabledButton=!0},$rootScope.enabledButton=function(){$rootScope.disabledButton=!1},$rootScope.stopModalLoader=function(){$rootScope.showModalLoading=!1},$rootScope.startModalLoader=function(){$rootScope.showModalLoading=!0},$scope.showNotifications=!1,$scope.showHideNotifications=function(){$scope.showNotifications=!$scope.showNotifications},$scope.topAccountShow=!1,$scope.topAccountShowHide=function(){$scope.topAccountShow=!$scope.topAccountShow,$scope.quickActionShow=!1},$scope.quickActionShow=!1,$scope.quickActionShowHide=function(){$scope.quickActionShow=!$scope.quickActionShow,$scope.topAccountShow=!1},$scope.closeWindow=function(){$scope.quickActionShow=!1,$scope.topAccountShow=!1},$rootScope.showFileLoader=function(){$scope.fileLoader=!0},$rootScope.hideFileLoader=function(){$scope.fileLoader=!1},$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){$rootScope.showLoading=!1,$rootScope.showBlurEffect=!1}),$scope.$on("$stateChangeError",function(event,toState,toParams,fromState,fromParams,error){$rootScope.showLoading=!1,$rootScope.showBlurEffect=!1});var updateTime=function(){Restangular.one("users/users-time").get().then(function(timeData){$rootScope.currentTime=timeData.resource.time,$rootScope.currentFullTime=timeData.resource.time})};updateTime();$interval(updateTime,4e4);$rootScope.make_trusted=function(text){return $sce.trustAsHtml(text)},$rootScope.openChatWindow=function(){$timeout(function(){angular.element(".nudgespot-launcher").trigger("click")},100)},$rootScope.goToNotification=function(notification){notification.params?$state.go(notification.route,JSON.parse(notification.params)):$state.go(notification.route)},$rootScope.removeNotification=function(notification){Restangular.all("notifications/remove-notification").post({notification_id:notification._id}).then(function(data){0==data.resource.error.no&&getUserData()})},$scope.notificationsToggled=function(open){open&&Restangular.all("notifications/mark-as-seen").post().then(function(data){})},getUserData(),$interval(getUserData,15e3),$scope.showLanguageSelect=!1,$scope.hideLanguage=function(){$scope.showLanguageSelect=!1},$scope.showHideLanguageBar=function(){$scope.showLanguageSelect=!$scope.showLanguageSelect};var langRequestInProcess=!1;window.trans=$rootScope.trans=function(str){var lang=$rootScope.currentLanguage;if($rootScope.translate[lang]){if("db"==lang)return str;var englishTranslation=$rootScope.translate.en[str]?$rootScope.translate.en[str]:str;return $rootScope.translate[lang][str]?$rootScope.translate[lang][str]:englishTranslation}langRequestInProcess||(langRequestInProcess=!0,$rootScope.loadTrans(lang))},window.transQueue=$rootScope.transQueue=function(str){var queue=$q.defer();return trans(str)&&queue.resolve(),queue.promise},$rootScope.isLangLoaded=!1,$rootScope.loadTrans=function(lang){$rootScope.isLangLoaded=!1,$http.get("/assets/translations/back_translate_"+lang+".json").success(function(data){$rootScope.translate[lang]=data,langRequestInProcess=!1,$rootScope.isLangLoaded=!0})},$scope.changeLanguage=function(lang){$rootScope.languages.forEach(function(item){$rootScope.flags.push("/assets/callburn/images/lang-flags/"+item.code+".svg"),item.code==lang&&Restangular.all("users/update-main-data").post({language_id:item._id}).then(function(data){$rootScope.currentLanguage=item.code,$rootScope.currentLanguageName=item.name})}),setTimeout($rootScope.loadTrans($rootScope.currentLanguage),1e3)},$rootScope.checkIfLogged=function(response){if(response){if(response.error.no!=-10)return!0;$state.go("login")}},$rootScope.logOut=function(url){void 0===url&&(url=null),Restangular.one("auth/logout").get().then(function(data){localStorage.setItem("jwtToken",""),url?window.location.href=url:window.location.href="/"},function(response){})},$rootScope.days=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"],$rootScope.hours=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"],$rootScope.minutes=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59"],$rootScope.footerDataLoaded=!0,$rootScope.getStatusName=function(status){switch(status){case"1":return"Dialing in progress";case"2":return"live (call in progress)";case"3":return"no answer";case"4":return"busy";case"5":return"transfer";case"6":return"do not call";case"7":return"error due to channel unavailable";case"8":return"misc.";case"9":return"Machine";case"10":return"success";case"11":return"error due to congestion";case"12":return"error marked on stucked calls";default:return"Ready for be called"}},$scope.$watch("disabledButton",function(newVal){newVal===!0?angular.element(".btn").attr("disabled","disabled"):angular.element(".btn").removeAttr("disabled")}),$rootScope.clickedOnJobAlert=function(alert){"FINISHED"==alert.status&&Restangular.one("users/background-job",alert._id).remove().then(function(){$state.go("addressbook.contacts")})},$rootScope.confirmDelete=function(){var q=$q.defer();return CallBournModal.open({scope:{},templateUrl:"/app/modals/confirm/confirm-delete.html"},function(scope){window.checkDeleteConfirmation=!1,scope.deleteConfirmation=function(){q.resolve(),CallBournModal.close()}}),q.promise},window.ConfirmDeleteModal=$rootScope.confirmDelete}]);